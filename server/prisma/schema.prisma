generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  relationMode      = "prisma"
}

model CityCorporation {
  id         Int                   @id @default(autoincrement())
  code       String                @unique
  name       String
  minWard    Int
  maxWard    Int
  status     CityCorporationStatus @default(ACTIVE)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  minZone    Int                   @default(1)
  maxZone    Int                   @default(20)
  complaints Complaint[]           @relation("UserCityCorporation")
  complaintLocations Complaint[]   @relation("ComplaintCityCorporation")
  users      User[]
  zones      Zone[]

  @@index([status])
  @@index([code])
  @@map("city_corporations")
}

model Zone {
  id                  Int               @id @default(autoincrement())
  zoneNumber          Int?
  number              Int
  name                String
  cityCorporationId   Int
  officerName         String?
  officerDesignation  String?
  officerSerialNumber String?
  supervisorName      String?
  supervisorTitle     String?
  status              ZoneStatus        @default(ACTIVE)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  officerPhone        String?
  complaints          Complaint[]       @relation("UserZone")
  complaintLocations  Complaint[]       @relation("ComplaintZone")
  assignedUsers       UserZone[]
  users               User[]
  ward_inspectors     ward_inspectors[]
  wards               Ward[]
  cityCorporation     CityCorporation   @relation(fields: [cityCorporationId], references: [id], onDelete: Cascade)

  @@unique([zoneNumber, cityCorporationId])
  @@index([cityCorporationId, status])
  @@map("zones")
}

model Ward {
  id                    Int               @id @default(autoincrement())
  wardNumber            Int?
  number                Int
  zoneId                Int
  inspectorName         String?
  inspectorSerialNumber String?
  cityCorporationId     Int
  inspectorCount        Int?
  status                WardStatus        @default(ACTIVE)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  inspectorPhone        String?
  Complaint             Complaint[]       @relation("UserWard")
  complaintLocations    Complaint[]       @relation("ComplaintWard")
  users                 User[]
  ward_inspectors       ward_inspectors[]
  zone                  Zone              @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([wardNumber, cityCorporationId])
  @@index([zoneId, status])
  @@index([cityCorporationId])
  @@index([number, cityCorporationId])
  @@map("wards")
}

model User {
  id                      Int                      @id @default(autoincrement())
  email                   String?                  @unique
  phone                   String                   @unique
  passwordHash            String
  firstName               String
  lastName                String
  avatar                  String?
  role                    users_role               @default(CUSTOMER)
  status                  UserStatus               @default(PENDING)
  emailVerified           Boolean                  @default(false)
  phoneVerified           Boolean                  @default(false)
  twoFactorEnabled        Boolean                  @default(false)
  twoFactorSecret         String?
  lastLoginAt             DateTime?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  address                 String?
  verificationCode        String?
  verificationCodeExpiry  DateTime?
  cityCorporationCode     String?
  wardId                  Int?
  wardImageCount          Int                      @default(0)
  zoneId                  Int?
  designation             String?
  isOnline                Boolean                  @default(false)
  joiningDate             DateTime?
  lastActiveAt            DateTime?
  permissions             String?                  @db.LongText
  preferredLanguage       String?                  @default("bn") // "bn" for Bangla, "en" for English
  whatsapp                String?
  visiblePassword         String?
  receivedMessages        ChatMessage[]            @relation("ReceivedMessages")
  sentMessages            ChatMessage[]            @relation("SentMessages")
  assignedComplaints      Complaint[]              @relation("AssignedComplaints")
  complaints              Complaint[]
  notifications           Notification[]
  payments                Payment[]
  activityLogs            ActivityLog[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  refreshTokens           RefreshToken[]
  reviews                 Review[]
  sessions                Session[]
  user_activities         user_activities[]
  assignedByZones         UserZone[]               @relation("ZoneAssigner")
  assignedZones           UserZone[]               @relation("UserZones")
  createdNotices          Notice[]                 @relation("NoticeCreator")
  noticeInteractions      NoticeInteraction[]
  cityCorporation         CityCorporation?         @relation(fields: [cityCorporationCode], references: [code])
  ward                    Ward?                    @relation(fields: [wardId], references: [id])
  zone                    Zone?                    @relation(fields: [zoneId], references: [id])

  @@index([phone])
  @@index([email])
  @@index([status])
  @@index([role])
  @@index([createdAt])
  @@index([cityCorporationCode])
  @@index([zoneId])
  @@index([wardId])
  @@index([cityCorporationCode, wardId])
  @@index([cityCorporationCode, zoneId, wardId])
  @@index([cityCorporationCode], map: "users_cityCorporationCode_ward_idx")
  @@index([cityCorporationCode, role])
  @@index([role, status])
  @@map("users")
}

model Session {
  id         String   @id @default(uuid())
  userId     Int
  token      String   @unique
  deviceInfo String?
  ipAddress  String?
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_userId_fkey")
  @@map("sessions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    Int
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "refresh_tokens_userId_fkey")
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "password_reset_tokens_userId_fkey")
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  code      String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "email_verification_tokens_userId_fkey")
  @@index([code])
  @@map("email_verification_tokens")
}

model Complaint {
  id                           Int                    @id @default(autoincrement())
  title                        String
  description                  String                 @db.Text
  location                     String
  imageUrl                     String?                @db.Text
  audioUrl                     String?                @db.Text
  status                       Complaint_status       @default(PENDING)
  priority                     Int                    @default(1)
  userId                       Int?
  createdAt                    DateTime               @default(now())
  updatedAt                    DateTime               @updatedAt
  category                     String?
  subcategory                  String?
  wardId                       Int?
  assignedAt                   DateTime?
  resolvedAt                   DateTime?
  assignedAdminId              Int?
  cityCorporationCode          String?
  zoneId                       Int?
  feedback                     String?                @db.Text
  rating                       Int?
  resolutionImages             String?                @db.Text
  resolutionNote               String?                @db.Text
  othersCategory               String?
  othersSubcategory            String?
  complaintCityCorporationCode String?
  complaintWardId              Int?
  complaintZoneId              Int?
  assignedAdmin                User?                  @relation("AssignedComplaints", fields: [assignedAdminId], references: [id])
  cityCorporation              CityCorporation?       @relation("UserCityCorporation", fields: [cityCorporationCode], references: [code])
  user                         User?                  @relation(fields: [userId], references: [id])
  wards                        Ward?                  @relation("UserWard", fields: [wardId], references: [id])
  zone                         Zone?                  @relation("UserZone", fields: [zoneId], references: [id])
  // Complaint location relations (where complaint was submitted)
  complaintCityCorporation     CityCorporation?       @relation("ComplaintCityCorporation", fields: [complaintCityCorporationCode], references: [code])
  complaintWard                Ward?                  @relation("ComplaintWard", fields: [complaintWardId], references: [id])
  complaintZone                Zone?                  @relation("ComplaintZone", fields: [complaintZoneId], references: [id])
  notifications                Notification[]
  chatMessages                 ComplaintChatMessage[]
  reviews                      Review[]
  statusHistory                StatusHistory[]

  @@index([userId, status])
  @@index([status])
  @@index([createdAt])
  @@index([category])
  @@index([subcategory])
  @@index([category, subcategory])
  @@index([status], map: "idx_complaint_status")
  @@index([userId, status], map: "idx_complaint_user_status")
  @@index([wardId])
  @@index([assignedAdminId])
  @@index([assignedAdminId, status])
  @@index([wardId, status])
  @@index([cityCorporationCode])
  @@index([zoneId])
  @@index([cityCorporationCode, zoneId, wardId])
  @@index([othersCategory])
  @@index([othersSubcategory])
  @@index([status, othersCategory])
  @@index([complaintCityCorporationCode])
  @@index([complaintZoneId])
  @@index([complaintWardId])
  @@index([complaintCityCorporationCode, complaintZoneId, complaintWardId])
  @@index([status, createdAt], name: "idx_complaint_status_date")
  @@index([userId, createdAt], name: "idx_complaint_user_date")
}

model ChatMessage {
  id         Int             @id @default(autoincrement())
  content    String          @db.Text
  type       ChatMessageType @default(TEXT)
  fileUrl    String?         @db.VarChar(500)
  voiceUrl   String?         @db.VarChar(500)
  senderType SenderType      @default(CITIZEN)
  senderId   Int
  receiverId Int
  isRead     Boolean         @default(false)
  createdAt  DateTime        @default(now())
  receiver   User            @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User            @relation("SentMessages", fields: [senderId], references: [id])

  @@index([senderId, receiverId, createdAt])
  @@index([receiverId], map: "ChatMessage_receiverId_fkey")
  @@index([senderId, createdAt], name: "idx_chat_sender_date")
  @@index([receiverId, isRead], name: "idx_receiver_unread")
  @@map("chat_messages")
}

model ComplaintChatMessage {
  id          Int        @id @default(autoincrement())
  complaintId Int
  senderId    Int
  senderType  SenderType
  message     String     @db.Text
  imageUrl    String?
  read        Boolean    @default(false)
  createdAt   DateTime   @default(now())
  voiceUrl    String?
  complaint   Complaint  @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([complaintId])
  @@index([createdAt])
  @@index([complaintId, createdAt], name: "idx_complaint_chat_date")
  @@map("complaint_chat_messages")
}

model StatusHistory {
  id          Int                      @id @default(autoincrement())
  complaintId Int
  oldStatus   status_history_oldStatus
  newStatus   status_history_newStatus
  changedBy   Int
  note        String?                  @db.Text
  createdAt   DateTime                 @default(now())
  complaint   Complaint                @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([complaintId])
  @@index([createdAt])
  @@map("status_history")
}

model Payment {
  id          Int           @id @default(autoincrement())
  amount      Float
  method      String
  status      PaymentStatus @default(PENDING)
  reference   String        @unique
  userId      Int
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])

  @@index([userId, status])
}

model Notification {
  id           Int        @id @default(autoincrement())
  title        String
  message      String     @db.Text
  type         String
  isRead       Boolean    @default(false)
  userId       Int
  createdAt    DateTime   @default(now())
  complaintId  Int?
  statusChange String?
  metadata     String?    @db.Text
  complaint    Complaint? @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([complaintId])
  @@index([userId, isRead, createdAt], name: "idx_notification_user_read_date")
}

model Review {
  id          Int       @id @default(autoincrement())
  complaintId Int
  userId      Int
  rating      Int
  comment     String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  complaint   Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([complaintId, userId])
  @@index([complaintId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  userId     Int
  action     String
  entityType String
  entityId   Int?
  oldValue   String?  @db.LongText
  newValue   String?  @db.LongText
  ipAddress  String?
  userAgent  String?  @db.Text
  timestamp  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([action])
  @@index([userId, timestamp])
  @@index([entityType, entityId, timestamp], name: "idx_activity_entity_date")
  @@map("activity_logs")
}

model ward_inspectors {
  id                Int                    @id @default(autoincrement())
  name              String
  wardId            Int
  zoneId            Int
  cityCorporationId Int
  status            ward_inspectors_status @default(ACTIVE)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime
  wards             Ward                   @relation(fields: [wardId], references: [id], onDelete: Cascade)
  zones             Zone                   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([cityCorporationId])
  @@index([wardId, status])
  @@index([zoneId])
}

model user_activities {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  details   String?  @db.LongText
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  users     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model UserZone {
  id         Int      @id @default(autoincrement())
  userId     Int
  zoneId     Int
  assignedAt DateTime @default(now())
  assignedBy Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  assigner   User?    @relation("ZoneAssigner", fields: [assignedBy], references: [id])
  user       User     @relation("UserZones", fields: [userId], references: [id], onDelete: Cascade)
  zone       Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([userId, zoneId])
  @@index([userId])
  @@index([zoneId])
  @@index([assignedBy])
  @@map("user_zones")
}

model SystemConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ChatMessageType {
  TEXT
  IMAGE
  FILE
  VOICE
}

enum SenderType {
  ADMIN
  CITIZEN
  BOT
}

enum CityCorporationStatus {
  ACTIVE
  INACTIVE
}

enum ZoneStatus {
  ACTIVE
  INACTIVE
}

enum WardStatus {
  ACTIVE
  INACTIVE
}

enum users_role {
  CUSTOMER
  SERVICE_PROVIDER
  ADMIN
  SUPER_ADMIN
  MASTER_ADMIN
}

enum ward_inspectors_status {
  ACTIVE
  INACTIVE
}

enum status_history_oldStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
  OTHERS
}

enum status_history_newStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
  OTHERS
}

enum Complaint_status {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
  OTHERS
}

enum ChatType {
  LIVE_CHAT
  COMPLAINT_CHAT
}

// Bot Message Configuration
model BotMessageConfig {
  id              Int      @id @default(autoincrement())
  chatType        ChatType
  messageKey      String   @unique @db.VarChar(100)
  content         String   @db.Text
  contentBn       String   @map("content_bn") @db.Text
  stepNumber      Int      @map("step_number")
  isActive        Boolean  @default(true) @map("is_active")
  displayOrder    Int      @default(0) @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([chatType, isActive, displayOrder])
  @@index([chatType, stepNumber, isActive, displayOrder], name: "bot_msg_cfg_chat_step_active_order_idx")
  @@map("bot_message_configs")
}

// Bot Trigger Rules
model BotTriggerRule {
  id                    Int      @id @default(autoincrement())
  chatType              ChatType
  isEnabled             Boolean  @default(true) @map("is_enabled")
  reactivationThreshold Int      @default(5) @map("reactivation_threshold")
  resetStepsOnReactivate Boolean @default(false) @map("reset_steps_on_reactivate")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@unique([chatType])
  @@map("bot_trigger_rules")
}

// Bot Conversation State (tracks bot state per conversation)
model BotConversationState {
  id                  Int      @id @default(autoincrement())
  chatType            ChatType
  conversationId      String   @db.VarChar(100)
  currentStep         Int      @default(0) @map("current_step")
  isActive            Boolean  @default(true) @map("is_active")
  lastAdminReplyAt    DateTime? @map("last_admin_reply_at")
  userMessageCount    Int      @default(0) @map("user_message_count")
  lastBotMessageAt    DateTime? @map("last_bot_message_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@unique([chatType, conversationId])
  @@index([chatType, isActive])
  @@map("bot_conversation_states")
}

// Bot Analytics
model BotMessageAnalytics {
  id              Int      @id @default(autoincrement())
  chatType        ChatType
  messageKey      String   @db.VarChar(100)
  stepNumber      Int      @map("step_number")
  triggerCount    Int      @default(0) @map("trigger_count")
  adminReplyCount Int      @default(0) @map("admin_reply_count")
  avgResponseTime Int?     @map("avg_response_time")
  date            DateTime @default(now())

  @@index([chatType, date])
  @@index([messageKey])
  @@index([chatType, messageKey, date], name: "bot_msg_analytics_chat_key_date_idx")
  @@map("bot_message_analytics")
}

// Waste Management System
model WastePost {
  id          Int                  @id @default(autoincrement())
  title       String               @db.VarChar(255)
  content     String               @db.Text
  imageUrl    String?              @db.VarChar(500)
  category    WastePostCategory
  status      WastePostStatus      @default(DRAFT)
  createdBy   Int
  publishedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  reactions   WastePostReaction[]

  @@index([status])
  @@index([category])
  @@index([createdBy])
  @@index([publishedAt])
  @@index([status, category])
  @@map("waste_posts")
}

model WastePostReaction {
  id           Int       @id @default(autoincrement())
  postId       Int
  userId       Int
  reactionType String    @db.VarChar(20) // "LIKE" or "LOVE"
  createdAt    DateTime  @default(now())
  post         WastePost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([reactionType])
  @@map("waste_post_reactions")
}

enum WastePostCategory {
  CURRENT_WASTE
  FUTURE_WASTE
}

enum WastePostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum GalleryImageStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model GalleryImage {
  id           Int                @id @default(autoincrement())
  title        String             @db.VarChar(255)
  description  String?            @db.Text
  imageUrl     String             @db.VarChar(500)
  status       GalleryImageStatus @default(ACTIVE)
  displayOrder Int                @default(0)
  createdBy    Int
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([status])
  @@index([displayOrder])
  @@index([createdBy])
  @@index([status, displayOrder])
  @@map("gallery_images")
}

// Notice Board System
enum NoticeType {
  GENERAL
  URGENT
  EVENT
  SCHEDULED
}

enum NoticePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model NoticeCategory {
  id        Int       @id @default(autoincrement())
  name      String
  nameBn    String?   @map("name_bn")
  color     String    @default("#2E8B57")
  icon      String?
  parentId  Int?      @map("parent_id")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  
  parent    NoticeCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children  NoticeCategory[] @relation("CategoryHierarchy")
  notices   Notice[]

  @@index([parentId])
  @@index([isActive])
  @@map("notice_categories")
}

model Notice {
  id            Int            @id @default(autoincrement())
  title         String
  titleBn       String?        @map("title_bn")
  description   String         @db.Text
  descriptionBn String?        @map("description_bn") @db.Text
  content       String         @db.Text
  contentBn     String?        @map("content_bn") @db.Text
  categoryId    Int            @map("category_id")
  type          NoticeType     @default(GENERAL)
  priority      NoticePriority @default(NORMAL)
  isActive      Boolean        @default(true) @map("is_active")
  publishDate   DateTime       @default(now()) @map("publish_date")
  expiryDate    DateTime?      @map("expiry_date")
  imageUrl      String?        @map("image_url")
  attachments   Json?
  targetZones   Json?          @map("target_zones")
  targetWards   Json?          @map("target_wards")
  targetCities  Json?          @map("target_cities")
  viewCount     Int            @default(0) @map("view_count")
  readCount     Int            @default(0) @map("read_count")
  createdBy     Int            @map("created_by")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  category      NoticeCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  creator       User           @relation("NoticeCreator", fields: [createdBy], references: [id])
  interactions  NoticeInteraction[]

  @@index([categoryId])
  @@index([isActive, publishDate])
  @@index([expiryDate])
  @@index([createdBy])
  @@index([type])
  @@index([priority])
  @@map("notices")
}

model NoticeInteraction {
  id            Int             @id @default(autoincrement())
  noticeId      Int             @map("notice_id")
  userId        Int             @map("user_id")
  type          InteractionType
  createdAt     DateTime        @default(now()) @map("created_at")

  notice        Notice          @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([noticeId, userId, type])
  @@index([noticeId])
  @@index([userId])
  @@map("notice_interactions")
}

enum InteractionType {
  LIKE
  LOVE
  READ
  VIEW
  RSVP_YES
  RSVP_NO
  RSVP_MAYBE
}

