generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model CityCorporation {
  id        Int                   @id @default(autoincrement())
  code      String                @unique
  name      String
  minWard   Int
  maxWard   Int
  status    CityCorporationStatus @default(ACTIVE)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  users     User[]
  zones     Zone[]

  @@index([status])
  @@index([code])
  @@map("city_corporations")
}

model Zone {
  id                  Int               @id @default(autoincrement())
  zoneNumber          Int?
  number              Int
  name                String
  cityCorporationId   Int
  officerName         String?
  officerDesignation  String?
  officerSerialNumber String?
  supervisorName      String?
  supervisorTitle     String?
  status              ZoneStatus        @default(ACTIVE)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  users               User[]
  ward_inspectors     ward_inspectors[]
  wards               Ward[]
  cityCorporation     CityCorporation   @relation(fields: [cityCorporationId], references: [id], onDelete: Cascade)

  @@unique([zoneNumber, cityCorporationId])
  @@index([cityCorporationId, status])
  @@map("zones")
}

model Ward {
  id                    Int               @id @default(autoincrement())
  wardNumber            Int?
  number                Int
  zoneId                Int
  inspectorName         String?
  inspectorSerialNumber String?
  cityCorporationId     Int
  inspectorCount        Int?
  status                WardStatus        @default(ACTIVE)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  Complaint             Complaint[]
  users                 User[]
  ward_inspectors       ward_inspectors[]
  zone                  Zone              @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([wardNumber, zoneId])
  @@index([zoneId, status])
  @@index([cityCorporationId])
  @@index([number, cityCorporationId])
  @@map("wards")
}

model User {
  id                      Int                      @id @default(autoincrement())
  email                   String?                  @unique
  phone                   String                   @unique
  passwordHash            String
  firstName               String
  lastName                String
  avatar                  String?
  role                    users_role               @default(CUSTOMER)
  status                  UserStatus               @default(PENDING)
  emailVerified           Boolean                  @default(false)
  phoneVerified           Boolean                  @default(false)
  twoFactorEnabled        Boolean                  @default(false)
  twoFactorSecret         String?
  lastLoginAt             DateTime?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  address                 String?
  verificationCode        String?
  verificationCodeExpiry  DateTime?
  cityCorporationCode     String?
  wardId                  Int?
  wardImageCount          Int                      @default(0)
  zoneId                  Int?
  receivedMessages        ChatMessage[]            @relation("ReceivedMessages")
  sentMessages            ChatMessage[]            @relation("SentMessages")
  complaints              Complaint[]
  notifications           Notification[]
  payments                Payment[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]
  refreshTokens           RefreshToken[]
  sessions                Session[]
  cityCorporation         CityCorporation?         @relation(fields: [cityCorporationCode], references: [code])
  ward                    Ward?                    @relation(fields: [wardId], references: [id])
  zone                    Zone?                    @relation(fields: [zoneId], references: [id])

  @@index([phone])
  @@index([email])
  @@index([status])
  @@index([role])
  @@index([createdAt])
  @@index([cityCorporationCode])
  @@index([zoneId])
  @@index([wardId])
  @@index([cityCorporationCode, wardId])
  @@index([cityCorporationCode], map: "users_cityCorporationCode_ward_idx")
  @@map("users")
}

model Session {
  id         String   @id @default(uuid())
  userId     Int
  token      String   @unique
  deviceInfo String?
  ipAddress  String?
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "sessions_userId_fkey")
  @@map("sessions")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    Int
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "refresh_tokens_userId_fkey")
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "password_reset_tokens_userId_fkey")
  @@map("password_reset_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  code      String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "email_verification_tokens_userId_fkey")
  @@index([code])
  @@map("email_verification_tokens")
}

model Complaint {
  id            Int                    @id @default(autoincrement())
  title         String
  description   String                 @db.Text
  location      String
  imageUrl      String?                @db.Text
  audioUrl      String?                @db.Text
  status        ComplaintStatus        @default(PENDING)
  priority      Int                    @default(1)
  userId        Int?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  category      String?
  subcategory   String?
  wardId        Int?
  user          User?                  @relation(fields: [userId], references: [id])
  wards         Ward?                  @relation(fields: [wardId], references: [id])
  chatMessages  ComplaintChatMessage[]
  statusHistory StatusHistory[]

  @@index([userId, status])
  @@index([status])
  @@index([createdAt])
  @@index([category])
  @@index([subcategory])
  @@index([category, subcategory])
  @@index([status], map: "idx_complaint_status")
  @@index([userId, status], map: "idx_complaint_user_status")
  @@index([wardId])
}

model ChatMessage {
  id         Int             @id @default(autoincrement())
  content    String          @db.Text
  type       ChatMessageType @default(TEXT)
  fileUrl    String?
  senderId   Int
  receiverId Int
  isRead     Boolean         @default(false)
  createdAt  DateTime        @default(now())
  receiver   User            @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User            @relation("SentMessages", fields: [senderId], references: [id])

  @@index([senderId, receiverId, createdAt])
  @@index([receiverId], map: "ChatMessage_receiverId_fkey")
}

model ComplaintChatMessage {
  id          Int        @id @default(autoincrement())
  complaintId Int
  senderId    Int
  senderType  SenderType
  message     String     @db.Text
  imageUrl    String?
  read        Boolean    @default(false)
  createdAt   DateTime   @default(now())
  voiceUrl    String?
  complaint   Complaint  @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([complaintId])
  @@index([createdAt])
  @@map("complaint_chat_messages")
}

model StatusHistory {
  id          Int             @id @default(autoincrement())
  complaintId Int
  oldStatus   ComplaintStatus
  newStatus   ComplaintStatus
  changedBy   Int
  note        String?         @db.Text
  createdAt   DateTime        @default(now())
  complaint   Complaint       @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  @@index([complaintId])
  @@index([createdAt])
  @@map("status_history")
}

model Payment {
  id          Int           @id @default(autoincrement())
  amount      Float
  method      String
  status      PaymentStatus @default(PENDING)
  reference   String        @unique
  userId      Int
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id])

  @@index([userId, status])
}

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String   @db.Text
  type      String
  isRead    Boolean  @default(false)
  userId    Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
}

model ward_inspectors {
  id                Int                    @id @default(autoincrement())
  name              String
  wardId            Int
  zoneId            Int
  cityCorporationId Int
  status            ward_inspectors_status @default(ACTIVE)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime
  wards             Ward                   @relation(fields: [wardId], references: [id], onDelete: Cascade)
  zones             Zone                   @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([cityCorporationId])
  @@index([wardId, status])
  @@index([zoneId])
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum ComplaintStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ChatMessageType {
  TEXT
  IMAGE
  FILE
}

enum SenderType {
  ADMIN
  CITIZEN
}

enum CityCorporationStatus {
  ACTIVE
  INACTIVE
}

enum ZoneStatus {
  ACTIVE
  INACTIVE
}

enum WardStatus {
  ACTIVE
  INACTIVE
}

enum users_role {
  CUSTOMER
  SERVICE_PROVIDER
  ADMIN
  SUPER_ADMIN
  MASTER_ADMIN
}

enum ward_inspectors_status {
  ACTIVE
  INACTIVE
}
