var w=Object.defineProperty;var v=(l,e,t)=>e in l?w(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var h=(l,e,t)=>v(l,typeof e!="symbol"?e+"":e,t);import{a as m}from"./query-vendor-CZVuOxbJ.js";import{A as p,y as i}from"./index-DBuvollO.js";class s extends Error{constructor(e,t,a){super(e),this.statusCode=t,this.originalError=a,this.name="BotMessageServiceError",Object.setPrototypeOf(this,s.prototype)}}class f{constructor(){h(this,"apiClient");this.apiClient=m.create({baseURL:p.BASE_URL,timeout:p.TIMEOUT,withCredentials:!0,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}setupInterceptors(){this.apiClient.interceptors.request.use(e=>{try{const t=localStorage.getItem("accessToken");t&&(e.headers.Authorization=`Bearer ${t}`)}catch(t){console.error("[BotMessageService] Error getting token:",t)}return e},e=>(console.error("[BotMessageService] Request error:",e),Promise.reject(this.handleError(e)))),this.apiClient.interceptors.response.use(e=>e,e=>{var t;return console.error("[BotMessageService] Response error:",e),((t=e.response)==null?void 0:t.status)===401&&window.location.pathname!=="/login"&&(console.warn("[BotMessageService] Unauthorized - redirecting to login"),window.location.assign("/login")),Promise.reject(this.handleError(e))})}handleError(e){var t,a;if(m.isAxiosError(e)){const o=e,r=(t=o.response)==null?void 0:t.status,n=(a=o.response)==null?void 0:a.data;if(!o.response)return new s("Network error. Please check your internet connection.",0,e);if(o.code==="ECONNABORTED")return new s("Request timeout. Please try again.",408,e);if(r===400&&(n!=null&&n.errors)&&Array.isArray(n.errors)){const c=n.errors.map(g=>`${g.field}: ${g.message}`).join(", ");return new s(`Validation error: ${c}`,400,e)}if(n!=null&&n.message)return new s(n.message,r,e);switch(r){case 400:return new s("Invalid request. Please check your input.",400,e);case 401:return new s("Unauthorized. Please log in again.",401,e);case 403:return new s("Access denied. You do not have permission to perform this action.",403,e);case 404:return new s("Resource not found.",404,e);case 409:return new s("Conflict. The resource already exists or is in use.",409,e);case 422:return new s("Validation error. Please check your input.",422,e);case 429:return new s("Too many requests. Please try again later.",429,e);case 500:return new s("Server error. Please try again later.",500,e);case 503:return new s("Service unavailable. Please try again later.",503,e);default:return new s(`Request failed with status ${r}`,r,e)}}return e instanceof s?e:new s((e==null?void 0:e.message)||"An unexpected error occurred",void 0,e)}validateChatType(e){if(!["LIVE_CHAT","COMPLAINT_CHAT"].includes(e))throw new s(`Invalid chat type: ${e}. Must be LIVE_CHAT or COMPLAINT_CHAT.`,400)}validateMessageId(e){if(!e||e<=0||!Number.isInteger(e))throw new s("Invalid message ID. Must be a positive integer.",400)}validateCreateRequest(e){if(!e.chatType)throw new s("Chat type is required",400);if(this.validateChatType(e.chatType),!e.messageKey||e.messageKey.trim().length===0)throw new s("Message key is required",400);if(!e.content||e.content.trim().length===0)throw new s("Content is required",400);if(!e.contentBn||e.contentBn.trim().length===0)throw new s("Bangla content is required",400);if(e.stepNumber===void 0||e.stepNumber<1)throw new s("Step number must be a positive integer",400)}async getBotMessages(e){var t;try{e&&this.validateChatType(e);const a={};e&&(a.chatType=e);const o=`bot-messages-${e||"all"}`,r=i.get(o);if(r)return console.log("[BotMessageService] Returning cached bot messages"),r;console.log("[BotMessageService] Fetching bot messages from API");const n=await this.apiClient.get("/api/admin/bot-messages",{params:a});if(!((t=n.data)!=null&&t.data))throw new s("Invalid response format from server",500);const c=n.data.data;return i.set(o,c,6e4),console.log("[BotMessageService] Bot messages fetched and cached successfully"),c}catch(a){throw console.error("[BotMessageService] Error fetching bot messages:",a),this.handleError(a)}}async createBotMessage(e){var t;try{this.validateCreateRequest(e),console.log("[BotMessageService] Creating bot message:",e.messageKey);const a=await this.apiClient.post("/api/admin/bot-messages",e);if(!((t=a.data)!=null&&t.data))throw new s("Invalid response format from server",500);return i.invalidatePattern("bot-messages"),console.log("[BotMessageService] Bot message created successfully"),a.data.data}catch(a){throw console.error("[BotMessageService] Error creating bot message:",a),this.handleError(a)}}async updateBotMessage(e,t){var a;try{if(this.validateMessageId(e),t.content!==void 0&&t.content.trim().length===0)throw new s("Content cannot be empty",400);if(t.contentBn!==void 0&&t.contentBn.trim().length===0)throw new s("Bangla content cannot be empty",400);if(t.stepNumber!==void 0&&t.stepNumber<1)throw new s("Step number must be a positive integer",400);console.log("[BotMessageService] Updating bot message:",e);const o=await this.apiClient.put(`/api/admin/bot-messages/${e}`,t);if(!((a=o.data)!=null&&a.data))throw new s("Invalid response format from server",500);return i.invalidatePattern("bot-messages"),console.log("[BotMessageService] Bot message updated successfully"),o.data.data}catch(o){throw console.error("[BotMessageService] Error updating bot message:",o),this.handleError(o)}}async deleteBotMessage(e){try{this.validateMessageId(e),console.log("[BotMessageService] Deleting bot message:",e),await this.apiClient.delete(`/api/admin/bot-messages/${e}`),i.invalidatePattern("bot-messages"),console.log("[BotMessageService] Bot message deleted successfully")}catch(t){throw console.error("[BotMessageService] Error deleting bot message:",t),this.handleError(t)}}async updateTriggerRules(e,t){var a,o;try{if(this.validateChatType(e),t.reactivationThreshold!==void 0&&(t.reactivationThreshold<1||t.reactivationThreshold>100))throw new s("Reactivation threshold must be between 1 and 100",400);console.log("[BotMessageService] Updating trigger rules for:",e);const r=await this.apiClient.put(`/api/admin/bot-messages/rules/${e}`,t);if(!((o=(a=r.data)==null?void 0:a.data)!=null&&o.rules))throw new s("Invalid response format from server",500);return i.invalidatePattern("bot-messages"),console.log("[BotMessageService] Trigger rules updated successfully"),r.data.data.rules}catch(r){throw console.error("[BotMessageService] Error updating trigger rules:",r),this.handleError(r)}}async getBotAnalytics(e){var t;try{if(e!=null&&e.chatType&&this.validateChatType(e.chatType),e!=null&&e.startDate&&(e!=null&&e.endDate)){const g=new Date(e.startDate),d=new Date(e.endDate);if(isNaN(g.getTime()))throw new s("Invalid start date format",400);if(isNaN(d.getTime()))throw new s("Invalid end date format",400);if(g>d)throw new s("Start date must be before end date",400)}const a={};e!=null&&e.chatType&&(a.chatType=e.chatType),e!=null&&e.startDate&&(a.startDate=e.startDate),e!=null&&e.endDate&&(a.endDate=e.endDate);const o=`bot-analytics-${JSON.stringify(a)}`,r=i.get(o);if(r)return console.log("[BotMessageService] Returning cached bot analytics"),r;console.log("[BotMessageService] Fetching bot analytics from API");const n=await this.apiClient.get("/api/admin/bot-messages/analytics",{params:a});if(!((t=n.data)!=null&&t.data))throw new s("Invalid response format from server",500);const c=n.data.data;return i.set(o,c,6e4),console.log("[BotMessageService] Bot analytics fetched and cached successfully"),c}catch(a){throw console.error("[BotMessageService] Error fetching bot analytics:",a),this.handleError(a)}}async reorderBotMessages(e,t){try{if(this.validateChatType(e),!Array.isArray(t)||t.length===0)throw new s("Message IDs must be a non-empty array",400);t.forEach((o,r)=>{if(!Number.isInteger(o)||o<=0)throw new s(`Invalid message ID at index ${r}: ${o}`,400)}),console.log("[BotMessageService] Reordering bot messages for:",e);const a=t.map((o,r)=>this.updateBotMessage(o,{displayOrder:r}));await Promise.all(a),i.invalidatePattern("bot-messages"),console.log("[BotMessageService] Bot messages reordered successfully")}catch(a){throw console.error("[BotMessageService] Error reordering bot messages:",a),this.handleError(a)}}async toggleBotMessageActive(e,t){try{if(this.validateMessageId(e),typeof t!="boolean")throw new s("isActive must be a boolean value",400);return console.log("[BotMessageService] Toggling bot message active status:",e,t),await this.updateBotMessage(e,{isActive:t})}catch(a){throw console.error("[BotMessageService] Error toggling bot message status:",a),this.handleError(a)}}}const M=new f;export{M as b};
