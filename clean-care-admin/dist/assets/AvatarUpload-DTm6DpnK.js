import{u as Y,p as Z,j as r,B as x,J as L,aS as $,s as G,i as A,cv as H,T as I,P as ee,w as O,m as re,C as ae}from"./mui-vendor-Dt-wTuK2.js";import{r as n}from"./react-vendor-D7yrL1sD.js";import{R as te,W as B}from"./index-CEqbPxQ7.js";const oe={maxWidth:800,maxHeight:800,quality:.85,outputFormat:"image/jpeg"};async function le(t,g={}){const d={...oe,...g};return new Promise((c,e)=>{const o=new Image,p=new FileReader;p.onload=a=>{var s;o.src=(s=a.target)==null?void 0:s.result},p.onerror=()=>{e(new Error("Failed to read image file"))},o.onload=()=>{try{const{width:a,height:s}=ie(o.width,o.height,d.maxWidth,d.maxHeight),f=document.createElement("canvas");f.width=a,f.height=s;const u=f.getContext("2d");if(!u){e(new Error("Failed to get canvas context"));return}u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(o,0,0,a,s),f.toBlob(m=>{if(!m){e(new Error("Failed to compress image"));return}const v=new File([m],t.name.replace(/\.[^/.]+$/,".jpg"),{type:d.outputFormat,lastModified:Date.now()}),C=(t.size/1024).toFixed(2),E=(v.size/1024).toFixed(2),k=((t.size-v.size)/t.size*100).toFixed(1);console.log("Image compression:",{original:`${C} KB`,compressed:`${E} KB`,reduction:`${k}%`,dimensions:`${a}x${s}`}),c(v)},d.outputFormat,d.quality)}catch(a){e(a)}},o.onerror=()=>{e(new Error("Failed to load image"))},p.readAsDataURL(t)})}function ie(t,g,d,c){let e=t,o=g;if(e>d||o>c){const p=e/o;e>o?(e=d,o=Math.round(e/p)):(o=c,e=Math.round(o*p)),e>d&&(e=d,o=Math.round(e/p)),o>c&&(o=c,e=Math.round(o*p))}return{width:e,height:o}}const ne=5,se=["image/jpeg","image/jpg","image/png","image/webp"],M=[".jpg",".jpeg",".png",".webp"],ce=t=>{const{uploadAvatar:g}=te(),[d,c]=n.useState(!1),[e,o]=n.useState(0),[p,a]=n.useState(null),[s,f]=n.useState(null),u=(t==null?void 0:t.maxSizeInMB)??ne,m=(t==null?void 0:t.allowedTypes)??se,v=n.useCallback(h=>{try{s&&URL.revokeObjectURL(s);const i=B(h,{maxSizeInMB:u,allowedTypes:m,allowedExtensions:M});if(i){a(i);return}const U=URL.createObjectURL(h);f(U),a(null)}catch(i){console.error("Failed to generate preview:",i),a("Failed to generate image preview")}},[s,u,m]),C=n.useCallback(()=>{if(s){try{URL.revokeObjectURL(s)}catch(h){console.error("Failed to revoke preview URL:",h)}f(null)}},[s]),E=n.useCallback(async h=>{var i,U;c(!0),o(0),a(null);try{const w=B(h,{maxSizeInMB:u,allowedTypes:m,allowedExtensions:M});if(w)throw new Error(w);o(10),await de(h),o(20);const b=await le(h,{maxWidth:800,maxHeight:800,quality:.85});o(40);const y=await g(b);if(o(90),!y||!ue(y))throw new Error("Invalid avatar URL received from server");return o(100),(i=t==null?void 0:t.onSuccess)==null||i.call(t,y),y}catch(w){const b=w instanceof Error?w.message:"Failed to upload avatar";throw a(b),(U=t==null?void 0:t.onError)==null||U.call(t,b),w}finally{c(!1),setTimeout(()=>o(0),1e3)}},[g,u,m,t]),k=n.useCallback(()=>{a(null)},[]);return{uploadAvatar:E,isUploading:d,uploadProgress:e,uploadError:p,previewUrl:s,clearUploadError:k,generatePreview:v,clearPreview:C}};async function de(t){return new Promise((g,d)=>{const c=new FileReader;c.onload=e=>{var f;const o=new Uint8Array((f=e.target)==null?void 0:f.result).subarray(0,4);let p="";for(let u=0;u<o.length;u++)p+=o[u].toString(16);Object.keys({ffd8ff:["image/jpeg"],"89504e47":["image/png"],52494646:["image/webp"]}).some(u=>p.startsWith(u))?g():d(new Error("File is not a valid image"))},c.onerror=()=>{d(new Error("Failed to read file"))},c.readAsArrayBuffer(t.slice(0,4))})}function ue(t){try{const g=new URL(t);return g.protocol==="http:"||g.protocol==="https:"}catch{return!1}}const me=({currentAvatar:t,onUpload:g,size:d=120,initials:c="?",disabled:e=!1,maxSizeInMB:o=5,allowedTypes:p=["image/jpeg","image/jpg","image/png","image/webp"]})=>{const a=Y(),s=Z(a.breakpoints.down("sm")),f=n.useRef(null),[u,m]=n.useState(!1),[v,C]=n.useState(null),[E,k]=n.useState(!1),{uploadAvatar:h,isUploading:i,uploadProgress:U,uploadError:w,previewUrl:b,clearUploadError:y,generatePreview:z,clearPreview:F}=ce({maxSizeInMB:o,allowedTypes:p,onSuccess:async l=>{await g(l),k(!1),F(),C(null)},onError:l=>{console.error("Upload error:",l)}}),j=s?Math.min(d,100):d,D=n.useCallback(l=>{e||i||(C(l),z(l),k(!0))},[e,i,z]),T=n.useCallback(l=>{var P;const S=(P=l.target.files)==null?void 0:P[0];S&&D(S),l.target.value=""},[D]),_=n.useCallback(()=>{var l;e||i||(l=f.current)==null||l.click()},[e,i]),W=n.useCallback(l=>{l.preventDefault(),l.stopPropagation(),!e&&!i&&m(!0)},[e,i]),q=n.useCallback(l=>{l.preventDefault(),l.stopPropagation(),m(!1)},[]),N=n.useCallback(l=>{l.preventDefault(),l.stopPropagation()},[]),V=n.useCallback(l=>{var P;if(l.preventDefault(),l.stopPropagation(),m(!1),e||i)return;const S=(P=l.dataTransfer.files)==null?void 0:P[0];S&&D(S)},[e,i,D]),K=n.useCallback(async()=>{if(!(!b||!v))try{await h(v)}catch(l){console.error("Upload failed:",l)}},[b,v,h]),R=n.useCallback(()=>{k(!1),F(),y(),C(null)},[F,y]);n.useEffect(()=>()=>{F()},[F]);const Q=()=>i?r.jsx(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.7)",borderRadius:"50%",zIndex:2},children:r.jsxs(x,{sx:{position:"relative",display:"inline-flex"},children:[r.jsx(ae,{variant:"determinate",value:U,size:j*.4,sx:{color:"#fff"}}),r.jsx(x,{sx:{position:"absolute",top:0,left:0,bottom:0,right:0,display:"flex",alignItems:"center",justifyContent:"center"},children:r.jsx(I,{variant:"caption",component:"div",sx:{color:"#fff",fontWeight:600},children:`${Math.round(U)}%`})})]})}):null,X=()=>!E||!b?null:r.jsxs(ee,{elevation:8,role:"dialog","aria-modal":"true","aria-labelledby":"avatar-preview-title",sx:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:1300,p:3,maxWidth:s?"90vw":400,width:"100%"},children:[r.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[r.jsx(I,{variant:"h6",id:"avatar-preview-title",children:"Preview Avatar"}),r.jsx(A,{size:"small",onClick:R,disabled:i,"aria-label":"Close preview",children:r.jsx(O,{"aria-hidden":"true"})})]}),r.jsx(x,{sx:{display:"flex",justifyContent:"center",mb:2},children:r.jsx(L,{src:b,alt:"Preview of new profile picture",sx:{width:s?150:200,height:s?150:200,border:`4px solid ${a.palette.primary.main}`},role:"img","aria-label":"Preview of new profile picture"})}),w&&r.jsx(re,{severity:"error",sx:{mb:2},onClose:y,children:w}),r.jsxs(x,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[r.jsxs(A,{onClick:R,disabled:i,"aria-label":"Cancel avatar upload",sx:{border:`1px solid ${a.palette.divider}`,borderRadius:1,px:2,"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:[r.jsx(I,{variant:"button",sx:{mr:1},children:"Cancel"}),r.jsx(O,{fontSize:"small","aria-hidden":"true"})]}),r.jsxs(A,{onClick:K,disabled:i,"aria-label":i?"Uploading avatar":"Confirm and upload avatar","aria-busy":i,sx:{background:a.palette.primary.main,color:"#fff",borderRadius:1,px:2,"&:hover":{background:a.palette.primary.dark},"&:disabled":{background:a.palette.action.disabledBackground},"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:[r.jsx(I,{variant:"button",sx:{mr:1},children:i?"Uploading...":"Upload"}),r.jsx($,{fontSize:"small","aria-hidden":"true"})]})]})]}),J=()=>E?r.jsx(x,{onClick:R,sx:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1299}}):null;return r.jsxs(r.Fragment,{children:[r.jsxs(x,{sx:{position:"relative",display:"inline-block"},children:[r.jsx("input",{ref:f,type:"file",accept:p.join(","),onChange:T,style:{display:"none"},disabled:e||i,"aria-label":"Upload profile picture",id:"avatar-upload-input"}),r.jsxs(x,{onDragEnter:W,onDragLeave:q,onDragOver:N,onDrop:V,sx:{position:"relative",cursor:e||i?"not-allowed":"pointer",opacity:e?.6:1},children:[r.jsx(L,{src:t,alt:`Current profile picture${c?` (${c})`:""}`,sx:{width:j,height:j,fontSize:j*.4,border:u?`3px dashed ${a.palette.primary.main}`:`3px solid ${a.palette.divider}`,transition:"all 0.2s ease-in-out",backgroundColor:a.palette.grey[300]},role:"img","aria-label":`Profile picture${c?` showing initials ${c}`:""}`,children:c}),r.jsx(x,{role:"status","aria-live":"polite","aria-atomic":"true",children:Q()}),u&&r.jsx(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(25, 118, 210, 0.1)",borderRadius:"50%",zIndex:1},role:"status","aria-label":"Drop file to upload",children:r.jsx($,{sx:{fontSize:j*.4,color:a.palette.primary.main},"aria-hidden":"true"})}),!i&&r.jsx(G,{title:"Upload new avatar",arrow:!0,children:r.jsx(A,{onClick:_,disabled:e,"aria-label":"Upload new profile picture",component:"label",htmlFor:"avatar-upload-input",sx:{position:"absolute",bottom:0,right:0,backgroundColor:a.palette.primary.main,color:"#fff",width:j*.3,height:j*.3,"&:hover":{backgroundColor:a.palette.primary.dark},"&:disabled":{backgroundColor:a.palette.action.disabledBackground},"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:r.jsx(H,{sx:{fontSize:j*.15},"aria-hidden":"true"})})})]}),!s&&r.jsx(I,{variant:"caption",sx:{display:"block",textAlign:"center",mt:1,color:a.palette.text.secondary},children:"Click or drag to upload"})]}),J(),X()]})};export{me as A};
