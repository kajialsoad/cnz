import{e as Q,j as e,cb as X,r as s,ce as L,l as G,v as Y,F as x,G as z,aj as Z,I as D,T as P,a7 as J,H as R,L as ee,K as re}from"./index-DlgNj6PR.js";import{C as $}from"./CloudUpload-OU3zt_8F.js";const ae=Q([e.jsx("circle",{cx:"12",cy:"12",r:"3.2"},"0"),e.jsx("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")]),te={maxWidth:800,maxHeight:800,quality:.85,outputFormat:"image/jpeg"};async function oe(t,f={}){const d={...te,...f};return new Promise((c,r)=>{const o=new Image,p=new FileReader;p.onload=a=>{var n;o.src=(n=a.target)==null?void 0:n.result},p.onerror=()=>{r(new Error("Failed to read image file"))},o.onload=()=>{try{const{width:a,height:n}=ie(o.width,o.height,d.maxWidth,d.maxHeight),g=document.createElement("canvas");g.width=a,g.height=n;const u=g.getContext("2d");if(!u){r(new Error("Failed to get canvas context"));return}u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(o,0,0,a,n),g.toBlob(m=>{if(!m){r(new Error("Failed to compress image"));return}const C=new File([m],t.name.replace(/\.[^/.]+$/,".jpg"),{type:d.outputFormat,lastModified:Date.now()}),E=(t.size/1024).toFixed(2),I=(C.size/1024).toFixed(2),l=((t.size-C.size)/t.size*100).toFixed(1);console.log("Image compression:",{original:`${E} KB`,compressed:`${I} KB`,reduction:`${l}%`,dimensions:`${a}x${n}`}),c(C)},d.outputFormat,d.quality)}catch(a){r(a)}},o.onerror=()=>{r(new Error("Failed to load image"))},p.readAsDataURL(t)})}function ie(t,f,d,c){let r=t,o=f;if(r>d||o>c){const p=r/o;r>o?(r=d,o=Math.round(r/p)):(o=c,r=Math.round(o*p)),r>d&&(r=d,o=Math.round(r/p)),o>c&&(o=c,r=Math.round(o*p))}return{width:r,height:o}}const le=5,ne=["image/jpeg","image/jpg","image/png","image/webp"],M=[".jpg",".jpeg",".png",".webp"],se=t=>{const{uploadAvatar:f}=X(),[d,c]=s.useState(!1),[r,o]=s.useState(0),[p,a]=s.useState(null),[n,g]=s.useState(null),u=(t==null?void 0:t.maxSizeInMB)??le,m=(t==null?void 0:t.allowedTypes)??ne,C=s.useCallback(h=>{try{n&&URL.revokeObjectURL(n);const v=L(h,{maxSizeInMB:u,allowedTypes:m,allowedExtensions:M});if(v){a(v);return}const j=URL.createObjectURL(h);g(j),a(null)}catch(v){console.error("Failed to generate preview:",v),a("Failed to generate image preview")}},[n,u,m]),E=s.useCallback(()=>{if(n){try{URL.revokeObjectURL(n)}catch(h){console.error("Failed to revoke preview URL:",h)}g(null)}},[n]),I=s.useCallback(async h=>{var v,j;c(!0),o(0),a(null);try{const b=L(h,{maxSizeInMB:u,allowedTypes:m,allowedExtensions:M});if(b)throw new Error(b);o(10),await ce(h),o(20);const F=await oe(h,{maxWidth:800,maxHeight:800,quality:.85});o(40);const w=await f(F);if(o(90),!w||!de(w))throw new Error("Invalid avatar URL received from server");return o(100),(v=t==null?void 0:t.onSuccess)==null||v.call(t,w),w}catch(b){const F=b instanceof Error?b.message:"Failed to upload avatar";throw a(F),(j=t==null?void 0:t.onError)==null||j.call(t,F),b}finally{c(!1),setTimeout(()=>o(0),1e3)}},[f,u,m,t]),l=s.useCallback(()=>{a(null)},[]);return{uploadAvatar:I,isUploading:d,uploadProgress:r,uploadError:p,previewUrl:n,clearUploadError:l,generatePreview:C,clearPreview:E}};async function ce(t){return new Promise((f,d)=>{const c=new FileReader;c.onload=r=>{var g;const o=new Uint8Array((g=r.target)==null?void 0:g.result).subarray(0,4);let p="";for(let u=0;u<o.length;u++)p+=o[u].toString(16);Object.keys({ffd8ff:["image/jpeg"],"89504e47":["image/png"],52494646:["image/webp"]}).some(u=>p.startsWith(u))?f():d(new Error("File is not a valid image"))},c.onerror=()=>{d(new Error("Failed to read file"))},c.readAsArrayBuffer(t.slice(0,4))})}function de(t){try{const f=new URL(t);return f.protocol==="http:"||f.protocol==="https:"}catch{return!1}}const ge=({currentAvatar:t,onUpload:f,size:d=120,initials:c="?",disabled:r=!1,maxSizeInMB:o=5,allowedTypes:p=["image/jpeg","image/jpg","image/png","image/webp"]})=>{const a=G(),n=Y(a.breakpoints.down("sm")),g=s.useRef(null),[u,m]=s.useState(!1),[C,E]=s.useState(!1),{uploadAvatar:I,isUploading:l,uploadProgress:h,uploadError:v,previewUrl:j,clearUploadError:b,generatePreview:F,clearPreview:w}=se({maxSizeInMB:o,allowedTypes:p,onSuccess:async i=>{await f(i),E(!1),w()},onError:i=>{console.error("Upload error:",i)}}),k=n?Math.min(d,100):d,S=s.useCallback(i=>{r||l||(F(i),E(!0))},[r,l,F]),O=s.useCallback(i=>{var y;const U=(y=i.target.files)==null?void 0:y[0];U&&S(U),i.target.value=""},[S]),T=s.useCallback(()=>{var i;r||l||(i=g.current)==null||i.click()},[r,l]),B=s.useCallback(i=>{i.preventDefault(),i.stopPropagation(),!r&&!l&&m(!0)},[r,l]),_=s.useCallback(i=>{i.preventDefault(),i.stopPropagation(),m(!1)},[]),W=s.useCallback(i=>{i.preventDefault(),i.stopPropagation()},[]),V=s.useCallback(i=>{var y;if(i.preventDefault(),i.stopPropagation(),m(!1),r||l)return;const U=(y=i.dataTransfer.files)==null?void 0:y[0];U&&S(U)},[r,l,S]),q=s.useCallback(async()=>{var i,U;if(j)try{const y=(U=(i=g.current)==null?void 0:i.files)==null?void 0:U[0];y&&await I(y)}catch(y){console.error("Upload failed:",y)}},[j,I]),A=s.useCallback(()=>{E(!1),w(),b()},[w,b]);s.useEffect(()=>()=>{w()},[w]);const K=()=>l?e.jsx(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.7)",borderRadius:"50%",zIndex:2},children:e.jsxs(x,{sx:{position:"relative",display:"inline-flex"},children:[e.jsx(re,{variant:"determinate",value:h,size:k*.4,sx:{color:"#fff"}}),e.jsx(x,{sx:{position:"absolute",top:0,left:0,bottom:0,right:0,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(P,{variant:"caption",component:"div",sx:{color:"#fff",fontWeight:600},children:`${Math.round(h)}%`})})]})}):null,N=()=>!C||!j?null:e.jsxs(J,{elevation:8,role:"dialog","aria-modal":"true","aria-labelledby":"avatar-preview-title",sx:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:1300,p:3,maxWidth:n?"90vw":400,width:"100%"},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(P,{variant:"h6",id:"avatar-preview-title",children:"Preview Avatar"}),e.jsx(D,{size:"small",onClick:A,disabled:l,"aria-label":"Close preview",children:e.jsx(R,{"aria-hidden":"true"})})]}),e.jsx(x,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx(z,{src:j,alt:"Preview of new profile picture",sx:{width:n?150:200,height:n?150:200,border:`4px solid ${a.palette.primary.main}`},role:"img","aria-label":"Preview of new profile picture"})}),v&&e.jsx(ee,{severity:"error",sx:{mb:2},onClose:b,children:v}),e.jsxs(x,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsxs(D,{onClick:A,disabled:l,"aria-label":"Cancel avatar upload",sx:{border:`1px solid ${a.palette.divider}`,borderRadius:1,px:2,"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:[e.jsx(P,{variant:"button",sx:{mr:1},children:"Cancel"}),e.jsx(R,{fontSize:"small","aria-hidden":"true"})]}),e.jsxs(D,{onClick:q,disabled:l,"aria-label":l?"Uploading avatar":"Confirm and upload avatar","aria-busy":l,sx:{background:a.palette.primary.main,color:"#fff",borderRadius:1,px:2,"&:hover":{background:a.palette.primary.dark},"&:disabled":{background:a.palette.action.disabledBackground},"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:[e.jsx(P,{variant:"button",sx:{mr:1},children:l?"Uploading...":"Upload"}),e.jsx($,{fontSize:"small","aria-hidden":"true"})]})]})]}),H=()=>C?e.jsx(x,{onClick:A,sx:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1299}}):null;return e.jsxs(e.Fragment,{children:[e.jsxs(x,{sx:{position:"relative",display:"inline-block"},children:[e.jsx("input",{ref:g,type:"file",accept:p.join(","),onChange:O,style:{display:"none"},disabled:r||l,"aria-label":"Upload profile picture",id:"avatar-upload-input"}),e.jsxs(x,{onDragEnter:B,onDragLeave:_,onDragOver:W,onDrop:V,sx:{position:"relative",cursor:r||l?"not-allowed":"pointer",opacity:r?.6:1},children:[e.jsx(z,{src:t,alt:`Current profile picture${c?` (${c})`:""}`,sx:{width:k,height:k,fontSize:k*.4,border:u?`3px dashed ${a.palette.primary.main}`:`3px solid ${a.palette.divider}`,transition:"all 0.2s ease-in-out",backgroundColor:a.palette.grey[300]},role:"img","aria-label":`Profile picture${c?` showing initials ${c}`:""}`,children:c}),e.jsx(x,{role:"status","aria-live":"polite","aria-atomic":"true",children:K()}),u&&e.jsx(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(25, 118, 210, 0.1)",borderRadius:"50%",zIndex:1},role:"status","aria-label":"Drop file to upload",children:e.jsx($,{sx:{fontSize:k*.4,color:a.palette.primary.main},"aria-hidden":"true"})}),!l&&e.jsx(Z,{title:"Upload new avatar",arrow:!0,children:e.jsx(D,{onClick:T,disabled:r,"aria-label":"Upload new profile picture",component:"label",htmlFor:"avatar-upload-input",sx:{position:"absolute",bottom:0,right:0,backgroundColor:a.palette.primary.main,color:"#fff",width:k*.3,height:k*.3,"&:hover":{backgroundColor:a.palette.primary.dark},"&:disabled":{backgroundColor:a.palette.action.disabledBackground},"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:e.jsx(ae,{sx:{fontSize:k*.15},"aria-hidden":"true"})})})]}),!n&&e.jsx(P,{variant:"caption",sx:{display:"block",textAlign:"center",mt:1,color:a.palette.text.secondary},children:"Click or drag to upload"})]}),H(),N()]})};export{ge as A};
