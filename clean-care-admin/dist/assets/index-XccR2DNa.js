var Vt=Object.defineProperty;var Jt=(d,s,r)=>s in d?Vt(d,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):d[s]=r;var pe=(d,s,r)=>Jt(d,typeof s!="symbol"?s+"":s,r);import{u as et,o as tt,j as e,s as st,B as x,i as Xt,v as Ut,_ as J,$ as X,a1 as C,T as c,aE as qt,I as re,C as je,aF as Kt,aG as Qt,D as V,aH as Fe,aI as _e,M as Yt,O as es,aa as ts,b as M,aJ as ss,aK as rs,aL as G,aM as me,aN as os,aO as as,P as $e,R as ns,az as D,g as He,av as Ze,Z as is,aP as ls,aQ as cs,ap as ds,aq as hs,ar as us,as as fe,at as y,au as xs,p as Be,q as Ge,ao as gs,aR as ps,aS as ms,t as fs,w as Cs,x as js}from"./mui-vendor-Y6GvQTLC.js";import{r as n,d as Ss,h as bs}from"./react-vendor-D7yrL1sD.js";import{f as ys,a as $,s as Es,b as As,A as te,u as Is,w as Ve,c as Je,h as Xe,E as Ue,M as Os,P as ws,Z as Rs,d as vs,e as Ts}from"./index-B_PiLh6w.js";import{s as Ce,a as qe,b as Ns}from"./toastUtils-aBfeJSyv.js";import{C as Ls,c as rt,a as Ke,b as zs}from"./ChatConversationPanel-BD4nv1FE.js";import"./userManagementService-CLlXA1yC.js";import{a as se}from"./query-vendor-D4yC0Jq7.js";import"./botMessageService-B9xVnXdY.js";import{u as Ds}from"./useDebounce-CcxK0pTh.js";import"./chart-vendor-BgnY-Lfo.js";import"./ErrorDisplay-BztN8unE.js";const Ps=({complaintId:d,open:s,onClose:r,onStatusUpdate:u})=>{const o=et(),g=tt(o.breakpoints.down("sm"));return e.jsxs(st,{open:s,onClose:r,maxWidth:"sm",fullWidth:!0,fullScreen:g,slotProps:{paper:{sx:{borderRadius:g?0:2,height:g?"100vh":"80vh",maxHeight:g?"100vh":"80vh",display:"flex",flexDirection:"column",animation:g?`${Es} ${$.normal.duration} ${$.smooth.timing}`:`${As} ${$.normal.duration} ${$.smooth.timing}`,animationFillMode:"both",overflow:"hidden"}},backdrop:{sx:{animation:`${ys} ${$.fast.duration} ${$.fast.timing}`}}},children:[e.jsx(x,{sx:{position:"absolute",right:8,top:8,zIndex:10},children:e.jsx(Xt,{onClick:r,size:"small",sx:{backgroundColor:"rgba(255, 255, 255, 0.8)","&:hover":{backgroundColor:"rgba(255, 255, 255, 1)"},boxShadow:1},children:e.jsx(Ut,{})})}),e.jsx(x,{sx:{flex:1,height:"100%",overflow:"hidden"},children:e.jsx(Ls,{complaintId:d,hideHeader:!1,onStatusUpdate:u})})]})};class Ws{constructor(){pe(this,"apiClient");this.apiClient=se.create({baseURL:te.BASE_URL,timeout:te.TIMEOUT,withCredentials:!0,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}setupInterceptors(){this.apiClient.interceptors.request.use(s=>{try{const r=localStorage.getItem("accessToken");r&&(s.headers.Authorization=`Bearer ${r}`)}catch(r){console.error("Error getting token:",r)}return s},s=>Promise.reject(s)),this.apiClient.interceptors.response.use(s=>s,s=>{var r;return((r=s.response)==null?void 0:r.status)===401&&window.location.pathname!=="/login"&&window.location.assign("/login"),Promise.reject(this.handleError(s))})}handleError(s){var r,u,o,g,f;if(se.isAxiosError(s)){const E=((r=s.response)==null?void 0:r.status)||500,I=((o=(u=s.response)==null?void 0:u.data)==null?void 0:o.message)||"An error occurred",O=(f=(g=s.response)==null?void 0:g.data)==null?void 0:f.errors;return{name:"ApiError",statusCode:E,message:I,errors:O}}return{name:"ApiError",statusCode:500,message:s.message||"An unexpected error occurred"}}parseMetadata(s){if(!s)return null;try{return JSON.parse(s)}catch(r){return console.error("Error parsing notification metadata:",r),null}}async getNotifications(s={}){try{const r={page:s.page||1,limit:s.limit||20};s.unreadOnly!==void 0&&(r.unreadOnly=s.unreadOnly);const u=await this.apiClient.get("/api/notifications",{params:r}),o=u.data.data.notifications.map(g=>({...g,metadata:this.parseMetadata(g.metadata)}));return{...u.data.data,notifications:o}}catch(r){throw console.error("Error fetching notifications:",r),r}}async getUnreadCount(){try{return(await this.apiClient.get("/api/notifications/count-unread")).data.data.count}catch(s){throw console.error("Error fetching unread count:",s),s}}async markAsRead(s){try{return(await this.apiClient.patch(`/api/notifications/${s}/read`)).data.data}catch(r){throw console.error("Error marking notification as read:",r),r}}async markAllAsRead(){try{return(await this.apiClient.patch("/api/notifications/read-all")).data.data.updatedCount}catch(s){throw console.error("Error marking all notifications as read:",s),s}}}new Ws;class ks{constructor(){pe(this,"apiClient");this.apiClient=se.create({baseURL:te.BASE_URL,timeout:te.TIMEOUT,withCredentials:!0,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}setupInterceptors(){this.apiClient.interceptors.request.use(s=>{try{const r=localStorage.getItem("accessToken");r&&(s.headers.Authorization=`Bearer ${r}`)}catch(r){console.error("Error getting token:",r)}return s},s=>Promise.reject(s)),this.apiClient.interceptors.response.use(s=>s,s=>{var r;return((r=s.response)==null?void 0:r.status)===401&&window.location.pathname!=="/login"&&window.location.assign("/login"),Promise.reject(this.handleError(s))})}handleError(s){var r,u,o,g,f;if(se.isAxiosError(s)){const E=((r=s.response)==null?void 0:r.status)||500,I=((o=(u=s.response)==null?void 0:u.data)==null?void 0:o.message)||"An error occurred",O=(f=(g=s.response)==null?void 0:g.data)==null?void 0:f.errors;return{name:"ApiError",statusCode:E,message:I,errors:O}}return{name:"ApiError",statusCode:500,message:s.message||"An unexpected error occurred"}}async submitReview(s,r){try{return(await this.apiClient.post(`/api/complaints/${s}/review`,r)).data.data}catch(u){throw console.error("Error submitting review:",u),u}}async getComplaintReviews(s){try{return(await this.apiClient.get(`/api/complaints/${s}/reviews`)).data.data}catch(r){throw console.error("Error fetching complaint reviews:",r),r}}async getReviewAnalytics(s={}){try{const r={};return s.cityCorporationCode&&(r.cityCorporationCode=s.cityCorporationCode),s.zoneId!==void 0&&(r.zoneId=s.zoneId),s.wardId!==void 0&&(r.wardId=s.wardId),s.startDate&&(r.startDate=s.startDate),s.endDate&&(r.endDate=s.endDate),(await this.apiClient.get("/api/admin/complaints/analytics/reviews",{params:r})).data.data}catch(r){throw console.error("Error fetching review analytics:",r),r}}}new ks;const Ms=({value:d,onChange:s,disabled:r=!1,fullWidth:u=!1})=>{const[o,g]=n.useState([]),[f,E]=n.useState(!0),[I,O]=n.useState(null);n.useEffect(()=>{R()},[]);const R=async()=>{try{E(!0),O(null);const i=await rt.getAllCategories();g(i)}catch(i){console.error("Error fetching categories:",i),O(i.message||"Failed to load categories")}finally{E(!1)}},T=i=>{s(i.target.value)};return e.jsx(J,{sx:{minWidth:u?"100%":{xs:"100%",sm:180}},disabled:r||f,children:e.jsxs(X,{value:d,onChange:T,displayEmpty:!0,startAdornment:e.jsx(re,{position:"start",children:f?e.jsx(je,{size:20,sx:{mr:1}}):e.jsx(Kt,{sx:{color:"text.secondary",mr:1}})}),sx:{backgroundColor:"white",height:{xs:40,sm:44},fontSize:{xs:"0.875rem",sm:"0.95rem"},"&:hover":{"& .MuiOutlinedInput-notchedOutline":{borderColor:"#4CAF50"}},"&.Mui-focused":{"& .MuiOutlinedInput-notchedOutline":{borderColor:"#4CAF50",borderWidth:2}}},children:[e.jsx(C,{value:"",children:e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"}},children:"All Categories"})}),e.jsx(C,{value:"uncategorized",children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(qt,{sx:{fontSize:18,color:"#9e9e9e"}}),e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"},color:"#757575"},children:"Uncategorized"})]})}),I?e.jsx(C,{disabled:!0,children:e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"},color:"error.main"},children:I})}):o.map(i=>e.jsx(C,{value:i.id,children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{sx:{width:12,height:12,borderRadius:"50%",backgroundColor:i.color,flexShrink:0}}),e.jsxs(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"}},children:[i.english," (",i.bangla,")"]})]})},i.id))]})})},Fs=({categoryId:d,value:s,onChange:r,disabled:u=!1,fullWidth:o=!1})=>{const[g,f]=n.useState([]),[E,I]=n.useState(!1),[O,R]=n.useState(null);n.useEffect(()=>{d?T():(f([]),s&&r(""))},[d]);const T=async()=>{try{I(!0),R(null);const w=await rt.getSubcategories(d);f(w)}catch(w){console.error("Error fetching subcategories:",w),R(w.message||"Failed to load subcategories"),f([])}finally{I(!1)}},i=w=>{r(w.target.value)},F=u||E||!d;return e.jsx(J,{sx:{minWidth:o?"100%":{xs:"100%",sm:200}},disabled:F,children:e.jsxs(X,{value:s,onChange:i,displayEmpty:!0,startAdornment:e.jsx(re,{position:"start",children:E?e.jsx(je,{size:20,sx:{mr:1}}):e.jsx(Qt,{sx:{color:"text.secondary",mr:1}})}),sx:{backgroundColor:F?"#f5f5f5":"white",height:{xs:40,sm:44},fontSize:{xs:"0.875rem",sm:"0.95rem"},"&:hover":{"& .MuiOutlinedInput-notchedOutline":{borderColor:F?void 0:"#4CAF50"}},"&.Mui-focused":{"& .MuiOutlinedInput-notchedOutline":{borderColor:"#4CAF50",borderWidth:2}}},children:[e.jsx(C,{value:"",children:e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"}},children:d?"All Subcategories":"Select category first"})}),O?e.jsx(C,{disabled:!0,children:e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"},color:"error.main"},children:O})}):g.map(w=>e.jsx(C,{value:w.id,children:e.jsxs(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"}},children:[w.english," (",w.bangla,")"]})},w.id))]})})},Qe=["Engineering","Electricity","Health","Property (Eviction)"],Ye=["WASA","Titas","DPDC","DESCO","BTCL","Fire Service","Others"],_s=({value:d,onChange:s,disabled:r=!1,fullWidth:u=!1})=>{const[o,g]=n.useState(!1),[f,E]=n.useState(!1),I=i=>{const F=i.target.value;s(F)},O=()=>d==="ALL"?"All Status":d==="OTHERS_ALL"?"All Others":d==="CORPORATION_INTERNAL"?"Corporation Internal":d==="CORPORATION_EXTERNAL"?"Corporation External":Qe.includes(d)?`Internal: ${d}`:Ye.includes(d)?`External: ${d}`:d,R=i=>d===i,T=i=>R(i)?e.jsx(es,{sx:{fontSize:18,color:"#4CAF50",mr:1}}):e.jsx(ts,{sx:{fontSize:18,color:"transparent",mr:1}});return e.jsx(J,{sx:{minWidth:u?"100%":{xs:"100%",sm:200}},disabled:r,children:e.jsxs(X,{value:d,onChange:I,displayEmpty:!0,startAdornment:e.jsx(re,{position:"start",children:e.jsx(Yt,{sx:{color:"text.secondary",mr:1}})}),renderValue:()=>e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"}},children:O()}),sx:{backgroundColor:"white",height:{xs:40,sm:44},fontSize:{xs:"0.875rem",sm:"0.95rem"},"&:hover":{"& .MuiOutlinedInput-notchedOutline":{borderColor:"#4CAF50"}},"&.Mui-focused":{"& .MuiOutlinedInput-notchedOutline":{borderColor:"#4CAF50",borderWidth:2}}},MenuProps:{PaperProps:{sx:{maxHeight:400,"& .MuiMenuItem-root":{fontSize:{xs:"0.875rem",sm:"0.95rem"}}}}},children:[e.jsx(C,{value:"ALL",children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[T("ALL"),e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"}},children:"All Status"})]})}),e.jsx(V,{sx:{my:.5}}),e.jsx(C,{value:"OTHERS_ALL",children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[T("OTHERS_ALL"),e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"},fontWeight:600},children:"All Others"})]})}),e.jsx(V,{sx:{my:.5}}),e.jsx(C,{value:"CORPORATION_INTERNAL",onClick:i=>{i.stopPropagation(),g(!o)},sx:{backgroundColor:o?"rgba(76, 175, 80, 0.08)":"transparent","&:hover":{backgroundColor:o?"rgba(76, 175, 80, 0.12)":"rgba(0, 0, 0, 0.04)"}},children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[T("CORPORATION_INTERNAL"),e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"},fontWeight:500,flex:1},children:"Corporation Internal"}),o?e.jsx(Fe,{sx:{fontSize:20,color:"text.secondary"}}):e.jsx(_e,{sx:{fontSize:20,color:"text.secondary"}})]})}),o&&e.jsx(e.Fragment,{children:Qe.map(i=>e.jsx(C,{value:i,sx:{pl:5,backgroundColor:R(i)?"rgba(76, 175, 80, 0.08)":"transparent","&:hover":{backgroundColor:R(i)?"rgba(76, 175, 80, 0.12)":"rgba(0, 0, 0, 0.04)"}},children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[T(i),e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"}},children:i})]})},i))}),e.jsx(V,{sx:{my:.5}}),e.jsx(C,{value:"CORPORATION_EXTERNAL",onClick:i=>{i.stopPropagation(),E(!f)},sx:{backgroundColor:f?"rgba(76, 175, 80, 0.08)":"transparent","&:hover":{backgroundColor:f?"rgba(76, 175, 80, 0.12)":"rgba(0, 0, 0, 0.04)"}},children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[T("CORPORATION_EXTERNAL"),e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"},fontWeight:500,flex:1},children:"Corporation External"}),f?e.jsx(Fe,{sx:{fontSize:20,color:"text.secondary"}}):e.jsx(_e,{sx:{fontSize:20,color:"text.secondary"}})]})}),f&&e.jsx(e.Fragment,{children:Ye.map(i=>e.jsx(C,{value:i,sx:{pl:5,backgroundColor:R(i)?"rgba(76, 175, 80, 0.08)":"transparent","&:hover":{backgroundColor:R(i)?"rgba(76, 175, 80, 0.12)":"rgba(0, 0, 0, 0.04)"}},children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",width:"100%"},children:[T(i),e.jsx(c,{sx:{fontSize:{xs:"0.875rem",sm:"0.95rem"}},children:i})]})},i))})]})})},ar=()=>{const d=Ss(),[s]=bs(),r=et(),u=tt(r.breakpoints.down("sm")),{user:o}=Is(),[g,f]=n.useState([]),[E,I]=n.useState(!0),[O,R]=n.useState(null),[T,i]=n.useState(null),[F,w]=n.useState(!1),[Se,be]=n.useState(s.get("search")||""),[P,ye]=n.useState(s.get("status")||"ALL"),[H,oe]=n.useState(s.get("category")||""),[U,q]=n.useState(s.get("subcategory")||""),[L,ae]=n.useState(s.get("othersFilter")||"ALL"),[ot,at]=n.useState([]),[W,K]=n.useState(s.get("cityCorporation")||"ALL"),[nt,it]=n.useState([]),[$s,Hs]=n.useState(null),[z,ne]=n.useState(s.get("zone")?Number(s.get("zone")):""),[Q,ie]=n.useState(s.get("ward")?Number(s.get("ward")):null),[Ee,Z]=n.useState([]),[Zs,Ae]=n.useState(!1),[Bs,Ie]=n.useState(!1),[B,Oe]=n.useState({total:0,pending:0,inProgress:0,resolved:0,rejected:0,others:0}),[v,N]=n.useState({page:parseInt(s.get("page")||"1",10),limit:parseInt(s.get("limit")||"20",10),total:0,totalPages:0}),[lt,ct]=n.useState(!1),[dt,ht]=n.useState(null),[ut,we]=n.useState(!1),[Y,xt]=n.useState(null),[gt,pt]=n.useState(""),[mt,ft]=n.useState(""),[Gs,Re]=n.useState(null),le=Ds(Se,500),[ce,Ct]=n.useState(!0),[jt,ve]=n.useState(null),[St,Te]=n.useState(!1),[de,Ne]=n.useState(!1),[he,Le]=n.useState(!1),[ee,bt]=n.useState(""),[ue,Vs]=n.useState(""),[yt,xe]=n.useState(!1),[Et,At]=n.useState(""),[It,Ot]=n.useState("");n.useEffect(()=>{o&&(async()=>{var p,S;console.log("ðŸ”„ AllComplaints: Starting data fetch for user:",o==null?void 0:o.id,o==null?void 0:o.role);const a=[vs.getCityCorporations("ACTIVE").catch(l=>(console.error("âŒ Error fetching city corporations:",l),{cityCorporations:[]}))];(o==null?void 0:o.role)==="SUPER_ADMIN"&&o.id&&(console.log("ðŸ‘¤ Fetching assigned zones for Super Admin:",o.id),a.push(Ts.getAssignedZones(Number(o.id)).catch(l=>(console.error("âŒ Error fetching assigned zones:",l),[])))),Ae(!0);try{const l=await Promise.all(a),m=l[0],h=l[1];let j=m.cityCorporations||[];if(console.log("ðŸ™ï¸ Fetched City Corps:",j.length),o&&o.role!=="MASTER_ADMIN"){const A=o.cityCorporationCode||((p=o.cityCorporation)==null?void 0:p.code);A&&(console.log("ðŸŽ¯ Filtering City Corps for assigned code:",A),j=j.filter(b=>b.code===A),W!==A&&K(A))}if(at(j),h){console.log("ðŸ›¡ï¸ Raw Assigned Zones:",h);const A=h.map(b=>{const k=b.zone||b;return!k||!k.id?null:{id:k.id,zoneNumber:k.zoneNumber,name:k.name,cityCorporationId:k.cityCorporationId||0,status:"ACTIVE",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}}).filter(b=>b!==null);console.log("âœ… Formatted Assigned Zones:",A),it(A),A.length===1&&(console.log("ðŸ‘Œ Auto-selecting single zone:",A[0].id),ne(A[0].id))}if((o==null?void 0:o.role)==="ADMIN"){console.log("ðŸ‘¤ Loading assigned wards for Admin");let A=[];if(o.permissions)try{const b=JSON.parse(o.permissions);b.wards&&Array.isArray(b.wards)&&(A=b.wards)}catch(b){console.error("Error parsing admin permissions:",b)}if(console.log(`ðŸ”’ ADMIN assigned ward IDs: [${A.join(", ")}]`),A.length>0)try{const b=o.cityCorporationCode||((S=o.cityCorporation)==null?void 0:S.code);if(b){const Me=(await Ve.getWards({cityCorporationCode:b,status:"ACTIVE"})).wards.filter(Gt=>A.includes(Gt.id));console.log("âœ… Loaded assigned wards:",Me),Z(Me)}}catch(b){console.error("âŒ Error fetching assigned wards:",b),Z([])}else console.log("âš ï¸ ADMIN has no assigned wards"),Z([])}}catch(l){console.error("âŒ Error in AllComplaints fetchData:",l)}finally{Ae(!1)}})()},[o]),n.useEffect(()=>{(o==null?void 0:o.role)!=="ADMIN"&&(console.log("ðŸ”„ useEffect triggered for selectedZone:",z),z?(console.log("ðŸš€ Calling fetchWards with zoneId:",z),wt(z)):Z([]),ie(null))},[z,o]);const wt=async t=>{try{console.log("ðŸ“¡ fetchWards called for zoneId:",t),Ie(!0);const a=await Ve.getWardsByZone(t,"ACTIVE");console.log("âœ… Wards fetched:",a),Z(a)}catch(a){console.error("Error fetching wards:",a),Ce("Failed to load wards")}finally{Ie(!1)}},_=n.useCallback(async()=>{var t,a,p,S,l,m;try{I(!0),R(null),i(null),w(!1);const h={};P!=="ALL"&&(h.status=P),le&&(h.search=le),H&&(h.category=H),U&&(h.subcategory=U),L!=="ALL"&&(L==="OTHERS_ALL"?h.status="OTHERS":L==="CORPORATION_INTERNAL"?(h.status="OTHERS",h.othersCategory="CORPORATION_INTERNAL"):L==="CORPORATION_EXTERNAL"?(h.status="OTHERS",h.othersCategory="CORPORATION_EXTERNAL"):(h.status="OTHERS",h.othersSubcategory=L)),W!=="ALL"&&(h.complaintCityCorporationCode=W),z&&(h.complaintZoneId=z),Q&&(h.complaintWardId=Q),ee&&(h.startDate=ee),ue&&(h.endDate=ue),console.log("Fetching complaints with params:",{page:v.page,limit:v.limit,filters:h});const j=await Ke.getComplaints(v.page,v.limit,h);console.log("Complaints fetched successfully:",j),f(j.complaints),Oe(j.statusCounts||{total:0,pending:0,inProgress:0,resolved:0,rejected:0,others:0}),N({page:((t=j.pagination)==null?void 0:t.page)||1,limit:((a=j.pagination)==null?void 0:a.limit)||20,total:((p=j.pagination)==null?void 0:p.total)||0,totalPages:((S=j.pagination)==null?void 0:S.totalPages)||0})}catch(h){console.error("Error fetching complaints:",h),console.error("Error response:",(l=h.response)==null?void 0:l.data),console.error("Error status:",(m=h.response)==null?void 0:m.status),Je(h,"fetchComplaints");const j=Xe(h);R(j.userMessage),i(j.type),w(j.retryable),j.type===Ue.NETWORK?qe(j.userMessage):Ce(j.userMessage)}finally{I(!1)}},[v.page,v.limit,P,H,U,L,W,z,Q,le,ee,ue]);n.useEffect(()=>{_()},[_]);const Rt=(t,a)=>{N(p=>({...p,page:a})),window.scrollTo({top:0,behavior:"smooth"})},ze=t=>{ye(t),t==="OTHERS"?(oe(""),q("")):ae("ALL"),N(a=>({...a,page:1}))},vt=t=>{be(t.target.value),N(a=>({...a,page:1}))},Tt=t=>{oe(t),q(""),N(a=>({...a,page:1}))},Nt=t=>{q(t),N(a=>({...a,page:1}))},De=t=>{ae(t),N(a=>({...a,page:1}))},Lt=t=>{t.stopPropagation(),ve(t.currentTarget),Te(!0)},Pe=()=>{ve(null),Te(!1),Ne(!1),Le(!1)},ge=t=>{De(t),ze("OTHERS"),["CORPORATION_INTERNAL","CORPORATION_EXTERNAL"].includes(t)||Pe()},zt=t=>{K(t),N(a=>({...a,page:1}))},Dt=t=>{ne(t),N(a=>({...a,page:1}))},Pt=t=>{ie(t),N(a=>({...a,page:1}))},Wt=()=>{be(""),ye("ALL"),oe(""),q(""),ae("ALL"),K("ALL"),K("ALL"),ne(""),ie(null),N(t=>({...t,page:1}))},We=n.useCallback(async(t,a)=>{try{Re(t);const p=await Ke.updateComplaintStatus(t,{status:a});f(S=>S.map(l=>l.id===t?p:l)),Oe(S=>{const l=g.find(h=>h.id===t);if(!l)return S;const m={...S};return l.status==="PENDING"?m.pending=Math.max(0,m.pending-1):l.status==="IN_PROGRESS"?m.inProgress=Math.max(0,m.inProgress-1):l.status==="RESOLVED"?m.resolved=Math.max(0,m.resolved-1):l.status==="REJECTED"?m.rejected=Math.max(0,m.rejected-1):l.status==="OTHERS"&&(m.others=Math.max(0,m.others-1)),a==="PENDING"?m.pending+=1:a==="IN_PROGRESS"?m.inProgress+=1:a==="RESOLVED"?m.resolved+=1:a==="REJECTED"?m.rejected+=1:a==="OTHERS"&&(m.others+=1),m}),Ns("Complaint status updated successfully")}catch(p){Je(p,"handleStatusUpdate");const S=Xe(p);S.type===Ue.NETWORK?qe(S.userMessage):Ce(S.userMessage)}finally{Re(null)}},[g]),kt=t=>{d(`/complaints/${t}`)},ke=()=>{ct(!1),ht(null)},Mt=n.useCallback(t=>{Y&&(f(a=>a.map(p=>p.id===Y?{...p,status:t}:p)),_())},[Y,_]),Ft=t=>{xt(t.id),pt(`${t.user.firstName} ${t.user.lastName}`),ft(t.category||t.title),we(!0)},_t=t=>{ke(),d(`/chats/${t}`)},$t=n.useCallback(async(t,a)=>{await We(t,a),_()},[We,_]),Ht=t=>{switch(t){case"PENDING":return{backgroundColor:"#fff3cd",color:"#856404",borderColor:"#ffeeba"};case"IN_PROGRESS":return{backgroundColor:"#d1ecf1",color:"#0c5460",borderColor:"#bee5eb"};case"RESOLVED":return{backgroundColor:"#d4edda",color:"#155724",borderColor:"#c3e6cb"};case"REJECTED":return{backgroundColor:"#f8d7da",color:"#721c24",borderColor:"#f5c6cb"};default:return{backgroundColor:"#f8f9fa",color:"#6c757d"}}},Zt=t=>{switch(t){case"PENDING":return"Pending";case"IN_PROGRESS":return"In Progress";case"RESOLVED":return"Solved";case"REJECTED":return"Others";default:return t}},Bt=t=>{var S;let a="N/A",p="N/A";if((S=t.locationDetails)!=null&&S.ward)a=t.locationDetails.ward,/^\d+$/.test(a.trim())&&(a=`Ward ${a}`);else if(t.location){const l=t.location.match(/Ward[\s\W]+(\d+)/i);l&&(a=`Ward ${l[1]}`)}if((a==="N/A"||a==="Ward undefined")&&t.wards){const l=t.wards;l.wardNumber||l.number?a=`Ward ${l.wardNumber||l.number}`:l.displayName&&(a=l.displayName)}if(t.location){const l=t.location.match(/Zone[\s\W]+(\d+)/i),m=t.location.match(/à¦…à¦žà§à¦šà¦²[\s\W]+([\w\u0980-\u09FF]+)/u);l?p=`Zone ${l[1]}`:m&&(p=`Zone ${m[1]}`)}if((p==="N/A"||p==="Zone undefined")&&t.zone){const l=t.zone;l.name?p=l.name:l.zoneNumber?p=`Zone ${l.zoneNumber}`:l.displayName&&(p=l.displayName)}return{ward:a,zone:p}};return e.jsxs(Os,{title:"All Complaints",children:[e.jsx(ws,{loading:E}),e.jsxs(x,{sx:{p:{xs:2,md:3},backgroundColor:"#f9fafb",minHeight:"100vh"},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(c,{variant:"h5",sx:{fontWeight:700,color:"#1e2939"},children:["All Complaints",v.total>0&&e.jsxs(c,{component:"span",variant:"body1",sx:{color:"#6b7280",ml:1.5,fontWeight:500},children:["(Total ",v.total,")"]})]}),e.jsx(M,{variant:"contained",onClick:()=>Ct(!ce),startIcon:e.jsx(ss,{}),sx:{backgroundColor:"#4CAF50",textTransform:"none","&:hover":{backgroundColor:"#45a049"}},children:ce?"Hide Filters":"Show Filters"})]}),e.jsx(x,{sx:{borderBottom:1,borderColor:"divider",mb:3},children:e.jsxs(rs,{value:P==="ALL"?"ALL":P,onChange:(t,a)=>ze(a),variant:"scrollable",scrollButtons:"auto",sx:{"& .MuiTab-root":{textTransform:"none",minWidth:100,fontWeight:600}},children:[e.jsx(G,{label:`All (${B.total})`,value:"ALL"}),e.jsx(G,{label:`Pending (${B.pending})`,value:"PENDING"}),e.jsx(G,{label:`In Progress (${B.inProgress})`,value:"IN_PROGRESS"}),e.jsx(G,{label:`Solved (${B.resolved})`,value:"RESOLVED"}),e.jsx(G,{label:e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:.5},children:[`Others (${B.others})`,e.jsx(x,{component:"span",onClick:Lt,sx:{display:"flex",alignItems:"center",borderRadius:"50%",p:.5,"&:hover":{bgcolor:"rgba(0,0,0,0.05)"}},children:e.jsx(me,{fontSize:"small"})})]}),value:"OTHERS"})]})}),e.jsxs(os,{anchorEl:jt,open:St,onClose:Pe,onClick:t=>t.stopPropagation(),PaperProps:{sx:{mt:1,width:250,maxHeight:400}},children:[e.jsx(C,{onClick:()=>ge("OTHERS_ALL"),children:"All Others"}),e.jsx(V,{}),e.jsxs(C,{onClick:()=>Ne(!de),sx:{fontWeight:"bold",justifyContent:"space-between"},children:["Corp. Internal",e.jsx(me,{sx:{transform:de?"rotate(180deg)":"rotate(0deg)",transition:"0.2s"}})]}),de&&["Engineering","Electricity","Health","Property (Eviction)"].map(t=>e.jsx(C,{onClick:()=>ge(t),sx:{pl:4,fontSize:"0.9rem"},selected:L===t,children:t},t)),e.jsx(V,{}),e.jsxs(C,{onClick:()=>Le(!he),sx:{fontWeight:"bold",justifyContent:"space-between"},children:["Corp. External",e.jsx(me,{sx:{transform:he?"rotate(180deg)":"rotate(0deg)",transition:"0.2s"}})]}),he&&["WASA","Titas","DPDC","DESCO","BTCL","Fire Service","Others"].map(t=>e.jsx(C,{onClick:()=>ge(t),sx:{pl:4,fontSize:"0.9rem"},selected:L===t,children:t},t))]}),e.jsx(as,{in:ce,children:e.jsxs($e,{elevation:0,sx:{p:3,mb:3,borderRadius:2,border:"1px solid #e5e7eb",backgroundColor:"white"},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(c,{variant:"subtitle1",sx:{fontWeight:600,color:"#374151"},children:"Filter Options"}),e.jsx(M,{size:"small",onClick:Wt,startIcon:e.jsx(ns,{}),sx:{textTransform:"none",color:"#ef4444"},children:"Clear Filters"})]}),e.jsxs(D,{container:!0,spacing:2,children:[e.jsx(D,{size:{xs:12,sm:6,md:3},children:e.jsx(He,{fullWidth:!0,type:"date",size:"small",label:"Date",value:ee,onChange:t=>bt(t.target.value),InputLabelProps:{shrink:!0},sx:{backgroundColor:"white"}})}),e.jsx(D,{size:{xs:12,sm:6,md:3},children:e.jsxs(J,{fullWidth:!0,size:"small",children:[e.jsx(Ze,{children:"All City Corporations"}),e.jsxs(X,{value:W||"",onChange:t=>zt(t.target.value),label:"All City Corporations",disabled:(o==null?void 0:o.role)==="ADMIN",children:[e.jsx(C,{value:"ALL",children:"All City Corporations"}),ot.map(t=>e.jsx(C,{value:t.code,children:t.name},t.id))]})]})}),(o==null?void 0:o.role)!=="ADMIN"&&e.jsx(D,{size:{xs:12,sm:6,md:3},children:e.jsx(Rs,{value:z,onChange:Dt,cityCorporationCode:W!=="ALL"?W:void 0,zones:(o==null?void 0:o.role)==="SUPER_ADMIN"?nt:void 0,hideLabel:!1,label:"All Zones"})}),e.jsx(D,{size:{xs:12,sm:6,md:3},children:e.jsxs(J,{fullWidth:!0,size:"small",children:[e.jsx(Ze,{children:"All Wards"}),e.jsxs(X,{value:Q||"",onChange:t=>Pt(t.target.value?Number(t.target.value):null),label:"All Wards",displayEmpty:!0,children:[e.jsx(C,{value:"",children:"All Wards"}),Ee&&Ee.map(t=>e.jsxs(C,{value:t.id,children:["Ward ",t.wardNumber||t.id]},t.id))]})]})}),P!=="OTHERS"&&e.jsx(D,{size:{xs:12,sm:6,md:3},children:e.jsx(Ms,{value:H,onChange:Tt})}),P!=="OTHERS"&&e.jsx(D,{size:{xs:12,sm:6,md:3},children:e.jsx(Fs,{value:U,onChange:Nt,categoryId:H,fullWidth:!0})}),P==="OTHERS"&&e.jsx(D,{size:{xs:12,sm:6,md:3},children:e.jsx(_s,{value:L,onChange:De,fullWidth:!0})}),e.jsx(D,{size:{xs:12},children:e.jsx(He,{fullWidth:!0,placeholder:"Search by ID, citizen name, or phone number...",value:Se,onChange:vt,InputProps:{startAdornment:e.jsx(re,{position:"start",children:e.jsx(is,{sx:{color:"text.secondary"}})})},size:"small",sx:{backgroundColor:"white","& .MuiOutlinedInput-root":{fontSize:"0.95rem"}}})})]})]})}),e.jsxs(x,{sx:{display:"flex",justifyContent:"flex-end",mb:2,gap:1},children:[e.jsx(M,{startIcon:e.jsx(ls,{}),variant:"outlined",size:"small",sx:{color:"#1976d2",borderColor:"#1976d2"},children:"Download"}),e.jsx(M,{startIcon:e.jsx(cs,{}),variant:"outlined",size:"small",sx:{color:"#9c27b0",borderColor:"#9c27b0"},children:"Print"})]}),!E&&!O&&e.jsx(ds,{component:$e,elevation:0,sx:{border:"1px solid #e0e0e0",borderRadius:2},children:e.jsxs(hs,{sx:{minWidth:800},children:[e.jsx(us,{sx:{backgroundColor:"#f9fafb"},children:e.jsxs(fe,{children:[e.jsx(y,{sx:{fontWeight:600},children:"Complaint No"}),e.jsx(y,{sx:{fontWeight:600},children:"Citizen Info"}),e.jsx(y,{sx:{fontWeight:600},children:"Location"}),e.jsx(y,{sx:{fontWeight:600},children:"Category"}),e.jsx(y,{sx:{fontWeight:600},children:"Status"}),e.jsx(y,{sx:{fontWeight:600},children:"Review & Report"}),e.jsx(y,{sx:{fontWeight:600},children:"Date"}),e.jsx(y,{align:"right",sx:{fontWeight:600},children:"Action"})]})}),e.jsx(xs,{children:g.length===0?e.jsx(fe,{children:e.jsx(y,{colSpan:7,align:"center",sx:{py:8},children:e.jsx(c,{color:"text.secondary",children:"No complaints found"})})}):g.map(t=>e.jsxs(fe,{hover:!0,children:[e.jsx(y,{children:e.jsx(c,{variant:"body2",sx:{fontWeight:600,color:"#4CAF50"},children:t.trackingNumber||`C${String(t.id).padStart(6,"0")}`})}),e.jsx(y,{children:e.jsxs(x,{children:[e.jsxs(c,{variant:"body2",sx:{fontWeight:600},children:[t.user.firstName," ",t.user.lastName]}),e.jsx(c,{variant:"caption",color:"text.secondary",children:t.user.phone||"N/A"})]})}),e.jsx(y,{children:e.jsxs(x,{children:[e.jsx(c,{variant:"body2",children:t.location}),e.jsx(c,{variant:"caption",color:"text.secondary",children:(()=>{const a=Bt(t);return`${a.zone} | ${a.ward}`})()})]})}),e.jsx(y,{children:e.jsxs(x,{children:[e.jsx(c,{variant:"body2",children:t.category||"N/A"}),e.jsx(c,{variant:"caption",color:"text.secondary",children:t.subcategory})]})}),e.jsxs(y,{children:[e.jsx(Be,{label:Zt(t.status),size:"small",sx:{...Ht(t.status),fontWeight:500,borderRadius:1,height:24}}),(t.status==="OTHERS"||t.status==="REJECTED")&&(t.othersCategory||t.othersSubcategory)&&e.jsxs(x,{sx:{mt:.5,lineHeight:1.2},children:[t.othersCategory&&e.jsx(c,{variant:"caption",display:"block",sx:{fontWeight:600,fontSize:"0.7rem",color:"#4b5563"},children:t.othersCategory==="CORPORATION_INTERNAL"?"Corp. Internal":t.othersCategory==="CORPORATION_EXTERNAL"?"Corp. External":t.othersCategory}),t.othersSubcategory&&e.jsx(c,{variant:"caption",display:"block",sx:{color:"text.secondary",fontSize:"0.7rem"},children:t.othersSubcategory})]})]}),e.jsx(y,{children:["RESOLVED","OTHERS","REJECTED"].includes(t.status)?e.jsxs(x,{sx:{maxWidth:200},children:[t.resolutionNote&&e.jsx(Ge,{title:"Click to view full note",children:e.jsxs(c,{variant:"caption",display:"block",sx:{color:"#1976d2",fontWeight:500,mb:.5,cursor:"pointer","&:hover":{textDecoration:"underline"}},noWrap:!0,onClick:()=>{At(t.resolutionNote||""),Ot("Admin Resolution Note"),xe(!0)},children:["Admin: ",t.resolutionNote]})}),t.review?e.jsxs(x,{children:[e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(gs,{value:t.review.rating,readOnly:!0,size:"small",sx:{fontSize:"1rem"}}),e.jsxs(c,{variant:"caption",color:"text.secondary",children:["(",t.review.rating,")"]})]}),t.review.comment&&e.jsx(Ge,{title:t.review.comment,children:e.jsxs(c,{variant:"caption",display:"block",color:"text.secondary",noWrap:!0,sx:{mt:.5},children:['"',t.review.comment,'"']})})]}):e.jsx(c,{variant:"caption",color:"text.disabled",sx:{fontStyle:"italic"},children:"Not reviewed yet"})]}):e.jsx(Be,{label:"Unsolved",size:"small",variant:"outlined",sx:{borderColor:"#e0e0e0",color:"#9e9e9e",height:24,fontSize:"0.75rem"}})}),e.jsx(y,{children:e.jsx(c,{variant:"body2",children:new Date(t.createdAt).toLocaleDateString()})}),e.jsxs(y,{align:"right",children:[e.jsx(M,{variant:"outlined",size:"small",startIcon:e.jsx(ps,{}),onClick:()=>Ft(t),sx:{borderColor:"#e0e0e0",color:"text.primary",textTransform:"none",mr:1,"&:hover":{borderColor:"#4CAF50",color:"#4CAF50"}},children:"Chat"}),e.jsx(M,{variant:"contained",size:"small",onClick:()=>kt(t.id),sx:{backgroundColor:"#4CAF50",color:"white",textTransform:"none",boxShadow:"none","&:hover":{backgroundColor:"#45a049",boxShadow:"none"}},children:"View Details"})]})]},t.id))})]})}),E&&e.jsx(x,{sx:{display:"flex",justifyContent:"center",p:4},children:e.jsx(je,{})}),!E&&!O&&g.length>0&&v&&v.total>0&&e.jsx(x,{sx:{mt:{xs:3,sm:4},mb:2,display:"flex",justifyContent:"center"},children:e.jsx(ms,{count:v.totalPages||0,page:v.page||1,onChange:Rt,color:"primary",size:u?"small":"large",showFirstButton:!u,showLastButton:!u,siblingCount:u?0:1,boundaryCount:1,sx:{"& .MuiPaginationItem-root":{fontSize:{xs:"0.875rem",sm:"0.95rem"},"&.Mui-selected":{backgroundColor:"#4CAF50 !important",color:"white"}}}})})]}),e.jsx(zs,{complaintId:dt,open:lt,onClose:ke,onStatusUpdate:$t,onChatOpen:_t}),e.jsx(Ps,{open:ut,onClose:()=>we(!1),complaintId:Y||0,complaintTitle:mt,citizenName:gt,onStatusUpdate:Mt}),e.jsxs(st,{open:yt,onClose:()=>xe(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(fs,{sx:{fontWeight:600,color:"#1f2937"},children:It}),e.jsx(Cs,{dividers:!0,children:e.jsx(c,{variant:"body1",sx:{whiteSpace:"pre-wrap",color:"#374151"},children:Et})}),e.jsx(js,{children:e.jsx(M,{onClick:()=>xe(!1),color:"primary",children:"Close"})})]})]})};export{ar as default};
