var G=Object.defineProperty;var q=(i,e,a)=>e in i?G(i,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[e]=a;var E=(i,e,a)=>q(i,typeof e!="symbol"?e+"":e,a);import{u as H,j as t,B as f,i as J,b1 as X,H as Y,T as y,p as I,J as Z,K as Q}from"./mui-vendor-Brc-2iiC.js";import{r as p}from"./react-vendor-D7yrL1sD.js";import{a as O,E as ee,V as te,M as ae}from"./ErrorDisplay-MT5puO9e.js";import{a as C}from"./query-vendor-CZVuOxbJ.js";import{A as b,x as R,y as v,z as j}from"./index-DBuvollO.js";class se{constructor(){E(this,"apiClient");E(this,"pollingIntervals");E(this,"POLLING_INTERVAL",5e3);this.apiClient=C.create({baseURL:b.BASE_URL,timeout:b.TIMEOUT,withCredentials:!0,headers:{"Content-Type":"application/json"}}),this.pollingIntervals=new Map,this.setupInterceptors()}setupInterceptors(){this.apiClient.interceptors.request.use(e=>{try{const a=localStorage.getItem("accessToken");a&&(e.headers.Authorization=`Bearer ${a}`)}catch(a){console.error("Error getting token:",a)}return e},e=>Promise.reject(e)),this.apiClient.interceptors.response.use(e=>e,e=>{var a;return((a=e.response)==null?void 0:a.status)===401&&window.location.pathname!=="/login"&&window.location.assign("/login"),Promise.reject(e)})}isCloudinaryUrl(e){return!!e&&e.includes("res.cloudinary.com")&&e.includes("/upload/")}transformMediaUrl(e){if(!e)return null;if(this.isCloudinaryUrl(e))return e;if(e.startsWith("http://")||e.startsWith("https://")){if(e.startsWith(b.BASE_URL))return e;const n=/^https?:\/\/[^\/]+/;return e.replace(n,b.BASE_URL)}return`${b.BASE_URL}${e.startsWith("/")?"":"/"}${e}`}getCloudinaryThumbnail(e,a=200,n=200){return e&&(this.isCloudinaryUrl(e)?e.replace("/upload/",`/upload/w_${a},h_${n},c_fill,q_auto,f_auto/`):e)}getOptimizedCloudinaryUrl(e){return e&&(this.isCloudinaryUrl(e)?e.replace("/upload/","/upload/q_auto,f_auto/"):e)}transformMessage(e){return{...e,fileUrl:this.transformMediaUrl(e.fileUrl)||void 0,voiceUrl:this.transformMediaUrl(e.voiceUrl)||void 0}}async getConversations(e){var a,n;try{const r={page:(e==null?void 0:e.page)||1,limit:(e==null?void 0:e.limit)||20};e!=null&&e.cityCorporationCode&&(r.cityCorporationCode=e.cityCorporationCode),e!=null&&e.zoneId&&(r.zoneId=e.zoneId),e!=null&&e.wardId&&(r.wardId=e.wardId),e!=null&&e.unreadOnly&&(r.unreadOnly="true"),e!=null&&e.search&&(r.search=e.search);const x=R.liveChatConversations(JSON.stringify(r)),o=v.get(x);if(o)return o;const m=(await this.apiClient.get("/api/admin/live-chat",{params:r})).data.data;return m.conversations&&(m.conversations=m.conversations.map(h=>({...h,lastMessage:h.lastMessage?this.transformMessage(h.lastMessage):null}))),v.set(x,m,3e4),m}catch(r){throw C.isAxiosError(r)?new Error(((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to fetch conversations"):r}}async getUserMessages(e,a=1,n=50){var r,x;try{const o=R.liveChatMessages(e,a),l=v.get(o);if(l)return l;const h=(await this.apiClient.get(`/api/admin/live-chat/${e}`,{params:{page:a,limit:n}})).data.data;return h.messages&&(h.messages=h.messages.map(M=>this.transformMessage(M))),v.set(o,h,3e4),h}catch(o){throw C.isAxiosError(o)?new Error(((x=(r=o.response)==null?void 0:r.data)==null?void 0:x.message)||"Failed to fetch messages"):o}}async sendMessage(e,a,n){var r,x;try{if(n){const o=new FormData,l=a.trim()||"Image";o.append("message",l),o.append("image",n);const m=localStorage.getItem("accessToken"),h=await C.post(`${b.BASE_URL}/api/admin/live-chat/${e}`,o,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${m}`}});return v.invalidatePattern(`live-chat-messages-${e}`),v.invalidatePattern("live-chat-conversations"),this.transformMessage(h.data.data.message)}else{const o=await this.apiClient.post(`/api/admin/live-chat/${e}`,{message:a});return v.invalidatePattern(`live-chat-messages-${e}`),v.invalidatePattern("live-chat-conversations"),this.transformMessage(o.data.data.message)}}catch(o){throw C.isAxiosError(o)?new Error(((x=(r=o.response)==null?void 0:r.data)==null?void 0:x.message)||"Failed to send message"):o}}async markAsRead(e){var a,n;try{await this.apiClient.patch(`/api/admin/live-chat/${e}/read`),v.invalidatePattern(`live-chat-messages-${e}`),v.invalidatePattern("live-chat-conversations")}catch(r){throw C.isAxiosError(r)?new Error(((n=(a=r.response)==null?void 0:a.data)==null?void 0:n.message)||"Failed to mark messages as read"):r}}async getStatistics(){var e,a;try{const n=R.liveChatStatistics(),r=v.get(n);if(r)return r;const o=(await this.apiClient.get("/api/admin/live-chat/statistics")).data.data;return v.set(n,o,3e4),o}catch(n){throw C.isAxiosError(n)?new Error(((a=(e=n.response)==null?void 0:e.data)==null?void 0:a.message)||"Failed to fetch statistics"):n}}startPolling(e,a){this.stopPolling(e);const n=setInterval(async()=>{try{const{messages:r}=await this.getUserMessages(e);a(r)}catch(r){console.error("Error polling messages:",r)}},this.POLLING_INTERVAL);this.pollingIntervals.set(e,n)}stopPolling(e){const a=this.pollingIntervals.get(e);a&&(clearInterval(a),this.pollingIntervals.delete(e))}stopAllPolling(){this.pollingIntervals.forEach(e=>{clearInterval(e)}),this.pollingIntervals.clear()}getThumbnailUrl(e,a=200,n=200){return this.getCloudinaryThumbnail(e,a,n)}getOptimizedUrl(e){return this.getOptimizedCloudinaryUrl(e)}}const S=new se,de=({userId:i,userInfo:e,onClose:a,onMessagesRead:n})=>{const r=H(),[x,o]=p.useState([]),[l,m]=p.useState(e||null),[h,M]=p.useState(!1),[N,L]=p.useState(null),[F,A]=p.useState(!1),[P,V]=p.useState(!1),[$,T]=p.useState(1),B=p.useRef(null),_=p.useRef(null),k=p.useRef(!1),U=p.useCallback(()=>{var s;(s=B.current)==null||s.scrollIntoView({behavior:"smooth"})},[]),w=p.useCallback(async(s=!1,g=1)=>{if(i)try{M(!0),L(null);const u=await S.getUserMessages(i,g);if(g===1){if(o(u.messages),T(1),u.messages.length>0){const d=u.messages[0],c=d.senderId===i?d.sender:d.receiver;if(c)try{const W=(await S.getConversations({search:c.phone||""})).conversations.find(K=>K.user.id===i);m(W?W.user:{id:c.id,firstName:c.firstName,lastName:c.lastName,avatar:c.avatar,phone:null,ward:null,zone:null})}catch{m({id:c.id,firstName:c.firstName,lastName:c.lastName,avatar:c.avatar,phone:null,ward:null,zone:null})}}}else o(d=>[...u.messages,...d]),T(g);if(V(u.hasMore),g===1&&u.messages.length>0&&!e){const d=u.messages[0],c=d.senderId===i?d.sender:d.receiver;c&&m({id:c.id,firstName:c.firstName,lastName:c.lastName,avatar:c.avatar,phone:null,ward:null,zone:null,cityCorporationCode:null})}g===1&&!k.current&&(await S.markAsRead(i),k.current=!0,n&&n()),g===1&&setTimeout(U,100)}catch(u){const d=u instanceof Error?u.message:"Failed to load messages";L(d),console.error("Error fetching messages:",u),s&&j.error("Failed to load messages. Please try again.",{icon:"âŒ",duration:4e3})}finally{M(!1)}},[i,n,U]);p.useCallback(()=>{if(P&&!h&&i){const s=$+1;w(!1,s)}},[P,h,i,$,w]);const D=p.useCallback(async(s,g)=>{if(!i)return;const u=s.trim();if(!u&&!g){j.error("Please enter a message or attach an image",{icon:"âš ï¸",duration:3e3});return}try{A(!0);const d=u||(g?"Image":"");if(!d&&!g){j.error("Please enter a message",{icon:"âš ï¸",duration:3e3}),A(!1);return}const c=await S.sendMessage(i,d,g);o(z=>[...z,c]),setTimeout(U,100),j.success("Message sent",{icon:"âœ…",duration:2e3})}catch(d){const c=d instanceof Error?d.message:"Failed to send message";console.error("Error sending message:",d),j.error(c,{icon:"âŒ",duration:4e3})}finally{A(!1)}},[i,U]);return p.useEffect(()=>{e&&m(e)},[e]),p.useEffect(()=>{i&&i!==_.current&&(_.current=i,k.current=!1,o([]),e||m(null),T(1),w(!0))},[i,w]),p.useEffect(()=>{if(!i)return;const s=setInterval(()=>{w(!1,1)},5e3);return()=>{clearInterval(s)}},[i,w]),i?N&&!h?t.jsx(ee,{error:N,onRetry:()=>w(!0),variant:"centered"}):t.jsxs(f,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[t.jsxs(f,{sx:{p:2,borderBottom:`1px solid ${r.palette.divider}`,bgcolor:"background.paper",display:"flex",alignItems:"center",gap:2},children:[a&&t.jsx(J,{onClick:a,size:"small",children:t.jsx(X,{})}),l&&t.jsxs(t.Fragment,{children:[t.jsxs(Y,{sx:{width:40,height:40,bgcolor:"primary.main"},children:[l.firstName.charAt(0).toUpperCase(),l.lastName.charAt(0).toUpperCase()]}),t.jsxs(f,{sx:{flex:1,minWidth:0},children:[t.jsxs(y,{variant:"subtitle1",sx:{fontWeight:600},children:[l.firstName," ",l.lastName]}),t.jsxs(f,{sx:{display:"flex",gap:1,flexWrap:"wrap",mt:.5},children:[t.jsx(I,{label:`ID: ${l.id}`,size:"small",variant:"outlined",sx:{fontSize:"0.75rem"}}),l.phone&&t.jsx(I,{icon:t.jsx(Z,{}),label:l.phone,size:"small",variant:"outlined"}),(l.ward||l.zone||l.cityCorporationCode)&&t.jsx(I,{icon:t.jsx(Q,{}),label:[l.cityCorporationCode,l.zone?`Zone ${l.zone.name||l.zone.number}`:null,l.ward?`Ward ${l.ward.wardNumber||l.ward.number}`:null].filter(Boolean).join(", "),size:"small",variant:"outlined"})]})]})]})]}),t.jsx(f,{sx:{flex:1,overflowY:"auto",overflowX:"hidden",bgcolor:"#f5f5f5",p:2},children:h&&x.length===0?t.jsx(f,{sx:{display:"flex",justifyContent:"center",py:4},children:t.jsx(y,{children:"Loading messages..."})}):x.length===0?t.jsx(O,{type:"no-messages"}):t.jsxs(t.Fragment,{children:[x.map(s=>s.senderType==="BOT"?t.jsx(f,{sx:{display:"flex",justifyContent:"center",mb:1.5},children:t.jsxs(f,{sx:{maxWidth:"75%",p:1.5,borderRadius:2,bgcolor:"#f5f5f5",border:"1px solid #e0e0e0",color:"#424242",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.06)",display:"flex",alignItems:"flex-start",gap:1},children:[t.jsx(f,{sx:{bgcolor:"#757575",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,mt:.2},children:t.jsx(y,{sx:{color:"white",fontSize:"0.75rem",fontWeight:"bold"},children:"ðŸ¤–"})}),t.jsxs(f,{sx:{flex:1},children:[t.jsx(y,{variant:"caption",sx:{color:"#757575",fontWeight:600,display:"block",mb:.5,fontSize:"0.75rem"},children:"[BOT] Clean Care Support System"}),t.jsx(y,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.5},children:s.content}),t.jsx(y,{variant:"caption",sx:{display:"block",mt:.5,color:"#9e9e9e",fontSize:"0.7rem"},children:new Date(s.createdAt).toLocaleTimeString()})]})]})},s.id):t.jsx(f,{sx:{display:"flex",justifyContent:s.senderType==="ADMIN"?"flex-end":"flex-start",mb:1.5},children:t.jsxs(f,{sx:{maxWidth:"70%",p:1.5,borderRadius:2,bgcolor:s.senderType==="ADMIN"?"primary.main":"white",color:s.senderType==="ADMIN"?"white":"text.primary",boxShadow:1},children:[s.type==="IMAGE"&&s.fileUrl&&t.jsx(f,{component:"img",src:s.fileUrl,alt:"Message attachment",sx:{maxWidth:"100%",borderRadius:1,mb:s.content?1:0,cursor:"pointer"},onClick:()=>window.open(s.fileUrl,"_blank")}),s.type==="VOICE"&&s.voiceUrl&&t.jsx(f,{sx:{mt:s.content?1:0,mb:s.content?1:0},children:t.jsx(te,{voiceUrl:s.voiceUrl,isAdmin:s.senderType==="ADMIN"})}),s.content&&t.jsx(y,{variant:"body2",children:s.content}),t.jsx(y,{variant:"caption",sx:{display:"block",mt:.5,opacity:.7},children:new Date(s.createdAt).toLocaleTimeString()})]})},s.id)),t.jsx("div",{ref:B})]})}),t.jsx(f,{sx:{borderTop:`1px solid ${r.palette.divider}`,bgcolor:"background.paper"},children:t.jsx(ae,{onSend:async(s,g)=>{await D(s)},onSendWithFile:async(s,g)=>{await D(s,g)},sending:F,disabled:h})})]}):t.jsx(O,{type:"no-messages"})};export{de as L,S as l};
