import{u as ee,o as A,j as o,B as c}from"./mui-vendor-Brc-2iiC.js";import{i as te,d as se,r as t}from"./react-vendor-D7yrL1sD.js";import{z as E,t as U,M as ae}from"./index-DBuvollO.js";import{b as h,C as oe}from"./browserNotifications-CE-oeFv1.js";import{C as ie}from"./ChatListPanel-BdVnR5F5.js";import{C as re}from"./ChatConversationPanel-CG3N1dUy.js";import{E as ne}from"./ErrorDisplay-MT5puO9e.js";import"./query-vendor-CZVuOxbJ.js";import"./chart-vendor-CrjdDA16.js";import"./useDebounce-CcxK0pTh.js";import"./dateUtils-Ct3ZkYaO.js";const ve=()=>{const{complaintId:v}=te(),P=se(),j=ee(),r=A(j.breakpoints.down("md")),T=A(j.breakpoints.between("md","lg")),[Z,m]=t.useState([]),[u,g]=t.useState(null),[p,L]=t.useState(!0),[F,z]=t.useState(null),[x,$]=t.useState(""),[f,q]=t.useState({district:void 0,upazila:void 0,ward:void 0,zone:void 0,cityCorporationCode:void 0,thanaId:void 0,status:void 0,unreadOnly:!1,page:1,limit:20}),[C,S]=t.useState(1),[M,H]=t.useState(!0),[O,Q]=t.useState(0),[R,G]=t.useState({totalChats:0,unreadCount:0,byDistrict:[],byUpazila:[],byWard:[],byZone:[],byStatus:[]}),[W,b]=t.useState(!1),y=t.useRef([]),I=t.useRef(!0);t.useEffect(()=>{if(h.isSupported()&&h.getPermissionStatus()==="default"){const e=setTimeout(()=>{h.requestPermission().then(i=>{i&&console.log("Browser notification permission granted")})},2e3);return()=>clearTimeout(e)}},[]);const N=t.useCallback(e=>{const i=e.citizen.firstName+" "+e.citizen.lastName,s=e.lastMessage.text.length>50?e.lastMessage.text.substring(0,50)+"...":e.lastMessage.text,a=()=>{P(`/chats/${e.complaintId}`),g(e.complaintId),r&&b(!0)};E(n=>o.jsxs(c,{onClick:()=>{E.dismiss(n.id),a()},sx:{cursor:"pointer","&:hover":{opacity:.9}},children:[o.jsxs(c,{sx:{fontWeight:600,mb:.5,color:"#3FA564"},children:["New message from ",i]}),o.jsx(c,{sx:{fontSize:"0.875rem",color:"#666"},children:s}),o.jsxs(c,{sx:{fontSize:"0.75rem",color:"#999",mt:.5},children:["Complaint #",e.trackingNumber]})]}),{duration:6e3,icon:"ðŸ’¬",style:{background:"#fff",color:"#333",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",borderLeft:"4px solid #3FA564",padding:"16px",maxWidth:"400px"}}),h.hasPermission()&&!document.hasFocus()&&h.showNewMessageNotification(i,`${s}

Complaint #${e.trackingNumber}`,e.complaintId,e.trackingNumber,a)},[P,r]),D=t.useCallback(e=>{if(I.current){I.current=!1,y.current=e;return}const i=y.current;e.forEach(s=>{const a=i.find(n=>n.complaintId===s.complaintId);a?s.lastMessage&&a.lastMessage&&s.lastMessage.id!==a.lastMessage.id&&s.lastMessage.senderType==="CITIZEN"&&s.complaintId!==u&&N(s):s.lastMessage&&s.lastMessage.senderType==="CITIZEN"&&N(s)}),y.current=e},[u,N]),l=t.useCallback(async(e=!1,i,s=!1)=>{try{s||L(!0),z(null);const a=i||C,n={...f,search:x||void 0,page:a,limit:20},d=await U.getChatConversationsWithPagination(n);a===1&&!s&&D(d.chats),m(s?_=>[..._,...d.chats]:d.chats),d.pagination&&(S(d.pagination.page),Q(d.pagination.total),H(d.pagination.hasNextPage))}catch(a){const n=a instanceof Error?a.message:"Failed to load chats";z(n),console.error("Error fetching chat list:",a),e&&E.error("Failed to load chats. Please check your connection.",{icon:"âŒ",duration:4e3})}finally{L(!1)}},[f,x,D,C]),J=t.useCallback(()=>{if(M&&!p){const e=C+1;S(e),l(!1,e,!0)}},[M,p,C,l]),w=t.useCallback(async()=>{try{const e=await U.getChatStatistics();G(e)}catch(e){console.error("Error fetching statistics:",e)}},[]);t.useEffect(()=>{l(!0),w()},[]),t.useEffect(()=>{if(I.current)return;const e=setTimeout(()=>{l(!1)},500);return()=>clearTimeout(e)},[f,x]),t.useEffect(()=>{if(v){const e=parseInt(v,10);isNaN(e)||(g(e),r&&b(!0))}},[v,r]),t.useEffect(()=>{const e=setInterval(()=>{l(!1),w()},1e4);return()=>{clearInterval(e)}},[]);const K=e=>{g(e),r&&b(!0)},V=()=>{b(!1),g(null)},X=e=>{m(i=>i.map(s=>s.complaintId===u?{...s,complaintStatus:e}:s))},Y=e=>{$(e)},B=e=>{q(i=>({...i,...e})),S(1),m([])},k=r?{filter:"0%",list:"100%",conversation:"100%"}:T?{filter:"0%",list:"40%",conversation:"60%"}:{filter:"20%",list:"30%",conversation:"50%"};return o.jsx(ae,{title:"Messages",children:o.jsxs(c,{sx:{display:"flex",height:"calc(100vh - 140px)",gap:2,overflow:"hidden"},children:[!r&&!T&&o.jsx(c,{sx:{width:k.filter,display:"flex",flexDirection:"column",overflow:"hidden"},children:o.jsx(oe,{filters:f,onFilterChange:B,statistics:R})}),(!r||!W)&&o.jsx(c,{sx:{width:k.list,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:F&&!p?o.jsx(ne,{error:F,onRetry:()=>l(!0),variant:"centered"}):o.jsx(ie,{chats:Z,selectedChatId:u,onChatSelect:K,searchTerm:x,onSearchChange:Y,filters:f,onFilterChange:B,statistics:R,loading:p,hasMore:M,onLoadMore:J,totalChats:O})}),(!r||W)&&o.jsx(c,{sx:{width:k.conversation,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:o.jsx(re,{complaintId:u,onClose:r?V:void 0,onMessagesRead:()=>{l(!1),w()},onStatusUpdate:X})})]})})};export{ve as default};
