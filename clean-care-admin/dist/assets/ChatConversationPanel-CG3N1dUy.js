var Lt=Object.defineProperty;var Bt=(a,t,s)=>t in a?Lt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s;var pe=(a,t,s)=>Bt(a,typeof t!="symbol"?t+"":t,s);import{u as Me,o as le,j as e,s as kt,t as Rt,T as u,i as H,v as Ce,w as Nt,az as ce,_ as dt,av as ut,$ as ht,a1 as He,B as l,bw as xt,g as Ft,b as X,x as Ot,G as We,p as be,M as mt,bx as Ht,by as Vt,bz as _t,bA as Gt,bB as Jt,bC as Zt,bD as Kt,C as De,A as pt,aI as Xt,D as se,K as zt,b3 as gt,J as At,h as Dt,b2 as qt,bE as Yt,b0 as Qt,aY as ft,aZ as bt,bF as es,bG as ts,bH as ss,bI as rs,bJ as os,bK as as,an as ns,aT as yt,y as Ct,aV as is,bL as cs,bM as ls,b4 as ds,bu as us,bv as hs,H as xs,aL as ms,aM as ps,aS as gs,l as fs,bN as bs,aR as ys,bO as Cs,bP as js,bQ as ws,bR as vs,b1 as jt}from"./mui-vendor-Brc-2iiC.js";import{r as h,a as Ss}from"./react-vendor-D7yrL1sD.js";import{A as ee,v as Is,h as Le,f as Ve,a as M,s as _e,b as Es,j as ks,w as wt,z as Z,t as ge}from"./index-DBuvollO.js";import{a as te}from"./query-vendor-CZVuOxbJ.js";import{V as Rs,a as Ns,E as Os,M as zs}from"./ErrorDisplay-MT5puO9e.js";class As{constructor(){pe(this,"apiClient");this.apiClient=te.create({baseURL:ee.BASE_URL,timeout:ee.TIMEOUT,withCredentials:!0,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}setupInterceptors(){this.apiClient.interceptors.request.use(t=>{try{const s=localStorage.getItem("accessToken");s&&(t.headers.Authorization=`Bearer ${s}`)}catch(s){console.error("Error getting token:",s)}return t},t=>Promise.reject(t)),this.apiClient.interceptors.response.use(t=>t,t=>{var s;return((s=t.response)==null?void 0:s.status)===401&&window.location.pathname!=="/login"&&window.location.assign("/login"),Promise.reject(this.handleError(t))})}handleError(t){var s,r,n,c,i;if(te.isAxiosError(t)){const f=((s=t.response)==null?void 0:s.status)||500,g=((n=(r=t.response)==null?void 0:r.data)==null?void 0:n.message)||"An error occurred",d=(i=(c=t.response)==null?void 0:c.data)==null?void 0:i.errors;return{name:"ApiError",statusCode:f,message:g,errors:d}}return{name:"ApiError",statusCode:500,message:t.message||"An unexpected error occurred"}}isCloudinaryUrl(t){return!!t&&t.includes("res.cloudinary.com")&&t.includes("/upload/")}fixLocalMediaUrl(t){if(!t||this.isCloudinaryUrl(t)||t.startsWith(ee.BASE_URL))return t;const s=/^https?:\/\/[^\/]+/;return s.test(t)?t.replace(s,ee.BASE_URL):t.startsWith("/")?`${ee.BASE_URL}${t}`:`${ee.BASE_URL}/${t}`}getCloudinaryThumbnail(t,s=200,r=200){return t&&(this.isCloudinaryUrl(t)?t.replace("/upload/",`/upload/w_${s},h_${r},c_fill,q_auto,f_auto/`):t)}getOptimizedCloudinaryUrl(t){return t&&(this.isCloudinaryUrl(t)?t.replace("/upload/","/upload/q_auto,f_auto/"):t)}parseMediaUrls(t){let s=[],r=[];try{if(t.imageUrl){let n;const c=t.imageUrl;if(typeof c=="string"&&c.trim().startsWith("["))try{n=JSON.parse(c)}catch{n=[c]}else Array.isArray(c)?n=c:n=[c];Array.isArray(n)&&(s=n.map(i=>this.fixLocalMediaUrl(i)))}}catch(n){console.error("Error processing imageUrl:",n)}try{if(t.audioUrl){let n;const c=t.audioUrl;if(typeof c=="string"&&c.trim().startsWith("["))try{n=JSON.parse(c)}catch{n=[c]}else Array.isArray(c)?n=c:n=[c];Array.isArray(n)&&(r=n.map(i=>this.fixLocalMediaUrl(i)))}}catch(n){console.error("Error processing audioUrl:",n)}return{...t,imageUrls:s,audioUrls:r}}async getComplaints(t=1,s=20,r){try{const n={page:t,limit:s};r&&(r.search&&(n.search=r.search),r.status&&r.status!=="ALL"&&(n.status=r.status),r.category==="uncategorized"?n.category="null":r.category&&(n.category=r.category),r.subcategory&&(n.subcategory=r.subcategory),r.complaintCityCorporationCode&&(n.complaintCityCorporationCode=r.complaintCityCorporationCode),r.complaintZoneId&&(n.complaintZoneId=r.complaintZoneId),r.complaintWardId&&(n.complaintWardId=r.complaintWardId),r.cityCorporationCode&&(n.cityCorporationCode=r.cityCorporationCode),r.zoneId&&(n.zoneId=r.zoneId),r.wardId&&(n.wardId=r.wardId),r.ward&&(n.ward=r.ward),r.thanaId&&(n.thanaId=r.thanaId),r.startDate&&(n.startDate=r.startDate),r.endDate&&(n.endDate=r.endDate),r.sortBy&&(n.sortBy=r.sortBy),r.sortOrder&&(n.sortOrder=r.sortOrder));const c=await this.apiClient.get("/api/admin/complaints",{params:n});if(!c.data||!c.data.data)throw console.error("Invalid response structure:",c.data),new Error("Invalid response structure from server");const i=c.data.data;if(!Array.isArray(i.complaints))throw console.error("Complaints is not an array:",i),new Error("Invalid complaints data from server");const f=i.complaints.map(g=>this.parseMediaUrls(g));return{...i,complaints:f}}catch(n){throw console.error("Error in getComplaints:",n),n}}async getComplaintById(t){try{const s=await this.apiClient.get(`/api/admin/complaints/${t}`);return this.parseMediaUrls(s.data.data.complaint)}catch(s){throw s}}async updateComplaintStatus(t,s){try{if(s.resolutionImageFiles&&s.resolutionImageFiles.length>0){const r=new FormData;r.append("status",s.status),s.note&&r.append("note",s.note),s.resolutionImages&&r.append("resolutionImages",s.resolutionImages),s.resolutionNote&&r.append("resolutionNote",s.resolutionNote),s.category&&r.append("category",s.category),s.subcategory&&r.append("subcategory",s.subcategory),s.resolutionImageFiles.forEach(c=>{r.append("resolutionImages",c)});const n=await this.apiClient.patch(`/api/admin/complaints/${t}/status`,r,{headers:{"Content-Type":"multipart/form-data"}});return this.parseMediaUrls(n.data.data.complaint)}else{const r=await this.apiClient.patch(`/api/admin/complaints/${t}/status`,s);return this.parseMediaUrls(r.data.data.complaint)}}catch(r){throw r}}async markComplaintAsOthers(t,s){try{const r=new FormData;r.append("othersCategory",s.othersCategory),r.append("othersSubcategory",s.othersSubcategory),s.note&&r.append("note",s.note),s.images&&s.images.length>0&&s.images.forEach(i=>{r.append("images",i)});const n=await this.apiClient.patch(`/api/admin/complaints/${t}/mark-others`,r,{headers:{"Content-Type":"multipart/form-data"}});return this.parseMediaUrls(n.data.data.complaint)}catch(r){throw r}}async updateComplaintStatusWithResolution(t,s,r,n){try{const c=new FormData;c.append("status",s),r&&c.append("resolutionNote",r),n&&n.length>0&&n.forEach(g=>{c.append("resolutionImages",g)});const i=await this.apiClient.patch(`/api/admin/complaints/${t}/status`,c,{headers:{"Content-Type":"multipart/form-data"}});return this.parseMediaUrls(i.data.data.complaint)}catch(c){throw c}}async searchComplaints(t,s=1,r=20){try{return await this.getComplaints(s,r,{search:t})}catch(n){throw n}}async getComplaintsByUser(t,s=1,r=20){try{const n=await this.apiClient.get(`/api/admin/users/${t}/complaints`,{params:{page:s,limit:r}}),c=n.data.data.complaints.map(i=>this.parseMediaUrls(i));return{...n.data.data,complaints:c}}catch(n){throw n}}getThumbnailUrl(t,s=200,r=200){return this.getCloudinaryThumbnail(t,s,r)}getOptimizedUrl(t){return this.getOptimizedCloudinaryUrl(t)}async uploadImage(t){try{const s=new FormData;s.append("images",t);const r=await this.apiClient.post("/api/uploads",s,{headers:{"Content-Type":"multipart/form-data"}});if(r.data.success&&r.data.data.fileUrls.length>0)return r.data.data.fileUrls[0];throw new Error("Failed to upload image")}catch(s){throw console.error("Error uploading image:",s),s}}async getOthersAnalytics(t={}){try{const s={};return t.cityCorporationCode&&(s.cityCorporationCode=t.cityCorporationCode),t.zoneId!==void 0&&(s.zoneId=t.zoneId),t.startDate&&(s.startDate=t.startDate),t.endDate&&(s.endDate=t.endDate),(await this.apiClient.get("/api/admin/complaints/analytics/others",{params:s})).data.data}catch(s){throw console.error("Error fetching Others analytics:",s),s}}async updateComplaintAudioUrls(t,s){try{const r=await this.apiClient.patch(`/api/admin/complaints/${t}/audio-urls`,{audioUrls:s});return this.parseMediaUrls(r.data.data.complaint)}catch(r){throw r}}}const Te=new As,Be={CORPORATION_INTERNAL:{label:"Corporation Internal",description:"Issues within city corporation jurisdiction handled by specific departments"},CORPORATION_EXTERNAL:{label:"Corporation External",description:"Issues outside city corporation jurisdiction handled by external agencies"}},Ds={CORPORATION_INTERNAL:["Engineering","Electricity","Health","Property (Eviction)"],CORPORATION_EXTERNAL:["WASA","Titas","DPDC","DESCO","BTCL","Fire Service","Others"]},Ts=({open:a,onClose:t,onConfirm:s,loading:r=!1})=>{const n=Me(),c=le(n.breakpoints.down("sm")),[i,f]=h.useState(""),[g,d]=h.useState(""),[o,y]=h.useState(""),[p,v]=h.useState([]),[C,w]=h.useState({category:!1,subCategory:!1,note:!1}),S=b=>{f(b),d(""),w({...C,category:!0,subCategory:!1})},E=b=>{if(b.target.files){const k=Array.from(b.target.files),U=[...p,...k].slice(0,5);v(U)}},P=b=>{v(p.filter((k,U)=>U!==b))},T=()=>{if(!i){w({...C,category:!0});return}if(!g){w({...C,subCategory:!0});return}if(!o||o.length<20){w({...C,note:!0});return}s(i,g,o,p)},O=()=>{r||(f(""),d(""),y(""),v([]),w({category:!1,subCategory:!1,note:!1}),t())},D=i?Ds[i]||[]:[];return e.jsxs(kt,{open:a,onClose:O,maxWidth:"sm",fullWidth:!0,fullScreen:c,PaperProps:{sx:{borderRadius:c?0:2}},children:[e.jsxs(Rt,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:2,borderBottom:"1px solid #e0e0e0"},children:[e.jsx(u,{variant:"h6",sx:{fontWeight:600},children:"Mark as Others"}),e.jsx(H,{onClick:O,disabled:r,size:"small",sx:{color:"text.secondary","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"}},children:e.jsx(Ce,{})})]}),e.jsx(Nt,{sx:{pt:3,pb:2},children:e.jsxs(ce,{container:!0,spacing:3,children:[e.jsx(ce,{size:12,children:e.jsxs(dt,{fullWidth:!0,error:C.category&&!i,required:!0,children:[e.jsx(ut,{children:"Select Category"}),e.jsx(ht,{value:i,label:"Select Category",onChange:b=>S(b.target.value),disabled:r,children:Object.keys(Be).map(b=>e.jsx(He,{value:b,children:e.jsxs(l,{children:[e.jsx(u,{variant:"body1",children:Be[b].label}),e.jsx(u,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:Be[b].description})]})},b))}),C.category&&!i&&e.jsx(xt,{children:"Please select a category"})]})}),i&&D.length>0&&e.jsx(ce,{size:12,children:e.jsxs(dt,{fullWidth:!0,error:C.subCategory&&!g,required:!0,children:[e.jsx(ut,{children:"Select Department/Agency"}),e.jsx(ht,{value:g,label:"Select Department/Agency",onChange:b=>{d(b.target.value),w({...C,subCategory:!0})},disabled:r,children:D.map(b=>e.jsx(He,{value:b,children:b},b))}),C.subCategory&&!g&&e.jsx(xt,{children:"Please select a department/agency"})]})}),e.jsx(ce,{size:12,children:e.jsx(Ft,{fullWidth:!0,label:"Note (Required)",required:!0,multiline:!0,rows:3,value:o,onChange:b=>{y(b.target.value),b.target.value.length>=20&&w({...C,note:!1})},onBlur:()=>w({...C,note:!0}),disabled:r,placeholder:"Add reason for marking as Others (min 20 characters)...",helperText:C.note&&(!o||o.length<20)?`Minimum 20 characters required (${o.length}/20)`:`${o.length}/500 characters`,error:C.note&&(!o||o.length<20),inputProps:{maxLength:500}})}),e.jsxs(ce,{size:12,children:[e.jsxs(l,{sx:{mb:1},children:[e.jsx(u,{variant:"subtitle2",sx:{mb:.5},children:"Attach Images (Optional)"}),e.jsx(u,{variant:"caption",color:"text.secondary",children:"Max 5 images. Supported formats: JPEG, PNG, WebP."})]}),e.jsx("input",{accept:"image/jpeg,image/png,image/webp",style:{display:"none"},id:"mark-others-image-upload",multiple:!0,type:"file",onChange:E,disabled:r||p.length>=5}),e.jsx("label",{htmlFor:"mark-others-image-upload",children:e.jsx(X,{variant:"outlined",component:"span",disabled:r||p.length>=5,sx:{mb:2},children:"Upload Images"})}),p.length>0&&e.jsx(l,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:p.map((b,k)=>e.jsxs(l,{sx:{position:"relative",width:80,height:80,border:"1px solid #e0e0e0",borderRadius:1,overflow:"hidden"},children:[e.jsx("img",{src:URL.createObjectURL(b),alt:`Preview ${k}`,style:{width:"100%",height:"100%",objectFit:"cover"}}),e.jsx(H,{size:"small",onClick:()=>P(k),sx:{position:"absolute",top:2,right:2,bgcolor:"rgba(255,255,255,0.8)",p:.5,"&:hover":{bgcolor:"white"}},children:e.jsx(Ce,{sx:{fontSize:16}})})]},k))})]}),i&&e.jsx(ce,{size:12,children:e.jsx(l,{sx:{p:2,bgcolor:"info.lighter",borderRadius:1,border:"1px solid",borderColor:"info.light"},children:e.jsxs(u,{variant:"body2",color:"info.dark",children:[e.jsx("strong",{children:"Note:"}),' This complaint will be marked as "Others" and categorized under'," ",e.jsx("strong",{children:i==="CORPORATION_INTERNAL"?"Corporation Internal":"Corporation External"}),g&&e.jsxs(e.Fragment,{children:[" - ",e.jsx("strong",{children:g})]}),". The user will be notified of this status change."]})})})]})}),e.jsxs(Ot,{sx:{borderTop:"1px solid #e0e0e0",px:3,py:2,gap:1.5,flexDirection:{xs:"column-reverse",sm:"row"},"& > button":{width:{xs:"100%",sm:"auto"},minHeight:{xs:48,sm:36}}},children:[e.jsx(X,{onClick:O,disabled:r,color:"inherit",variant:"outlined",children:"Cancel"}),e.jsx(X,{onClick:T,variant:"contained",color:"primary",disabled:r||!i||!g||!o||o.length<20,children:r?"Marking...":"Mark as Others"})]})]})};class Ms{constructor(){pe(this,"apiClient");pe(this,"cache");pe(this,"CACHE_DURATION",30*60*1e3);this.apiClient=te.create({baseURL:ee.BASE_URL,timeout:ee.TIMEOUT,withCredentials:!0,headers:{"Content-Type":"application/json"}}),this.cache=new Map,this.setupInterceptors()}setupInterceptors(){this.apiClient.interceptors.request.use(t=>{try{const s=localStorage.getItem("accessToken");s&&(t.headers.Authorization=`Bearer ${s}`)}catch(s){console.error("Error getting token:",s)}return t},t=>Promise.reject(t)),this.apiClient.interceptors.response.use(t=>t,t=>{var s;return((s=t.response)==null?void 0:s.status)===401&&window.location.pathname!=="/login"&&window.location.assign("/login"),Promise.reject(t)})}getCacheKey(t,s){const r=s?JSON.stringify(s):"";return`${t}:${r}`}getCachedData(t){const s=this.cache.get(t);if(s){if(Date.now()-s.timestamp<this.CACHE_DURATION)return s.data;this.cache.delete(t)}return null}setCachedData(t,s){this.cache.set(t,{data:s,timestamp:Date.now()})}clearCache(){this.cache.clear()}async getAllCategories(){var t,s;try{const r=this.getCacheKey("categories"),n=this.getCachedData(r);if(n)return n;const i=(await this.apiClient.get("/api/categories")).data.data.categories;return this.setCachedData(r,i),i}catch(r){throw te.isAxiosError(r)?new Error(((s=(t=r.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to fetch categories"):r}}async getCategoryById(t){var s,r;try{const n=this.getCacheKey(`category-${t}`),c=this.getCachedData(n);if(c)return c;const f=(await this.apiClient.get(`/api/categories/${t}`)).data.data.category;return this.setCachedData(n,f),f}catch(n){throw te.isAxiosError(n)?new Error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.message)||"Failed to fetch category"):n}}async getSubcategories(t){var s,r;try{const n=this.getCacheKey(`subcategories-${t}`),c=this.getCachedData(n);if(c)return c;const f=(await this.apiClient.get(`/api/categories/${t}/subcategories`)).data.data.subcategories;return this.setCachedData(n,f),f}catch(n){throw te.isAxiosError(n)?new Error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.message)||"Failed to fetch subcategories"):n}}async getCategoryStatistics(t){var s,r;try{const n=this.getCacheKey("category-statistics",t),c=this.cache.get(n);if(c&&Date.now()-c.timestamp<5*60*1e3)return c.data;const f=(await this.apiClient.get("/api/admin/analytics/categories",{params:t})).data.data;return this.setCachedData(n,f),f}catch(n){throw te.isAxiosError(n)?new Error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.message)||"Failed to fetch category statistics"):n}}async getCategoryTrends(t){var s,r;try{const n=this.getCacheKey("category-trends",t),c=this.cache.get(n);if(c&&Date.now()-c.timestamp<5*60*1e3)return c.data;const f=(await this.apiClient.get("/api/admin/analytics/categories/trends",{params:t})).data.data;return this.setCachedData(n,f),f}catch(n){throw te.isAxiosError(n)?new Error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.message)||"Failed to fetch category trends"):n}}async getCategoryName(t,s="en"){if(t==="CORPORATION_INTERNAL")return s==="bn"?"à¦•à¦°à§à¦ªà§‹à¦°à§‡à¦¶à¦¨ (à¦…à¦­à§à¦¯à¦¨à§à¦¤à¦°à§€à¦£)":"Corporation (Internal)";if(t==="CORPORATION_EXTERNAL")return s==="bn"?"à¦•à¦°à§à¦ªà§‹à¦°à§‡à¦¶à¦¨ (à¦¬à¦¾à¦¹à§à¦¯à¦¿à¦•)":"Corporation (External)";const n=(await this.getAllCategories()).find(c=>c.id===t);return n?s==="bn"?n.bangla:n.english:"Unknown Category"}async getSubcategoryName(t,s,r="en"){if(t==="CORPORATION_INTERNAL"||t==="CORPORATION_EXTERNAL")return s.replace(/_/g," ").replace(/\b\w/g,i=>i.toUpperCase());const c=(await this.getCategoryById(t)).subcategories.find(i=>i.id===s);return c?r==="bn"?c.bangla:c.english:"Unknown Subcategory"}async getCategoryColor(t){if(t==="CORPORATION_INTERNAL")return"#9333ea";if(t==="CORPORATION_EXTERNAL")return"#ea580c";const r=(await this.getAllCategories()).find(n=>n.id===t);return(r==null?void 0:r.color)||"#808080"}async categoryExists(t){try{return await this.getCategoryById(t),!0}catch{return!1}}async subcategoryExists(t,s){try{return(await this.getSubcategories(t)).some(n=>n.id===s)}catch{return!1}}}const fe=new Ms,Ps=({categoryId:a,subcategoryId:t})=>{const[s,r]=h.useState(""),[n,c]=h.useState(""),[i,f]=h.useState(""),[g,d]=h.useState(""),[o,y]=h.useState("#808080"),[p,v]=h.useState(!0);h.useEffect(()=>{a&&t&&(async()=>{try{v(!0);const[S,E,P,T,O]=await Promise.all([fe.getCategoryName(a,"en"),fe.getCategoryName(a,"bn"),fe.getSubcategoryName(a,t,"en"),fe.getSubcategoryName(a,t,"bn"),fe.getCategoryColor(a)]);r(S),c(E),f(P),d(T),y(O)}catch(S){console.error("Error fetching category info:",S),r("Unknown Category"),c("à¦…à¦œà¦¾à¦¨à¦¾ à¦¬à¦¿à¦­à¦¾à¦—"),f("Unknown Subcategory"),d("à¦…à¦œà¦¾à¦¨à¦¾ à¦‰à¦ªà¦¬à¦¿à¦­à¦¾à¦—")}finally{v(!1)}})()},[a,t]);const C=()=>{const w={sx:{fontSize:40,color:o}};switch(a){case"home":return e.jsx(Kt,{...w});case"road_environment":return e.jsx(Zt,{...w});case"business":return e.jsx(mt,{...w});case"office":return e.jsx(Jt,{...w});case"education":return e.jsx(Gt,{...w});case"hospital":return e.jsx(_t,{...w});case"religious":return e.jsx(Vt,{...w});case"events":return e.jsx(Ht,{...w});default:return e.jsx(mt,{...w})}};return p?e.jsxs(l,{sx:{display:"flex",gap:2,alignItems:"center"},children:[e.jsx(We,{variant:"circular",width:40,height:40}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(We,{variant:"text",width:"60%",height:24}),e.jsx(We,{variant:"text",width:"80%",height:20})]})]}):e.jsxs(l,{sx:{display:"flex",gap:2,alignItems:"flex-start",p:2,backgroundColor:"#f8f9fa",borderRadius:2,border:`2px solid ${o}`},children:[e.jsx(l,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:60,height:60,borderRadius:2,backgroundColor:`${o}15`},children:C()}),e.jsxs(l,{sx:{flex:1},children:[e.jsxs(l,{sx:{mb:1},children:[e.jsx(u,{variant:"body1",sx:{fontWeight:600,color:o,mb:.5},children:s}),e.jsx(u,{variant:"body2",sx:{color:"text.secondary",fontStyle:"italic"},children:n})]}),e.jsxs(l,{children:[e.jsx(u,{variant:"body2",sx:{fontWeight:500,mb:.5},children:i}),e.jsx(u,{variant:"caption",sx:{color:"text.secondary",fontStyle:"italic"},children:g})]})]}),e.jsx(be,{label:s,size:"small",sx:{backgroundColor:o,color:"#fff",fontWeight:500,fontSize:"0.75rem",height:24,boxShadow:"0 1px 3px rgba(0,0,0,0.12)"}})]})},Us=({complaintId:a,open:t,onClose:s,onStatusUpdate:r,onChatOpen:n})=>{var Ke,Xe,qe,Ye,Qe,et,tt,st,rt,ot,at,nt,it;const c=Me(),i=le(c.breakpoints.down("sm")),f=le(c.breakpoints.down("md")),{canEditComplaints:g,canViewComplaints:d}=Is(),[o,y]=h.useState(null),[p,v]=h.useState(null),[C,w]=h.useState(!1),[S,E]=h.useState(null),[P,T]=h.useState(!1),[O,D]=h.useState(0),[b,k]=h.useState(1),[U,V]=h.useState(new Set),[I,F]=h.useState({}),[q,A]=h.useState({}),[z,J]=h.useState({}),[Y,Pe]=h.useState({}),K=Ss.useRef({}),[re,oe]=h.useState(!1),[Ue,ae]=h.useState(!1);h.useEffect(()=>{t&&a&&de()},[t,a]),h.useEffect(()=>{(async()=>{var W,L,G,ze,ct;if(!o)return;let m=null,j=o.locationDetails;if(typeof j=="string")try{j=JSON.parse(j)}catch(B){console.error("Error parsing locationDetails JSON:",B)}if(j!=null&&j.ward){const me=String(j.ward).match(/\d+/);me&&(m=parseInt(me[0]))}if(!m&&o.location){const B=o.location.match(/Ward\s*(\d+)/i);B&&(m=parseInt(B[1]))}if(!m&&typeof((W=o.user)==null?void 0:W.ward)=="object"&&o.user.ward.wardNumber&&(m=o.user.ward.wardNumber),!!m)try{let B=(L=o.cityCorporation)==null?void 0:L.code;if(!B&&o.location&&(o.location.toLowerCase().includes("south")||o.location.includes("à¦¦à¦•à§à¦·à¦¿à¦£")?B="DSCC":(o.location.toLowerCase().includes("north")||o.location.includes("à¦‰à¦¤à§à¦¤à¦°"))&&(B="DNCC")),!B){const ie=(G=o.user)==null?void 0:G.cityCorporation;typeof ie=="string"?ie.includes("South")?B="DSCC":ie.includes("North")&&(B="DNCC"):(ct=(ze=o.user)==null?void 0:ze.cityCorporation)!=null&&ct.code&&(B=o.user.cityCorporation.code)}B||(B="DNCC");const me=await wt.getWards({cityCorporationCode:B});if(me.wards){const ie=me.wards.find(Ae=>Ae.wardNumber===m);if(ie)v(ie);else{const Ae=await wt.getWards({status:"ACTIVE"});if(Ae.wards){const lt=Ae.wards.find(Wt=>Wt.wardNumber===m);lt&&v(lt)}}}}catch(B){console.error("Error fetching correct ward data:",B)}})()},[o]);const de=async()=>{if(a)try{w(!0),E(null);const x=await Te.getComplaintById(a);console.log("ðŸ“‹ Complaint data received:",{id:x.id,resolutionImages:x.resolutionImages,resolutionNote:x.resolutionNote,status:x.status}),y(x)}catch(x){const m=Le(x);E(m.userMessage)}finally{w(!1)}},ne=()=>{y(null),E(null),s()},we=x=>{switch(x){case"PENDING":return{backgroundColor:"#fff3cd",color:"#856404",borderColor:"#ffeeba"};case"IN_PROGRESS":return{backgroundColor:"#d1ecf1",color:"#0c5460",borderColor:"#bee5eb"};case"RESOLVED":return{backgroundColor:"#d4edda",color:"#155724",borderColor:"#c3e6cb"};case"REJECTED":return{backgroundColor:"#f8d7da",color:"#721c24",borderColor:"#f5c6cb"};default:return{backgroundColor:"#f8f9fa",color:"#6c757d"}}},ve=x=>{switch(x){case"PENDING":return"Pending";case"IN_PROGRESS":return"In Progress";case"RESOLVED":return"Solved";case"REJECTED":return"Rejected";default:return x}},ue=x=>new Date(x).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),Se=x=>{D(x),k(1),T(!0)},he=()=>{T(!1),k(1)},Ie=()=>{o&&o.imageUrls.length>0&&(D(x=>x===0?o.imageUrls.length-1:x-1),k(1))},Ee=()=>{o&&o.imageUrls.length>0&&(D(x=>x===o.imageUrls.length-1?0:x+1),k(1))},ke=()=>{k(x=>Math.min(x+.25,3))},Re=()=>{k(x=>Math.max(x-.25,.5))},Ne=()=>{if(o&&o.imageUrls[O]){const x=document.createElement("a");x.href=o.imageUrls[O],x.download=`complaint-${o.id}-image-${O+1}.jpg`,document.body.appendChild(x),x.click(),document.body.removeChild(x)}},R=x=>{V(m=>new Set(m).add(x))},$=x=>{const m=K.current[x];m&&(I[x]?(m.pause(),F(j=>({...j,[x]:!1}))):(m.play(),F(j=>({...j,[x]:!0}))))},N=x=>{const m=K.current[x];if(!m)return;const j=m.currentTime/m.duration*100;A(W=>({...W,[x]:j}))},_=x=>{F(m=>({...m,[x]:!1})),A(m=>({...m,[x]:0}))},xe=(x,m)=>{const j=K.current[x];j&&(j.volume=m,J(W=>({...W,[x]:m})))},Oe=x=>{const m=K.current[x];if(!m)return;const j=[.5,1,1.5,2],W=Y[x]||1,L=j.indexOf(W),G=j[(L+1)%j.length];m.playbackRate=G,Pe(ze=>({...ze,[x]:G}))},$e=(x,m)=>{const j=K.current[x];if(!j)return;const W=m.currentTarget.getBoundingClientRect(),G=(m.clientX-W.left)/W.width;j.currentTime=G*j.duration},Pt=(x,m)=>{const j=document.createElement("a");j.href=x,j.download=`complaint-${o==null?void 0:o.id}-audio-${m+1}.mp3`,document.body.appendChild(j),j.click(),document.body.removeChild(j)},Je=x=>{if(isNaN(x))return"0:00";const m=Math.floor(x/60),j=Math.floor(x%60);return`${m}:${j.toString().padStart(2,"0")}`},Ut=async x=>{if(!(!o||!a)){if(x==="REJECTED"){ae(!0);return}try{oe(!0),r(a,x),y(m=>m?{...m,status:x}:null),Z.success("Status updated successfully",{icon:"âœ…",duration:3e3})}catch(m){const j=Le(m);Z.error(j.userMessage,{duration:5e3,icon:"âŒ"})}finally{oe(!1)}}},$t=async(x,m,j,W)=>{if(!(!o||!a))try{oe(!0),await Te.markComplaintAsOthers(a,{othersCategory:x,othersSubcategory:m,note:j,images:W}),r(a,"REJECTED"),Z.success("Complaint marked as Others successfully",{icon:"âœ…",duration:3e3}),ae(!1),de()}catch(L){const G=Le(L);Z.error(G.userMessage,{duration:5e3,icon:"âŒ"})}finally{oe(!1)}},Ze=x=>({PENDING:[{status:"IN_PROGRESS",label:"Mark In Progress",color:"#0c5460"},{status:"RESOLVED",label:"Mark Solved",color:"#155724"},{status:"REJECTED",label:"Mark Rejected",color:"#721c24"}],IN_PROGRESS:[{status:"PENDING",label:"Mark Pending",color:"#856404"},{status:"RESOLVED",label:"Mark Solved",color:"#155724"},{status:"REJECTED",label:"Mark Rejected",color:"#721c24"}],RESOLVED:[{status:"PENDING",label:"Mark Pending",color:"#856404"},{status:"IN_PROGRESS",label:"Mark In Progress",color:"#0c5460"},{status:"REJECTED",label:"Mark Rejected",color:"#721c24"}],REJECTED:[{status:"PENDING",label:"Mark Pending",color:"#856404"},{status:"IN_PROGRESS",label:"Mark In Progress",color:"#0c5460"},{status:"RESOLVED",label:"Mark Solved",color:"#155724"}],OTHERS:[{status:"PENDING",label:"Mark Pending",color:"#856404"},{status:"IN_PROGRESS",label:"Mark In Progress",color:"#0c5460"},{status:"RESOLVED",label:"Mark Solved",color:"#155724"},{status:"REJECTED",label:"Mark Rejected",color:"#721c24"}]})[x]||[];return e.jsxs(e.Fragment,{children:[e.jsxs(kt,{open:t,onClose:ne,maxWidth:"md",fullWidth:!0,fullScreen:i,slotProps:{paper:{sx:{borderRadius:i?0:2,maxHeight:i?"100vh":"90vh",animation:i?`${_e} ${M.normal.duration} ${M.smooth.timing}`:`${Es} ${M.normal.duration} ${M.smooth.timing}`,animationFillMode:"both"}},backdrop:{sx:{animation:`${Ve} ${M.fast.duration} ${M.fast.timing}`}}},children:[e.jsxs(Rt,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:2,borderBottom:"1px solid #e0e0e0"},children:[e.jsx(u,{component:"span",variant:"h6",sx:{fontWeight:600},children:"Complaint Details"}),e.jsx(H,{onClick:ne,size:"small",sx:{color:"text.secondary","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"}},children:e.jsx(Ce,{})})]}),e.jsxs(Nt,{sx:{pt:{xs:2,sm:3},pb:{xs:1.5,sm:2}},children:[C&&e.jsx(l,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:{xs:200,sm:300}},children:e.jsx(De,{})}),S&&!C&&e.jsx(pt,{severity:"error",sx:{mb:2},children:S}),o&&!C&&!S&&e.jsxs(l,{children:[e.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between",alignItems:{xs:"flex-start",sm:"center"},mb:{xs:2,sm:3},gap:{xs:1,sm:2}},children:[e.jsx(u,{variant:i?"h6":"h5",sx:{fontWeight:600,color:"#4CAF50"},children:o.trackingNumber||`C${String(o.id).padStart(6,"0")}`}),e.jsx(be,{label:ve(o.status),sx:{...we(o.status),...ks,fontWeight:500,fontSize:{xs:"0.75rem",sm:"0.875rem"},height:{xs:28,sm:32}}})]}),e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsx(u,{variant:i?"caption":"subtitle2",color:"text.secondary",sx:{mb:.5},children:"Complaint Title"}),e.jsx(u,{variant:i?"body2":"body1",sx:{fontWeight:500},children:o.title})]}),e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsx(u,{variant:i?"caption":"subtitle2",color:"text.secondary",sx:{mb:1},children:"Category"}),o.category&&o.subcategory?e.jsx(Ps,{categoryId:o.category,subcategoryId:o.subcategory}):e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,backgroundColor:"#f5f5f5",border:"1px dashed #bdbdbd",borderRadius:1},children:[e.jsx(Xt,{sx:{color:"#757575",fontSize:20}}),e.jsx(u,{variant:"body2",sx:{color:"#757575",fontStyle:"italic"},children:"This complaint has not been categorized yet. It was created before the category system was implemented."})]})]}),e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsx(u,{variant:i?"caption":"subtitle2",color:"text.secondary",sx:{mb:.5},children:"Description"}),e.jsx(u,{variant:i?"body2":"body1",sx:{whiteSpace:"pre-wrap"},children:o.description})]}),e.jsx(se,{sx:{my:{xs:2,sm:3}}}),e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:{xs:1,sm:1.5}},children:[e.jsx(zt,{sx:{mr:1,color:"text.secondary",fontSize:{xs:18,sm:20}}}),e.jsx(u,{variant:i?"body1":"subtitle1",sx:{fontWeight:600},children:"Location Information"})]}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"1fr 1fr"},gap:{xs:1.5,sm:2}},children:[e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"District"}),e.jsx(u,{variant:i?"body2":"body1",children:((Ke=o.locationDetails)==null?void 0:Ke.district)||"N/A"})]}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Thana"}),e.jsx(u,{variant:i?"body2":"body1",children:((Xe=o.locationDetails)==null?void 0:Xe.thana)||"N/A"})]}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Ward"}),e.jsx(u,{variant:i?"body2":"body1",children:((qe=o.locationDetails)==null?void 0:qe.ward)||(o.wards?typeof o.wards=="object"?`Ward ${o.wards.wardNumber||o.wards.number}`:`Ward ${o.wards}`:o.user.ward?typeof o.user.ward=="object"?`Ward ${o.user.ward.wardNumber}`:`Ward ${o.user.ward}`:"N/A")})]}),e.jsxs(l,{sx:{gridColumn:{xs:"1",sm:"1 / -1"}},children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Full Address"}),e.jsx(u,{variant:i?"body2":"body1",children:((Ye=o.locationDetails)==null?void 0:Ye.address)||o.location})]})]})]}),((p==null?void 0:p.inspectorName)||((Qe=o.wards)==null?void 0:Qe.inspectorName)||((et=o.zone)==null?void 0:et.officerName))&&e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:{xs:1,sm:1.5}},children:[e.jsx(gt,{sx:{mr:1,color:"text.secondary",fontSize:{xs:18,sm:20}}}),e.jsx(u,{variant:i?"body1":"subtitle1",sx:{fontWeight:600},children:"Responsible Officials"})]}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"1fr 1fr"},gap:{xs:1.5,sm:2}},children:[((p==null?void 0:p.inspectorName)||((tt=o.wards)==null?void 0:tt.inspectorName))&&e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Ward Inspector"}),e.jsx(u,{variant:i?"body2":"body1",children:(p==null?void 0:p.inspectorName)||((st=o.wards)==null?void 0:st.inspectorName)}),((p==null?void 0:p.inspectorPhone)||((rt=o.wards)==null?void 0:rt.inspectorPhone))&&e.jsx(u,{variant:"body2",color:"text.secondary",children:(p==null?void 0:p.inspectorPhone)||((ot=o.wards)==null?void 0:ot.inspectorPhone)})]}),((at=o.zone)==null?void 0:at.officerName)&&e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Zone Officer"}),e.jsx(u,{variant:i?"body2":"body1",children:o.zone.officerName}),o.zone.officerPhone&&e.jsx(u,{variant:"body2",color:"text.secondary",children:o.zone.officerPhone})]})]})]}),e.jsx(se,{sx:{my:{xs:2,sm:3}}}),e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:{xs:1,sm:1.5}},children:[e.jsx(gt,{sx:{mr:1,color:"text.secondary",fontSize:{xs:18,sm:20}}}),e.jsx(u,{variant:i?"body1":"subtitle1",sx:{fontWeight:600},children:"Citizen Information"})]}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"1fr 1fr"},gap:{xs:1.5,sm:2}},children:[e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Citizen ID"}),e.jsxs(u,{variant:i?"body2":"body1",children:["U",String(o.user.id).padStart(6,"0")]})]}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Name"}),e.jsxs(u,{variant:i?"body2":"body1",children:[o.user.firstName," ",o.user.lastName]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(At,{sx:{fontSize:{xs:16,sm:18},color:"text.secondary"}}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Phone"}),e.jsx(u,{variant:i?"body2":"body1",children:o.user.phone})]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Dt,{sx:{fontSize:{xs:16,sm:18},color:"text.secondary"}}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Email"}),e.jsx(u,{variant:i?"body2":"body1",sx:{wordBreak:"break-word",fontSize:{xs:"0.75rem",sm:"1rem"}},children:o.user.email||"Not provided"})]})]}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"City Corporation"}),e.jsx(u,{variant:i?"body2":"body1",children:((nt=o.user.cityCorporation)==null?void 0:nt.name)||"N/A"})]}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Zone"}),e.jsx(u,{variant:i?"body2":"body1",children:o.user.zone?`Zone ${o.user.zone}`:"N/A"})]}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Ward Number"}),e.jsx(u,{variant:i?"body2":"body1",children:o.wards?typeof o.wards=="object"?`Ward ${o.wards.wardNumber||o.wards.number}`:`Ward ${o.wards}`:o.user.ward?typeof o.user.ward=="object"?`Ward ${o.user.ward.wardNumber}`:`Ward ${o.user.ward}`:"N/A"})]}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Thana/Area"}),e.jsx(u,{variant:i?"body2":"body1",children:((it=o.user.thana)==null?void 0:it.name)||"N/A"})]}),o.user.address&&e.jsxs(l,{sx:{gridColumn:{xs:"1",sm:"1 / -1"}},children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Citizen Address"}),e.jsx(u,{variant:i?"body2":"body1",sx:{wordBreak:"break-word"},children:o.user.address})]})]})]}),e.jsx(se,{sx:{my:{xs:2,sm:3}}}),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:{xs:"1fr",sm:"1fr 1fr"},gap:{xs:1.5,sm:2}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(qt,{sx:{fontSize:{xs:16,sm:18},color:"text.secondary"}}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Submitted"}),e.jsx(u,{variant:i?"body2":"body1",sx:{fontSize:{xs:"0.75rem",sm:"1rem"}},children:ue(o.createdAt)})]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Yt,{sx:{fontSize:{xs:16,sm:18},color:"text.secondary"}}),e.jsxs(l,{children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",children:"Last Updated"}),e.jsx(u,{variant:i?"body2":"body1",sx:{fontSize:{xs:"0.75rem",sm:"1rem"}},children:ue(o.updatedAt)})]})]})]}),o.imageUrls&&o.imageUrls.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(se,{sx:{my:{xs:2,sm:3}}}),e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:{xs:1,sm:1.5}},children:[e.jsx(Qt,{sx:{mr:1,color:"text.secondary",fontSize:{xs:18,sm:20}}}),e.jsxs(u,{variant:i?"body1":"subtitle1",sx:{fontWeight:600},children:["Attached Images (",o.imageUrls.length,")"]})]}),e.jsx(ft,{cols:i?2:f?3:4,gap:i?8:12,sx:{mt:{xs:1,sm:2}},children:o.imageUrls.map((x,m)=>e.jsx(bt,{sx:{cursor:"pointer",borderRadius:1,overflow:"hidden",border:"1px solid #e0e0e0","&:hover":{opacity:.8,boxShadow:2}},onClick:()=>Se(m),children:U.has(m)?e.jsxs(l,{sx:{width:"100%",height:150,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",backgroundColor:"#f5f5f5"},children:[e.jsx(es,{sx:{fontSize:40,color:"text.secondary",mb:1}}),e.jsx(u,{variant:"caption",color:"text.secondary",children:"Failed to load"})]}):e.jsx("img",{src:x,alt:`Complaint image ${m+1}`,loading:"lazy",style:{width:"100%",height:150,objectFit:"cover"},onError:()=>R(m)})},m))})]})]}),o.audioUrls&&o.audioUrls.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(se,{sx:{my:3}}),e.jsxs(l,{sx:{mb:3},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:1.5},children:[e.jsx(ts,{sx:{mr:1,color:"text.secondary"}}),e.jsxs(u,{variant:"subtitle1",sx:{fontWeight:600},children:["Voice Recordings (",o.audioUrls.length,")"]})]}),o.audioUrls.map((x,m)=>{var j,W;return e.jsxs(l,{sx:{border:"1px solid #e0e0e0",borderRadius:2,p:2,mb:2,backgroundColor:"#f8f9fa"},children:[e.jsx("audio",{ref:L=>{K.current[m]=L},src:x,onTimeUpdate:()=>N(m),onEnded:()=>_(m),onLoadedMetadata:L=>{const G=L.currentTarget;G.volume=z[m]||1,G.playbackRate=Y[m]||1},style:{display:"none"}}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(H,{onClick:()=>$(m),sx:{backgroundColor:"#4CAF50",color:"white","&:hover":{backgroundColor:"#45a049"}},children:I[m]?e.jsx(ss,{}):e.jsx(rs,{})}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(l,{onClick:L=>$e(m,L),sx:{height:6,backgroundColor:"#e0e0e0",borderRadius:3,cursor:"pointer",position:"relative","&:hover":{backgroundColor:"#d0d0d0"}},children:e.jsx(l,{sx:{height:"100%",width:`${q[m]||0}%`,backgroundColor:"#4CAF50",borderRadius:3,transition:"width 0.1s linear"}})}),e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(u,{variant:"caption",color:"text.secondary",children:Je(((j=K.current[m])==null?void 0:j.currentTime)||0)}),e.jsx(u,{variant:"caption",color:"text.secondary",children:Je(((W=K.current[m])==null?void 0:W.duration)||0)})]})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(H,{size:"small",onClick:()=>xe(m,z[m]>0?0:1),children:(z[m]||1)>0?e.jsx(os,{}):e.jsx(as,{})}),e.jsx(l,{sx:{width:60},children:e.jsx("input",{type:"range",min:"0",max:"1",step:"0.1",value:z[m]||1,onChange:L=>xe(m,parseFloat(L.target.value)),style:{width:"100%"}})})]}),e.jsxs(X,{size:"small",variant:"outlined",startIcon:e.jsx(ns,{}),onClick:()=>Oe(m),sx:{minWidth:80,textTransform:"none"},children:[Y[m]||1,"x"]}),e.jsx(H,{size:"small",onClick:()=>Pt(x,m),children:e.jsx(yt,{})})]}),e.jsxs(u,{variant:"caption",color:"text.secondary",children:["Recording ",m+1]})]},m)})]})]}),(o.resolutionNote||o.resolutionImages)&&e.jsxs(e.Fragment,{children:[e.jsx(se,{sx:{my:{xs:2,sm:3}}}),e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:{xs:1,sm:1.5}},children:[e.jsx(Ct,{sx:{mr:1,color:"#4CAF50",fontSize:{xs:18,sm:20}}}),e.jsx(u,{variant:i?"body1":"subtitle1",sx:{fontWeight:600,color:"#4CAF50"},children:"Admin Resolution Report"})]}),o.resolutionNote&&e.jsxs(l,{sx:{mb:{xs:2,sm:3}},children:[e.jsx(u,{variant:i?"caption":"body2",color:"text.secondary",sx:{mb:.5},children:"Resolution Note"}),e.jsx(l,{sx:{p:{xs:1.5,sm:2},backgroundColor:"#f0f7f0",border:"1px solid #c3e6cb",borderRadius:1},children:e.jsx(u,{variant:i?"body2":"body1",sx:{whiteSpace:"pre-wrap"},children:o.resolutionNote})})]}),o.resolutionImages&&(()=>{const x=o.resolutionImages.split(",").filter(m=>m.trim());return x.length>0&&e.jsxs(l,{children:[e.jsxs(u,{variant:i?"caption":"body2",color:"text.secondary",sx:{mb:1},children:["Resolution Images (",x.length,")"]}),e.jsx(ft,{cols:i?2:f?3:4,gap:i?8:12,children:x.map((m,j)=>e.jsx(bt,{sx:{cursor:"pointer",borderRadius:1,overflow:"hidden",border:"2px solid #4CAF50","&:hover":{opacity:.8,boxShadow:2}},onClick:()=>{window.open(m.trim(),"_blank")},children:e.jsx("img",{src:m.trim(),alt:`Resolution image ${j+1}`,loading:"lazy",style:{width:"100%",height:150,objectFit:"cover"},onError:W=>{const L=W.target;L.style.display="none";const G=L.parentElement;G&&(G.innerHTML=`
                                                                                <div style="width: 100%; height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f5f5f5;">
                                                                                    <svg style="width: 40px; height: 40px; color: #757575; margin-bottom: 8px;" fill="currentColor" viewBox="0 0 24 24">
                                                                                        <path d="M21 5v6.59l-3-3.01-4 4.01-4-4-4 4-3-3.01V5c0-1.1.9-2 2-2h14c1.1 0 2 .9 2 2zm-3 6.42l3 3.01V19c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2v-6.58l3 2.99 4-4 4 4 4-4z"/>
                                                                                    </svg>
                                                                                    <span style="font-size: 12px; color: #757575;">Failed to load</span>
                                                                                </div>
                                                                            `)}})},j))})]})})()]})]})]})]}),e.jsxs(Ot,{sx:{px:{xs:2,sm:3},py:{xs:1.5,sm:2},borderTop:"1px solid #e0e0e0",gap:{xs:1,sm:1.5},justifyContent:"space-between",flexDirection:{xs:"column",sm:"row"},alignItems:{xs:"stretch",sm:"center"}},children:[o&&Ze(o.status).length>0&&g()&&e.jsx(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:1,alignItems:{xs:"stretch",sm:"center"},width:{xs:"100%",sm:"auto"},flexWrap:"wrap"},children:Ze(o.status).map(x=>e.jsx(X,{variant:"contained",onClick:()=>Ut(x.status),disabled:re,startIcon:re?e.jsx(De,{size:16}):e.jsx(Ct,{}),sx:{backgroundColor:x.color,"&:hover":{backgroundColor:x.color,opacity:.9},textTransform:"none",minHeight:{xs:44,sm:"auto"},fontSize:{xs:"0.875rem",sm:"0.875rem"},px:{xs:2,sm:2}},children:re?"Updating...":x.label},x.status))}),o&&!g()&&d()&&e.jsx(pt,{severity:"info",sx:{flex:1},children:e.jsx(u,{variant:"body2",children:"à¦­à¦¿à¦‰ à¦…à¦¨à¦²à¦¿ à¦®à§‹à¦¡ - à¦†à¦ªà¦¨à¦¿ à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦•à¦®à¦ªà§à¦²à§‡à¦‡à¦¨ à¦¦à§‡à¦–à¦¤à§‡ à¦ªà¦¾à¦°à¦¬à§‡à¦¨, à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à¦¬à§‡à¦¨ à¦¨à¦¾à¥¤"})}),e.jsxs(l,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},gap:1,width:{xs:"100%",sm:"auto"}},children:[n&&o&&e.jsx(X,{variant:"outlined",startIcon:!i&&e.jsx(is,{}),onClick:()=>n(o.id),sx:{textTransform:"none",minHeight:{xs:44,sm:"auto"}},children:"Open Chat"}),e.jsx(X,{onClick:ne,variant:"outlined",sx:{textTransform:"none",minHeight:{xs:44,sm:"auto"}},children:"Close"})]})]})]}),e.jsx(Ts,{open:Ue,onClose:()=>ae(!1),onConfirm:$t,loading:re}),o&&o.imageUrls&&o.imageUrls.length>0&&e.jsx(cs,{open:P,onClick:he,sx:{zIndex:c.zIndex.modal+1,backgroundColor:"rgba(0, 0, 0, 0.9)"},children:e.jsxs(l,{onClick:x=>x.stopPropagation(),sx:{position:"relative",maxWidth:"90vw",maxHeight:"90vh",display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsxs(l,{sx:{position:"absolute",top:-60,right:0,display:"flex",gap:1,zIndex:1},children:[e.jsx(H,{onClick:Re,disabled:b<=.5,sx:{color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(ls,{})}),e.jsx(H,{onClick:ke,disabled:b>=3,sx:{color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(ds,{})}),e.jsx(H,{onClick:Ne,sx:{color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(yt,{})}),e.jsx(H,{onClick:he,sx:{color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(Ce,{})})]}),e.jsxs(l,{sx:{position:"relative",display:"flex",alignItems:"center",justifyContent:"center",overflow:"auto",maxWidth:"100%",maxHeight:"100%"},children:[o.imageUrls.length>1&&e.jsx(H,{onClick:Ie,sx:{position:"absolute",left:-60,color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(us,{sx:{fontSize:40}})}),e.jsx("img",{src:o.imageUrls[O],alt:`Complaint image ${O+1}`,style:{maxWidth:"100%",maxHeight:"90vh",transform:`scale(${b})`,transition:"transform 0.2s ease-in-out"}}),o.imageUrls.length>1&&e.jsx(H,{onClick:Ee,sx:{position:"absolute",right:-60,color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(hs,{sx:{fontSize:40}})})]}),o.imageUrls.length>1&&e.jsx(l,{sx:{position:"absolute",bottom:-50,color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)",px:2,py:1,borderRadius:1},children:e.jsxs(u,{variant:"body2",children:[O+1," / ",o.imageUrls.length]})})]})})]})},$s=({complaint:a,citizen:t,onViewDetails:s,onStatusChange:r,onViewHistory:n})=>{const c=Me(),i=le(c.breakpoints.down("md")),f=le(c.breakpoints.down("sm")),[g,d]=h.useState(!i),[o,y]=h.useState(null),p=!!o,v=b=>{switch(b){case"PENDING":return"#ff9800";case"IN_PROGRESS":return"#2196f3";case"RESOLVED":return"#4caf50";case"REJECTED":return"#f44336";default:return"#9e9e9e"}},C=b=>{switch(b){case"PENDING":return"Pending";case"IN_PROGRESS":return"In Progress";case"RESOLVED":return"Resolved";case"REJECTED":return"Rejected";default:return b}},w=b=>{y(b.currentTarget)},S=()=>{y(null)},E=b=>{r(b),S()},P=()=>{d(!g)},T=()=>{var U,V,I,F;const b=((V=(U=t.firstName)==null?void 0:U.charAt(0))==null?void 0:V.toUpperCase())||"",k=((F=(I=t.lastName)==null?void 0:I.charAt(0))==null?void 0:F.toUpperCase())||"";return`${b}${k}`},O=b=>new Date(b).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),D=["PENDING","IN_PROGRESS","RESOLVED","REJECTED"];return e.jsxs(l,{sx:{borderBottom:"1px solid #f3f4f6",backgroundColor:"#ffffff",zIndex:10},children:[e.jsxs(l,{sx:{p:2,display:"flex",alignItems:"center",gap:2},children:[e.jsx(xs,{src:t.profilePicture,alt:`${t.firstName} ${t.lastName}`,sx:{width:48,height:48,backgroundColor:"#3fa564",fontSize:"1.25rem",fontWeight:600,border:"2px solid #f0fdf4"},children:!t.profilePicture&&T()}),e.jsxs(l,{sx:{flex:1,minWidth:0},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsxs(u,{variant:"subtitle1",sx:{fontWeight:700,color:"#111827",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:[t.firstName," ",t.lastName]}),e.jsx(be,{label:C(a.status),size:"small",sx:{backgroundColor:v(a.status)+"20",color:v(a.status),fontWeight:700,fontSize:"0.7rem",height:24,border:`1px solid ${v(a.status)}40`}})]}),e.jsx(l,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"nowrap"},children:e.jsxs(u,{variant:"caption",sx:{color:"#6b7280",fontWeight:500,display:"flex",alignItems:"center",gap:.5},children:[e.jsx(l,{component:"span",sx:{bgcolor:"#e5e7eb",px:.5,borderRadius:.5,color:"#374151"},children:a.trackingNumber}),"â€¢ ",a.category]})})]}),i&&e.jsx(H,{onClick:P,size:"small",sx:{color:"#9ca3af",bgcolor:"#f9fafb","&:hover":{bgcolor:"#f3f4f6"}},children:g?e.jsx(ms,{}):e.jsx(ps,{})})]}),e.jsxs(gs,{in:g,timeout:"auto",unmountOnExit:!0,children:[e.jsxs(l,{sx:{px:{xs:1.5,sm:2,md:2},pb:{xs:1.5,sm:2,md:2}},children:[e.jsx(se,{sx:{mb:2}}),e.jsxs(l,{sx:{mb:2},children:[e.jsx(zt,{sx:{fontSize:18,color:"text.secondary"}}),e.jsx(u,{variant:"body2",sx:{fontWeight:600},children:"Location"})]}),e.jsxs(l,{sx:{ml:3,display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(u,{variant:"body2",color:"text.secondary",children:[t.cityCorporationName||t.district,t.thanaName?`, ${t.thanaName}`:`, ${t.upazila}`]}),e.jsxs(l,{sx:{display:"flex",gap:1},children:[t.zone&&e.jsx(be,{label:`Zone ${t.zone}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem"}}),t.ward&&e.jsx(be,{label:`Ward ${t.ward}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem"}})]})]}),t.address&&e.jsx(u,{variant:"body2",color:"text.secondary",sx:{ml:3,mt:.5,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:t.address})]}),e.jsxs(l,{sx:{mb:2},children:[e.jsx(u,{variant:"body2",sx:{fontWeight:600,mb:1},children:"Contact Information"}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(At,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(u,{variant:"body2",color:"text.secondary",children:t.phone})]}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Dt,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(u,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.email})]})]}),e.jsx(l,{sx:{mb:2},children:e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Submitted on ",O(a.createdAt)]})}),e.jsxs(l,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(X,{variant:"outlined",size:"small",startIcon:e.jsx(fs,{}),onClick:s,sx:{textTransform:"none",borderRadius:2,flex:f?"1 1 100%":"0 1 auto"},children:"View Full Details"}),e.jsx(X,{variant:"outlined",size:"small",onClick:w,sx:{textTransform:"none",borderRadius:2,flex:f?"1 1 100%":"0 1 auto"},children:"Change Status"}),n&&e.jsx(X,{variant:"outlined",size:"small",startIcon:e.jsx(bs,{}),onClick:n,sx:{textTransform:"none",borderRadius:2,flex:f?"1 1 100%":"0 1 auto"},children:"View History"})]})]}),e.jsx(ys,{anchorEl:o,open:p,onClose:S,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:D.map(b=>e.jsxs(He,{onClick:()=>E(b),disabled:b===a.status,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(l,{sx:{width:12,height:12,borderRadius:"50%",backgroundColor:v(b)}}),e.jsx(u,{variant:"body2",children:C(b)}),b===a.status&&e.jsx(u,{variant:"caption",color:"text.secondary",sx:{ml:1},children:"(Current)"})]},b))})]})},je=typeof window<"u"?h.useLayoutEffect:h.useEffect;function vt(a){if(a!==void 0)switch(typeof a){case"number":return a;case"string":{if(a.endsWith("px"))return parseFloat(a);break}}}function Ws({box:a,defaultHeight:t,defaultWidth:s,disabled:r,element:n,mode:c,style:i}){const{styleHeight:f,styleWidth:g}=h.useMemo(()=>({styleHeight:vt(i==null?void 0:i.height),styleWidth:vt(i==null?void 0:i.width)}),[i==null?void 0:i.height,i==null?void 0:i.width]),[d,o]=h.useState({height:t,width:s}),y=r||f!==void 0||c==="only-width"||f!==void 0&&g!==void 0;return je(()=>{if(n===null||y)return;const p=new ResizeObserver(v=>{for(const C of v){const{contentRect:w,target:S}=C;n===S&&o(E=>E.height===w.height&&E.width===w.width?E:{height:w.height,width:w.width})}});return p.observe(n,{box:a}),()=>{p==null||p.unobserve(n)}},[a,y,n,f,g]),h.useMemo(()=>({height:f??d.height,width:g??d.width}),[d,f,g])}function Tt(a){const t=h.useRef(()=>{throw new Error("Cannot call during render.")});return je(()=>{t.current=a},[a]),h.useCallback(s=>{var r;return(r=t.current)==null?void 0:r.call(t,s)},[t])}function Fe({containerElement:a,direction:t,isRtl:s,scrollOffset:r}){return r}function Q(a,t="Assertion error"){if(!a)throw console.error(t),Error(t)}function ye(a,t){if(a===t)return!0;if(!!a!=!!t||(Q(a!==void 0),Q(t!==void 0),Object.keys(a).length!==Object.keys(t).length))return!1;for(const s in a)if(!Object.is(t[s],a[s]))return!1;return!0}function Mt({cachedBounds:a,itemCount:t,itemSize:s}){if(t===0)return 0;if(typeof s=="number")return t*s;{const r=a.get(a.size===0?0:a.size-1);Q(r!==void 0,"Unexpected bounds cache miss");const n=(r.scrollOffset+r.size)/a.size;return t*n}}function Ls({align:a,cachedBounds:t,index:s,itemCount:r,itemSize:n,containerScrollOffset:c,containerSize:i}){if(s<0||s>=r)throw RangeError(`Invalid index specified: ${s}`,{cause:`Index ${s} is not within the range of 0 - ${r-1}`});const f=Mt({cachedBounds:t,itemCount:r,itemSize:n}),g=t.get(s),d=Math.max(0,Math.min(f-i,g.scrollOffset)),o=Math.max(0,g.scrollOffset-i+g.size);switch(a==="smart"&&(c>=o&&c<=d?a="auto":a="center"),a){case"start":return d;case"end":return o;case"center":return g.scrollOffset<=i/2?0:g.scrollOffset+g.size/2>=f-i/2?f-i:g.scrollOffset+g.size/2-i/2;case"auto":default:return c>=o&&c<=d?c:c<o?o:d}}function St({cachedBounds:a,containerScrollOffset:t,containerSize:s,itemCount:r,overscanCount:n}){const c=r-1;let i=0,f=-1,g=0,d=-1,o=0;for(;o<c;){const y=a.get(o);if(y.scrollOffset+y.size>t)break;o++}for(i=o,g=Math.max(0,i-n);o<c;){const y=a.get(o);if(y.scrollOffset+y.size>=t+s)break;o++}return f=Math.min(c,o),d=Math.min(r-1,f+n),i<0&&(i=0,f=-1,g=0,d=-1),{startIndexVisible:i,stopIndexVisible:f,startIndexOverscan:g,stopIndexOverscan:d}}function Bs({itemCount:a,itemProps:t,itemSize:s}){const r=new Map;return{get(n){for(Q(n<a,`Invalid index ${n}`);r.size-1<n;){const i=r.size;let f;switch(typeof s){case"function":{f=s(i,t);break}case"number":{f=s;break}}if(i===0)r.set(i,{size:f,scrollOffset:0});else{const g=r.get(i-1);Q(g!==void 0,`Unexpected bounds cache miss for index ${n}`),r.set(i,{scrollOffset:g.scrollOffset+g.size,size:f})}}const c=r.get(n);return Q(c!==void 0,`Unexpected bounds cache miss for index ${n}`),c},set(n,c){r.set(n,c)},get size(){return r.size}}}function Fs({itemCount:a,itemProps:t,itemSize:s}){return h.useMemo(()=>Bs({itemCount:a,itemProps:t,itemSize:s}),[a,t,s])}function Hs({containerSize:a,itemSize:t}){let s;switch(typeof t){case"string":{Q(t.endsWith("%"),`Invalid item size: "${t}"; string values must be percentages (e.g. "100%")`),Q(a!==void 0,"Container size must be defined if a percentage item size is specified"),s=a*parseInt(t)/100;break}default:{s=t;break}}return s}function Vs({containerElement:a,containerStyle:t,defaultContainerSize:s=0,direction:r,isRtl:n=!1,itemCount:c,itemProps:i,itemSize:f,onResize:g,overscanCount:d}){const[o,y]=h.useState({startIndexVisible:0,startIndexOverscan:0,stopIndexVisible:-1,stopIndexOverscan:-1}),{startIndexVisible:p,startIndexOverscan:v,stopIndexVisible:C,stopIndexOverscan:w}={startIndexVisible:Math.min(c-1,o.startIndexVisible),startIndexOverscan:Math.min(c-1,o.startIndexOverscan),stopIndexVisible:Math.min(c-1,o.stopIndexVisible),stopIndexOverscan:Math.min(c-1,o.stopIndexOverscan)},{height:S=s,width:E=s}=Ws({defaultHeight:s,defaultWidth:void 0,element:a,mode:"only-height",style:t}),P=h.useRef({height:0,width:0}),T=S,O=Hs({containerSize:T,itemSize:f});h.useLayoutEffect(()=>{if(typeof g=="function"){const I=P.current;(I.height!==S||I.width!==E)&&(g({height:S,width:E},{...I}),I.height=S,I.width=E)}},[S,g,E]);const D=Fs({itemCount:c,itemProps:i,itemSize:O}),b=h.useCallback(I=>D.get(I),[D]),k=h.useCallback(()=>Mt({cachedBounds:D,itemCount:c,itemSize:O}),[D,c,O]),U=h.useCallback(I=>{const F=Fe({containerElement:a,direction:r,isRtl:n,scrollOffset:I});return St({cachedBounds:D,containerScrollOffset:F,containerSize:T,itemCount:c,overscanCount:d})},[D,a,T,r,n,c,d]);je(()=>{const I=(a==null?void 0:a.scrollTop)??0;y(U(I))},[a,r,U]),je(()=>{if(!a)return;const I=()=>{y(F=>{const{scrollLeft:q,scrollTop:A}=a,z=Fe({containerElement:a,direction:r,isRtl:n,scrollOffset:A}),J=St({cachedBounds:D,containerScrollOffset:z,containerSize:T,itemCount:c,overscanCount:d});return ye(J,F)?F:J})};return a.addEventListener("scroll",I),()=>{a.removeEventListener("scroll",I)}},[D,a,T,r,c,d]);const V=Tt(({align:I="auto",containerScrollOffset:F,index:q})=>{let A=Ls({align:I,cachedBounds:D,containerScrollOffset:F,containerSize:T,index:q,itemCount:c,itemSize:O});if(a){if(A=Fe({containerElement:a,direction:r,isRtl:n,scrollOffset:A}),typeof a.scrollTo!="function"){const z=U(A);ye(o,z)||y(z)}return A}});return{getCellBounds:b,getEstimatedSize:k,scrollToIndex:V,startIndexOverscan:v,startIndexVisible:p,stopIndexOverscan:w,stopIndexVisible:C}}function _s(a){return h.useMemo(()=>a,Object.values(a))}function Gs(a,t){const{ariaAttributes:s,style:r,...n}=a,{ariaAttributes:c,style:i,...f}=t;return ye(s,c)&&ye(r,i)&&ye(n,f)}function Js(a){return a!=null&&typeof a=="object"&&"getAverageRowHeight"in a&&typeof a.getAverageRowHeight=="function"}const Ge="data-react-window-index";function Zs({children:a,className:t,defaultHeight:s=0,listRef:r,onResize:n,onRowsRendered:c,overscanCount:i=3,rowComponent:f,rowCount:g,rowHeight:d,rowProps:o,tagName:y="div",style:p,...v}){const C=_s(o),w=h.useMemo(()=>h.memo(f,Gs),[f]),[S,E]=h.useState(null),P=Js(d),T=h.useMemo(()=>P?A=>d.getRowHeight(A)??d.getAverageRowHeight():d,[P,d]),{getCellBounds:O,getEstimatedSize:D,scrollToIndex:b,startIndexOverscan:k,startIndexVisible:U,stopIndexOverscan:V,stopIndexVisible:I}=Vs({containerElement:S,containerStyle:p,defaultContainerSize:s,direction:"vertical",itemCount:g,itemProps:C,itemSize:T,onResize:n,overscanCount:i});h.useImperativeHandle(r,()=>({get element(){return S},scrollToRow({align:A="auto",behavior:z="auto",index:J}){const Y=b({align:A,containerScrollOffset:(S==null?void 0:S.scrollTop)??0,index:J});typeof(S==null?void 0:S.scrollTo)=="function"&&S.scrollTo({behavior:z,top:Y})}}),[S,b]),je(()=>{if(!S)return;const A=Array.from(S.children).filter((z,J)=>{if(z.hasAttribute("aria-hidden"))return!1;const Y=`${k+J}`;return z.setAttribute(Ge,Y),!0});if(P)return d.observeRowElements(A)},[S,P,d,k,V]),h.useEffect(()=>{k>=0&&V>=0&&c&&c({startIndex:U,stopIndex:I},{startIndex:k,stopIndex:V})},[c,k,U,V,I]);const F=h.useMemo(()=>{const A=[];if(g>0)for(let z=k;z<=V;z++){const J=O(z);A.push(h.createElement(w,{...C,ariaAttributes:{"aria-posinset":z+1,"aria-setsize":g,role:"listitem"},key:z,index:z,style:{position:"absolute",left:0,transform:`translateY(${J.scrollOffset}px)`,height:P?void 0:J.size,width:"100%"}}))}return A},[w,O,P,g,C,k,V]),q=e.jsx("div",{"aria-hidden":!0,style:{height:D(),width:"100%",zIndex:-1}});return h.createElement(y,{role:"list",...v,className:t,ref:E,style:{position:"relative",maxHeight:"100%",flexGrow:1,overflowY:"auto",...p}},F,a,q)}function Ks({defaultRowHeight:a,key:t}){const[s,r]=h.useState({key:t,map:new Map});s.key!==t&&r({key:t,map:new Map});const{map:n}=s,c=h.useCallback(()=>{let y=0;return n.forEach(p=>{y+=p}),y===0?a:y/n.size},[a,n]),i=h.useCallback(y=>{const p=n.get(y);return p!==void 0?p:(n.set(y,a),a)},[a,n]),f=h.useCallback((y,p)=>{r(v=>{if(v.map.get(y)===p)return v;const C=new Map(v.map);return C.set(y,p),{...v,map:C}})},[]),g=Tt(y=>{y.length!==0&&y.forEach(p=>{const{borderBoxSize:v,target:C}=p,w=C.getAttribute(Ge);Q(w!==null,`Invalid ${Ge} attribute value`);const S=parseInt(w),{blockSize:E}=v[0];E&&f(S,E)})}),[d]=h.useState(()=>new ResizeObserver(g));h.useEffect(()=>()=>{d.disconnect()},[d]);const o=h.useCallback(y=>(y.forEach(p=>d.observe(p)),()=>{y.forEach(p=>d.unobserve(p))}),[d]);return h.useMemo(()=>({getAverageRowHeight:c,getRowHeight:i,setRowHeight:f,observeRowElements:o}),[c,i,f,o])}const It=a=>{const t=new Date,s=new Date(a),r=Math.floor((t.getTime()-s.getTime())/1e3);if(r<60)return"Just now";if(r<3600){const n=Math.floor(r/60);return`${n} min${n>1?"s":""} ago`}else return r<86400?s.toLocaleTimeString("en-US",{hour:"numeric",minute:"numeric",hour12:!0}):s.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",hour12:!0})},Et=({message:a,isAdmin:t,showSenderName:s=!1})=>{const[r,n]=h.useState(!1);if(a.senderType==="BOT")return e.jsx(l,{sx:{mb:1.5,display:"flex",justifyContent:"center",animation:`${Ve} ${M.normal.duration} ${M.normal.timing}, ${_e} ${M.normal.duration} ${M.smooth.timing}`,animationFillMode:"both"},children:e.jsxs(l,{sx:{maxWidth:{xs:"85%",sm:"75%",md:"70%"},backgroundColor:"#f5f5f5",border:"1px solid #e0e0e0",borderRadius:"12px",padding:"12px 16px",display:"flex",alignItems:"flex-start",gap:1,boxShadow:"0 2px 8px rgba(0, 0, 0, 0.06)",transition:`all ${M.fast.duration} ${M.fast.timing}`,"&:hover":{boxShadow:"0 4px 12px rgba(0, 0, 0, 0.1)"}},children:[e.jsx(Cs,{sx:{color:"#757575",fontSize:20,mt:.2}}),e.jsxs(l,{sx:{flex:1},children:[e.jsx(u,{variant:"caption",sx:{color:"#757575",fontWeight:600,display:"block",mb:.5,fontSize:"0.75rem"},children:t?"[BOT] Clean Care Support System":"Clean Care Support System"}),e.jsx(u,{variant:"body2",sx:{color:"#424242",whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.5,fontSize:"0.9rem"},children:a.message}),e.jsx(u,{variant:"caption",sx:{color:"#9e9e9e",display:"block",mt:.5,fontSize:"0.7rem"},children:It(a.createdAt)})]})]})});const i=t?"20px 20px 4px 20px":"20px 20px 20px 4px";return e.jsxs(e.Fragment,{children:[e.jsx(l,{sx:{mb:2,display:"flex",justifyContent:t?"flex-end":"flex-start",animation:`${Ve} ${M.normal.duration} ${M.normal.timing}, ${_e} ${M.normal.duration} ${M.smooth.timing}`,animationFillMode:"both",px:1},children:e.jsxs(l,{sx:{maxWidth:{xs:"92%",sm:"88%",md:"85%"},minWidth:"120px",p:"12px 16px",borderRadius:i,background:t?"#15803d":"#ffffff",color:t?"#ffffff":"#1f2937",boxShadow:"0 1px 3px rgba(0, 0, 0, 0.12)",position:"relative",transition:`all ${M.fast.duration} ${M.fast.timing}`,"&:hover":{boxShadow:"0 4px 8px rgba(0, 0, 0, 0.15)"}},children:[!t&&s&&a.senderName&&e.jsx(u,{variant:"caption",sx:{fontWeight:700,display:"block",mb:.5,color:"#eab308",fontSize:"0.8rem"},children:a.senderName}),e.jsx(u,{variant:"body1",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.6,fontSize:"1rem",fontFamily:'"Inter", "Roboto", "Helvetica", "Arial", sans-serif',letterSpacing:"0.01em"},children:a.message}),a.imageUrl&&e.jsx(l,{component:"img",src:a.imageUrl,alt:"Message attachment",loading:"lazy",onLoad:()=>{var y;console.log("âœ… Image loaded successfully:",(y=a.imageUrl)==null?void 0:y.substring(0,100))},onError:y=>{var v,C;console.error("âŒ Image failed to load:",(v=a.imageUrl)==null?void 0:v.substring(0,100)),console.error("   Full URL:",a.imageUrl),y.currentTarget.style.display="none";const p=document.createElement("div");p.textContent="âŒ Image failed to load",p.style.color=t?"#ffcccc":"#ff0000",p.style.fontSize="0.8rem",p.style.marginTop="8px",(C=y.currentTarget.parentElement)==null||C.appendChild(p)},sx:{mt:1,maxWidth:"100%",maxHeight:"300px",borderRadius:"8px",cursor:"pointer",objectFit:"cover",transition:`all ${M.fast.duration} ${M.fast.timing}`,"&:hover":{opacity:.9,transform:"scale(1.02)"}},onClick:()=>n(!0)}),a.voiceUrl&&e.jsx(Rs,{voiceUrl:a.voiceUrl,isAdmin:t}),e.jsxs(l,{sx:{display:"flex",alignItems:"center",justifyContent:t?"flex-end":"flex-start",mt:.5,gap:.5},children:[e.jsx(u,{variant:"caption",sx:{opacity:t?.85:.6,fontSize:"0.7rem",fontWeight:500},children:It(a.createdAt)}),t&&e.jsx(l,{sx:{display:"flex",alignItems:"center",opacity:.85},children:a.read?e.jsx(js,{sx:{fontSize:"0.9rem",color:"#4caf50"}}):e.jsx(ws,{sx:{fontSize:"0.9rem"}})})]})]})}),a.imageUrl&&e.jsx(vs,{open:r,onClose:()=>n(!1),sx:{display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsxs(l,{sx:{position:"relative",maxWidth:"90vw",maxHeight:"90vh",outline:"none"},children:[e.jsx(H,{onClick:()=>n(!1),sx:{position:"absolute",top:-40,right:0,color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(Ce,{})}),e.jsx(l,{component:"img",src:a.imageUrl,alt:"Message attachment (full size)",sx:{maxWidth:"100%",maxHeight:"90vh",objectFit:"contain",borderRadius:"8px",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.3)"}})]})})]})},Xs=({messages:a,loading:t,loadingMore:s=!1,hasMoreMessages:r=!1,onLoadMore:n,onScroll:c})=>{const i=h.useRef(null),f=h.useRef(null),g=h.useRef(0),d=Ks({defaultRowHeight:100}),o=h.useCallback(()=>{var p;(p=f.current)==null||p.scrollIntoView({behavior:"smooth"})},[]),y=h.useCallback(p=>{if(c&&c(p),!i.current||s||!r||!n)return;const{scrollTop:v}=i.current;v<100&&(g.current=i.current.scrollHeight,n())},[c,s,r,n]);return h.useEffect(()=>{a.length>0&&!t&&!s&&setTimeout(o,100)},[a.length,t,s,o]),h.useEffect(()=>{if(s&&i.current&&g.current>0){const v=i.current.scrollHeight-g.current;i.current.scrollTop=v,g.current=0}},[a,s]),e.jsxs(l,{ref:i,onScroll:y,sx:{flex:1,overflowY:"auto",overflowX:"hidden",p:{xs:2,md:3},backgroundColor:"#f0f2f5",backgroundImage:"radial-gradient(#e5e7eb 1px, transparent 1px)",backgroundSize:"20px 20px",display:"flex",flexDirection:"column"},children:[t&&e.jsx(l,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:4,flex:1},children:e.jsx(De,{size:32})}),!t&&e.jsxs(e.Fragment,{children:[s&&e.jsx(l,{sx:{display:"flex",justifyContent:"center",py:2},children:e.jsx(De,{size:24})}),!r&&a.length>0&&e.jsx(l,{sx:{textAlign:"center",py:2},children:e.jsx(u,{variant:"caption",color:"text.secondary",children:"Start of conversation"})}),a.length>0&&e.jsx(e.Fragment,{children:a.length>200?e.jsx(Zs,{rowCount:a.length,rowHeight:d,overscanCount:10,rowComponent:({index:p,style:v})=>{const C=a[p];return e.jsx("div",{style:v,children:e.jsx(Et,{message:C,isAdmin:C.senderType==="ADMIN",showSenderName:C.senderType==="CITIZEN"},C.id)})},rowProps:{},style:{height:window.innerHeight-300}}):e.jsx(l,{children:a.map(p=>e.jsx(Et,{message:p,isAdmin:p.senderType==="ADMIN",showSenderName:p.senderType==="CITIZEN"},p.id))})}),a.length===0&&e.jsx(l,{sx:{flex:1,display:"flex",alignItems:"center"},children:e.jsx(Ns,{type:"no-messages"})}),e.jsx("div",{ref:f})]})]})},rr=({complaintId:a,onClose:t,onMessagesRead:s,hideHeader:r=!1,onStatusUpdate:n})=>{var ae,de,ne,we,ve,ue,Se,he,Ie,Ee,ke,Re,Ne;const c=Me(),i=le(c.breakpoints.down("md")),[f,g]=h.useState([]),[d,o]=h.useState(null),[y,p]=h.useState(!1),[v,C]=h.useState(null),[w,S]=h.useState(!0),[E,P]=h.useState(1),[T,O]=h.useState(!1),[D,b]=h.useState(!1),[k,U]=h.useState(!1),[V,I]=h.useState(null),[F,q]=h.useState(!1),A=h.useCallback(async(R=1,$=!1)=>{if(a)try{R===1?p(!0):O(!0),C(null);const{messages:N,pagination:_}=await ge.getChatMessages(a,R,50);g($?xe=>[...N,...xe]:N),S(_.hasNextPage),P(R)}catch(N){const _=N instanceof Error?N.message:"Failed to load messages";C(_),console.error("Error fetching messages:",N),Z.error("Failed to load messages. Please check your connection.",{icon:"âŒ",duration:4e3})}finally{p(!1),O(!1)}},[a]),z=h.useCallback(async()=>{if(a)try{U(!0),I(null);const R=await Te.getComplaintById(a);o(R)}catch(R){console.error("Error fetching complaint details:",R),I("Failed to load details")}finally{U(!1)}},[a]),J=h.useCallback(async()=>{if(a)try{await ge.markAsRead(a),g(R=>R.map($=>({...$,read:!0}))),s&&s()}catch(R){console.error("Error marking messages as read:",R)}},[a,s]),Y=h.useCallback(()=>{!w||T||A(E+1,!0)},[w,T,E,A]),Pe=()=>{q(!0)},K=async R=>{if(!(!a||!d))try{await Te.updateComplaintStatus(a,{status:R,note:"Status changed from chat interface"}),o({...d,status:R}),Z.success(`Status updated to ${R}`,{icon:"âœ…"}),n&&n(R)}catch($){console.error("Error updating status:",$),Z.error("Failed to update status",{icon:"âŒ"})}},re=(R,$)=>{d&&R===d.id&&o({...d,status:$})},oe=async(R,$)=>{if(a)try{b(!0);const N=await ge.sendMessage(a,{message:R,imageUrl:$});g(_=>[..._,N]),Z.success("Message sent successfully",{icon:"âœ…"})}catch(N){console.error("Error sending message:",N);const _=N instanceof Error?N.message:"Failed to send message";throw Z.error(_,{icon:"âŒ"}),N}finally{b(!1)}},Ue=async(R,$)=>{if(a)try{b(!0);const N=await ge.sendMessageWithFile(a,R,$);g(_=>[..._,N]),Z.success("Message sent successfully",{icon:"âœ…"})}catch(N){console.error("Error sending message with file:",N);const _=N instanceof Error?N.message:"Failed to send message";throw Z.error(_,{icon:"âŒ"}),N}finally{b(!1)}};return h.useEffect(()=>{a&&(g([]),o(null),C(null),P(1),S(!0),A(1),z(),J())},[a,A,z,J]),h.useEffect(()=>{if(!a)return;const R=setInterval(()=>{ge.getChatMessages(a,1,50).then(({messages:$})=>{g(N=>{var Oe;const _=(Oe=N[N.length-1])==null?void 0:Oe.id;return $.some($e=>$e.id>(_||0))?$:N})}).catch($=>{console.error("Error polling messages:",$)})},5e3);return()=>{clearInterval(R)}},[a]),a?e.jsxs(l,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[!r&&(d&&d.user?e.jsxs(l,{sx:{position:"relative"},children:[i&&t&&e.jsx(H,{onClick:t,size:"small",sx:{position:"absolute",top:8,left:8,zIndex:1,backgroundColor:"background.paper",boxShadow:1,"&:hover":{backgroundColor:"background.paper"}},children:e.jsx(jt,{})}),e.jsx($s,{complaint:{id:d.id,trackingNumber:d.trackingNumber||`#${d.id}`,title:d.title,category:d.category,status:d.status,createdAt:new Date(d.createdAt)},citizen:{id:d.user.id,firstName:d.user.firstName,lastName:d.user.lastName,phone:d.user.phone,email:d.user.email,zone:((ae=d.zone)==null?void 0:ae.name)||(typeof d.user.zone=="string"?d.user.zone:(de=d.user.zone)==null?void 0:de.name)||"N/A",district:((ne=d.locationDetails)==null?void 0:ne.district)||((we=d.user.cityCorporation)==null?void 0:we.name)||"N/A",upazila:((ve=d.locationDetails)==null?void 0:ve.thana)||((ue=d.user.thana)==null?void 0:ue.name)||"N/A",ward:((Se=d.locationDetails)==null?void 0:Se.ward)||((Ie=(he=d.wards)==null?void 0:he.wardNumber)==null?void 0:Ie.toString())||(d.user.ward&&typeof d.user.ward=="object"&&"wardNumber"in d.user.ward?(Ee=d.user.ward.wardNumber)==null?void 0:Ee.toString():String(d.user.ward||"N/A")),address:((ke=d.locationDetails)==null?void 0:ke.address)||d.location||"",profilePicture:d.user.avatar||void 0,wardInspector:(Re=d.wards)!=null&&Re.inspectorName?{name:d.wards.inspectorName,phone:d.wards.inspectorPhone||"N/A"}:void 0,zoneOfficer:(Ne=d.zone)!=null&&Ne.officerName?{name:d.zone.officerName,phone:d.zone.officerPhone||"N/A"}:void 0},onViewDetails:Pe,onStatusChange:K})]}):e.jsx(l,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:e.jsxs(l,{sx:{display:"flex",alignItems:"center",gap:1},children:[i&&t&&e.jsx(H,{onClick:t,size:"small",sx:{mr:1},children:e.jsx(jt,{})}),e.jsx(l,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"space-between"},children:V?e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"subtitle1",color:"error",sx:{fontWeight:600},children:"Failed to load chat details"}),e.jsx(H,{size:"small",onClick:z,color:"primary",children:e.jsx(l,{component:"span",sx:{fontSize:14},children:"Retry"})})]}):e.jsx(u,{variant:"subtitle1",sx:{fontWeight:600},children:"Loading..."})})]})})),v&&!y?e.jsx(Os,{error:v,onRetry:()=>A(1,!1),variant:"centered"}):e.jsx(Xs,{messages:f,loading:y,loadingMore:T,hasMoreMessages:w,onLoadMore:Y}),e.jsx(zs,{onSend:oe,onSendWithFile:Ue,sending:D,disabled:!a||y}),d&&e.jsx(Us,{complaintId:d.id,open:F,onClose:()=>q(!1),onStatusUpdate:re})]}):e.jsx(l,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"text.secondary",p:3},children:e.jsx(u,{variant:"body1",children:"Select a chat to start messaging"})})};export{rr as C,Ts as M,Te as a,Us as b,fe as c};
