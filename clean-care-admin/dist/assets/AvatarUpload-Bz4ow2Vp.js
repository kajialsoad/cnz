import{e as G,j as e,cc as Y,r as i,cf as R,l as Z,v as J,F as x,G as $,ak as ee,I as A,T as P,a8 as re,H as M,L as ae,K as te}from"./index-D65jGImX.js";import{C as O}from"./CloudUpload-qDcbyucg.js";const oe=G([e.jsx("circle",{cx:"12",cy:"12",r:"3.2"},"0"),e.jsx("path",{d:"M9 2 7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5"},"1")]),le={maxWidth:800,maxHeight:800,quality:.85,outputFormat:"image/jpeg"};async function ne(t,g={}){const d={...le,...g};return new Promise((c,r)=>{const o=new Image,p=new FileReader;p.onload=a=>{var s;o.src=(s=a.target)==null?void 0:s.result},p.onerror=()=>{r(new Error("Failed to read image file"))},o.onload=()=>{try{const{width:a,height:s}=ie(o.width,o.height,d.maxWidth,d.maxHeight),f=document.createElement("canvas");f.width=a,f.height=s;const u=f.getContext("2d");if(!u){r(new Error("Failed to get canvas context"));return}u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(o,0,0,a,s),f.toBlob(m=>{if(!m){r(new Error("Failed to compress image"));return}const v=new File([m],t.name.replace(/\.[^/.]+$/,".jpg"),{type:d.outputFormat,lastModified:Date.now()}),C=(t.size/1024).toFixed(2),E=(v.size/1024).toFixed(2),k=((t.size-v.size)/t.size*100).toFixed(1);console.log("Image compression:",{original:`${C} KB`,compressed:`${E} KB`,reduction:`${k}%`,dimensions:`${a}x${s}`}),c(v)},d.outputFormat,d.quality)}catch(a){r(a)}},o.onerror=()=>{r(new Error("Failed to load image"))},p.readAsDataURL(t)})}function ie(t,g,d,c){let r=t,o=g;if(r>d||o>c){const p=r/o;r>o?(r=d,o=Math.round(r/p)):(o=c,r=Math.round(o*p)),r>d&&(r=d,o=Math.round(r/p)),o>c&&(o=c,r=Math.round(o*p))}return{width:r,height:o}}const se=5,ce=["image/jpeg","image/jpg","image/png","image/webp"],T=[".jpg",".jpeg",".png",".webp"],de=t=>{const{uploadAvatar:g}=Y(),[d,c]=i.useState(!1),[r,o]=i.useState(0),[p,a]=i.useState(null),[s,f]=i.useState(null),u=(t==null?void 0:t.maxSizeInMB)??se,m=(t==null?void 0:t.allowedTypes)??ce,v=i.useCallback(h=>{try{s&&URL.revokeObjectURL(s);const n=R(h,{maxSizeInMB:u,allowedTypes:m,allowedExtensions:T});if(n){a(n);return}const U=URL.createObjectURL(h);f(U),a(null)}catch(n){console.error("Failed to generate preview:",n),a("Failed to generate image preview")}},[s,u,m]),C=i.useCallback(()=>{if(s){try{URL.revokeObjectURL(s)}catch(h){console.error("Failed to revoke preview URL:",h)}f(null)}},[s]),E=i.useCallback(async h=>{var n,U;c(!0),o(0),a(null);try{const b=R(h,{maxSizeInMB:u,allowedTypes:m,allowedExtensions:T});if(b)throw new Error(b);o(10),await ue(h),o(20);const w=await ne(h,{maxWidth:800,maxHeight:800,quality:.85});o(40);const y=await g(w);if(o(90),!y||!pe(y))throw new Error("Invalid avatar URL received from server");return o(100),(n=t==null?void 0:t.onSuccess)==null||n.call(t,y),y}catch(b){const w=b instanceof Error?b.message:"Failed to upload avatar";throw a(w),(U=t==null?void 0:t.onError)==null||U.call(t,w),b}finally{c(!1),setTimeout(()=>o(0),1e3)}},[g,u,m,t]),k=i.useCallback(()=>{a(null)},[]);return{uploadAvatar:E,isUploading:d,uploadProgress:r,uploadError:p,previewUrl:s,clearUploadError:k,generatePreview:v,clearPreview:C}};async function ue(t){return new Promise((g,d)=>{const c=new FileReader;c.onload=r=>{var f;const o=new Uint8Array((f=r.target)==null?void 0:f.result).subarray(0,4);let p="";for(let u=0;u<o.length;u++)p+=o[u].toString(16);Object.keys({ffd8ff:["image/jpeg"],"89504e47":["image/png"],52494646:["image/webp"]}).some(u=>p.startsWith(u))?g():d(new Error("File is not a valid image"))},c.onerror=()=>{d(new Error("Failed to read file"))},c.readAsArrayBuffer(t.slice(0,4))})}function pe(t){try{const g=new URL(t);return g.protocol==="http:"||g.protocol==="https:"}catch{return!1}}const me=({currentAvatar:t,onUpload:g,size:d=120,initials:c="?",disabled:r=!1,maxSizeInMB:o=5,allowedTypes:p=["image/jpeg","image/jpg","image/png","image/webp"]})=>{const a=Z(),s=J(a.breakpoints.down("sm")),f=i.useRef(null),[u,m]=i.useState(!1),[v,C]=i.useState(null),[E,k]=i.useState(!1),{uploadAvatar:h,isUploading:n,uploadProgress:U,uploadError:b,previewUrl:w,clearUploadError:y,generatePreview:z,clearPreview:F}=de({maxSizeInMB:o,allowedTypes:p,onSuccess:async l=>{await g(l),k(!1),F(),C(null)},onError:l=>{console.error("Upload error:",l)}}),j=s?Math.min(d,100):d,D=i.useCallback(l=>{r||n||(C(l),z(l),k(!0))},[r,n,z]),B=i.useCallback(l=>{var I;const S=(I=l.target.files)==null?void 0:I[0];S&&D(S),l.target.value=""},[D]),_=i.useCallback(()=>{var l;r||n||(l=f.current)==null||l.click()},[r,n]),W=i.useCallback(l=>{l.preventDefault(),l.stopPropagation(),!r&&!n&&m(!0)},[r,n]),V=i.useCallback(l=>{l.preventDefault(),l.stopPropagation(),m(!1)},[]),q=i.useCallback(l=>{l.preventDefault(),l.stopPropagation()},[]),K=i.useCallback(l=>{var I;if(l.preventDefault(),l.stopPropagation(),m(!1),r||n)return;const S=(I=l.dataTransfer.files)==null?void 0:I[0];S&&D(S)},[r,n,D]),N=i.useCallback(async()=>{if(!(!w||!v))try{await h(v)}catch(l){console.error("Upload failed:",l)}},[w,v,h]),L=i.useCallback(()=>{k(!1),F(),y(),C(null)},[F,y]);i.useEffect(()=>()=>{F()},[F]);const H=()=>n?e.jsx(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.7)",borderRadius:"50%",zIndex:2},children:e.jsxs(x,{sx:{position:"relative",display:"inline-flex"},children:[e.jsx(te,{variant:"determinate",value:U,size:j*.4,sx:{color:"#fff"}}),e.jsx(x,{sx:{position:"absolute",top:0,left:0,bottom:0,right:0,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(P,{variant:"caption",component:"div",sx:{color:"#fff",fontWeight:600},children:`${Math.round(U)}%`})})]})}):null,Q=()=>!E||!w?null:e.jsxs(re,{elevation:8,role:"dialog","aria-modal":"true","aria-labelledby":"avatar-preview-title",sx:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:1300,p:3,maxWidth:s?"90vw":400,width:"100%"},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(P,{variant:"h6",id:"avatar-preview-title",children:"Preview Avatar"}),e.jsx(A,{size:"small",onClick:L,disabled:n,"aria-label":"Close preview",children:e.jsx(M,{"aria-hidden":"true"})})]}),e.jsx(x,{sx:{display:"flex",justifyContent:"center",mb:2},children:e.jsx($,{src:w,alt:"Preview of new profile picture",sx:{width:s?150:200,height:s?150:200,border:`4px solid ${a.palette.primary.main}`},role:"img","aria-label":"Preview of new profile picture"})}),b&&e.jsx(ae,{severity:"error",sx:{mb:2},onClose:y,children:b}),e.jsxs(x,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[e.jsxs(A,{onClick:L,disabled:n,"aria-label":"Cancel avatar upload",sx:{border:`1px solid ${a.palette.divider}`,borderRadius:1,px:2,"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:[e.jsx(P,{variant:"button",sx:{mr:1},children:"Cancel"}),e.jsx(M,{fontSize:"small","aria-hidden":"true"})]}),e.jsxs(A,{onClick:N,disabled:n,"aria-label":n?"Uploading avatar":"Confirm and upload avatar","aria-busy":n,sx:{background:a.palette.primary.main,color:"#fff",borderRadius:1,px:2,"&:hover":{background:a.palette.primary.dark},"&:disabled":{background:a.palette.action.disabledBackground},"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:[e.jsx(P,{variant:"button",sx:{mr:1},children:n?"Uploading...":"Upload"}),e.jsx(O,{fontSize:"small","aria-hidden":"true"})]})]})]}),X=()=>E?e.jsx(x,{onClick:L,sx:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1299}}):null;return e.jsxs(e.Fragment,{children:[e.jsxs(x,{sx:{position:"relative",display:"inline-block"},children:[e.jsx("input",{ref:f,type:"file",accept:p.join(","),onChange:B,style:{display:"none"},disabled:r||n,"aria-label":"Upload profile picture",id:"avatar-upload-input"}),e.jsxs(x,{onDragEnter:W,onDragLeave:V,onDragOver:q,onDrop:K,sx:{position:"relative",cursor:r||n?"not-allowed":"pointer",opacity:r?.6:1},children:[e.jsx($,{src:t,alt:`Current profile picture${c?` (${c})`:""}`,sx:{width:j,height:j,fontSize:j*.4,border:u?`3px dashed ${a.palette.primary.main}`:`3px solid ${a.palette.divider}`,transition:"all 0.2s ease-in-out",backgroundColor:a.palette.grey[300]},role:"img","aria-label":`Profile picture${c?` showing initials ${c}`:""}`,children:c}),e.jsx(x,{role:"status","aria-live":"polite","aria-atomic":"true",children:H()}),u&&e.jsx(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(25, 118, 210, 0.1)",borderRadius:"50%",zIndex:1},role:"status","aria-label":"Drop file to upload",children:e.jsx(O,{sx:{fontSize:j*.4,color:a.palette.primary.main},"aria-hidden":"true"})}),!n&&e.jsx(ee,{title:"Upload new avatar",arrow:!0,children:e.jsx(A,{onClick:_,disabled:r,"aria-label":"Upload new profile picture",component:"label",htmlFor:"avatar-upload-input",sx:{position:"absolute",bottom:0,right:0,backgroundColor:a.palette.primary.main,color:"#fff",width:j*.3,height:j*.3,"&:hover":{backgroundColor:a.palette.primary.dark},"&:disabled":{backgroundColor:a.palette.action.disabledBackground},"&:focus-visible":{outline:`2px solid ${a.palette.primary.main}`,outlineOffset:"2px"}},children:e.jsx(oe,{sx:{fontSize:j*.15},"aria-hidden":"true"})})})]}),!s&&e.jsx(P,{variant:"caption",sx:{display:"block",textAlign:"center",mt:1,color:a.palette.text.secondary},children:"Click or drag to upload"})]}),X(),Q()]})};export{me as A};
