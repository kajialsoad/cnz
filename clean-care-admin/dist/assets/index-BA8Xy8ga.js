var Be=Object.defineProperty;var Ue=(t,s,n)=>s in t?Be(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n;var pe=(t,s,n)=>Ue(t,typeof s!="symbol"?s+"":s,n);import{e as he,j as e,r as o,F as x,y as We,z as Y,G as Ae,T as z,ai as X,an as ie,P as V,l as fe,v as oe,aB as Ve,N as De,O as Se,ab as Ge,U as ge,V as be,W as K,aa as Ze,a1 as Ye,I as re,X as qe,av as Je,ax as Ke,ay as Xe,aH as _e,a6 as Qe,A as et,b4 as tt,H as Fe,K as xe,a7 as st,aj as ze,Q as L,L as rt,a8 as ye,b5 as Ie,w as te,as as nt,$ as ot,a4 as it}from"./index-DeUEnMZz.js";import{u as at,E as lt,a as ct,b as dt}from"./useDebounce-BWOmAok2.js";import{f as ut}from"./dateUtils-BJb4DEFQ.js";import{C as ke}from"./ChatBubbleOutline-CIRYRBKO.js";import{S as xt}from"./SearchOff--D1JQ6n9.js";import{w as ht}from"./wardService-GBSQYL9j.js";import{F as ft}from"./FilterList-D2MNHuoQ.js";import{I as mt,a as Ee}from"./categoryService-oHOqZNfH.js";import{C as pt}from"./Collapse-Bcskhq6s.js";import{D as gt}from"./DoneAll-_jSx6J_w.js";import{S as bt}from"./Send-DGu9YltK.js";import{A as Ne}from"./ArrowBack-CxdVjWNQ.js";import"./Person-DMojptl5.js";import"./Download-CrG_CMYD.js";import"./Grid-kRAokODX.js";import"./styled-CVTyowA6.js";import"./useThemeProps-C2aBZQ1b.js";const yt=he(e.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})),vt=he(e.jsx("path",{d:"M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"})),wt=he(e.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"})),Ct=he(e.jsx("path",{d:"M4 4h16v12H5.17L4 17.17zm0-2c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm2 10h12v2H6zm0-3h12v2H6zm0-3h12v2H6z"})),ce=typeof window<"u"?o.useLayoutEffect:o.useEffect;function Me(t){if(t!==void 0)switch(typeof t){case"number":return t;case"string":{if(t.endsWith("px"))return parseFloat(t);break}}}function jt({box:t,defaultHeight:s,defaultWidth:n,disabled:l,element:c,mode:i,style:a}){const{styleHeight:r,styleWidth:u}=o.useMemo(()=>({styleHeight:Me(a==null?void 0:a.height),styleWidth:Me(a==null?void 0:a.width)}),[a==null?void 0:a.height,a==null?void 0:a.width]),[h,f]=o.useState({height:s,width:n}),p=l||r!==void 0||i==="only-width"||r!==void 0&&u!==void 0;return ce(()=>{if(c===null||p)return;const m=new ResizeObserver(g=>{for(const w of g){const{contentRect:M,target:b}=w;c===b&&f(I=>I.height===M.height&&I.width===M.width?I:{height:M.height,width:M.width})}});return m.observe(c,{box:t}),()=>{m==null||m.unobserve(c)}},[t,p,c,r,u]),o.useMemo(()=>({height:r??h.height,width:u??h.width}),[h,r,u])}function Le(t){const s=o.useRef(()=>{throw new Error("Cannot call during render.")});return ce(()=>{s.current=t},[t]),o.useCallback(n=>{var l;return(l=s.current)==null?void 0:l.call(s,n)},[s])}function ve({containerElement:t,direction:s,isRtl:n,scrollOffset:l}){return l}function Q(t,s="Assertion error"){if(!t)throw console.error(s),Error(s)}function le(t,s){if(t===s)return!0;if(!!t!=!!s||(Q(t!==void 0),Q(s!==void 0),Object.keys(t).length!==Object.keys(s).length))return!1;for(const n in t)if(!Object.is(s[n],t[n]))return!1;return!0}function $e({cachedBounds:t,itemCount:s,itemSize:n}){if(s===0)return 0;if(typeof n=="number")return s*n;{const l=t.get(t.size===0?0:t.size-1);Q(l!==void 0,"Unexpected bounds cache miss");const c=(l.scrollOffset+l.size)/t.size;return s*c}}function St({align:t,cachedBounds:s,index:n,itemCount:l,itemSize:c,containerScrollOffset:i,containerSize:a}){if(n<0||n>=l)throw RangeError(`Invalid index specified: ${n}`,{cause:`Index ${n} is not within the range of 0 - ${l-1}`});const r=$e({cachedBounds:s,itemCount:l,itemSize:c}),u=s.get(n),h=Math.max(0,Math.min(r-a,u.scrollOffset)),f=Math.max(0,u.scrollOffset-a+u.size);switch(t==="smart"&&(i>=f&&i<=h?t="auto":t="center"),t){case"start":return h;case"end":return f;case"center":return u.scrollOffset<=a/2?0:u.scrollOffset+u.size/2>=r-a/2?r-a:u.scrollOffset+u.size/2-a/2;case"auto":default:return i>=f&&i<=h?i:i<f?f:h}}function Oe({cachedBounds:t,containerScrollOffset:s,containerSize:n,itemCount:l,overscanCount:c}){const i=l-1;let a=0,r=-1,u=0,h=-1,f=0;for(;f<i;){const p=t.get(f);if(p.scrollOffset+p.size>s)break;f++}for(a=f,u=Math.max(0,a-c);f<i;){const p=t.get(f);if(p.scrollOffset+p.size>=s+n)break;f++}return r=Math.min(i,f),h=Math.min(l-1,r+c),a<0&&(a=0,r=-1,u=0,h=-1),{startIndexVisible:a,stopIndexVisible:r,startIndexOverscan:u,stopIndexOverscan:h}}function zt({itemCount:t,itemProps:s,itemSize:n}){const l=new Map;return{get(c){for(Q(c<t,`Invalid index ${c}`);l.size-1<c;){const a=l.size;let r;switch(typeof n){case"function":{r=n(a,s);break}case"number":{r=n;break}}if(a===0)l.set(a,{size:r,scrollOffset:0});else{const u=l.get(a-1);Q(u!==void 0,`Unexpected bounds cache miss for index ${c}`),l.set(a,{scrollOffset:u.scrollOffset+u.size,size:r})}}const i=l.get(c);return Q(i!==void 0,`Unexpected bounds cache miss for index ${c}`),i},set(c,i){l.set(c,i)},get size(){return l.size}}}function It({itemCount:t,itemProps:s,itemSize:n}){return o.useMemo(()=>zt({itemCount:t,itemProps:s,itemSize:n}),[t,s,n])}function kt({containerSize:t,itemSize:s}){let n;switch(typeof s){case"string":{Q(s.endsWith("%"),`Invalid item size: "${s}"; string values must be percentages (e.g. "100%")`),Q(t!==void 0,"Container size must be defined if a percentage item size is specified"),n=t*parseInt(s)/100;break}default:{n=s;break}}return n}function Et({containerElement:t,containerStyle:s,defaultContainerSize:n=0,direction:l,isRtl:c=!1,itemCount:i,itemProps:a,itemSize:r,onResize:u,overscanCount:h}){const[f,p]=o.useState({startIndexVisible:0,startIndexOverscan:0,stopIndexVisible:-1,stopIndexOverscan:-1}),{startIndexVisible:m,startIndexOverscan:g,stopIndexVisible:w,stopIndexOverscan:M}={startIndexVisible:Math.min(i-1,f.startIndexVisible),startIndexOverscan:Math.min(i-1,f.startIndexOverscan),stopIndexVisible:Math.min(i-1,f.stopIndexVisible),stopIndexOverscan:Math.min(i-1,f.stopIndexOverscan)},{height:b=n,width:I=n}=jt({defaultHeight:n,defaultWidth:void 0,element:t,mode:"only-height",style:s}),T=o.useRef({height:0,width:0}),D=b,W=kt({containerSize:D,itemSize:r});o.useLayoutEffect(()=>{if(typeof u=="function"){const j=T.current;(j.height!==b||j.width!==I)&&(u({height:b,width:I},{...j}),j.height=b,j.width=I)}},[b,u,I]);const F=It({itemCount:i,itemProps:a,itemSize:W}),C=o.useCallback(j=>F.get(j),[F]),R=o.useCallback(()=>$e({cachedBounds:F,itemCount:i,itemSize:W}),[F,i,W]),S=o.useCallback(j=>{const A=ve({containerElement:t,direction:l,isRtl:c,scrollOffset:j});return Oe({cachedBounds:F,containerScrollOffset:A,containerSize:D,itemCount:i,overscanCount:h})},[F,t,D,l,c,i,h]);ce(()=>{const j=(t==null?void 0:t.scrollTop)??0;p(S(j))},[t,l,S]),ce(()=>{if(!t)return;const j=()=>{p(A=>{const{scrollLeft:P,scrollTop:O}=t,N=ve({containerElement:t,direction:l,isRtl:c,scrollOffset:O}),$=Oe({cachedBounds:F,containerScrollOffset:N,containerSize:D,itemCount:i,overscanCount:h});return le($,A)?A:$})};return t.addEventListener("scroll",j),()=>{t.removeEventListener("scroll",j)}},[F,t,D,l,i,h]);const E=Le(({align:j="auto",containerScrollOffset:A,index:P})=>{let O=St({align:j,cachedBounds:F,containerScrollOffset:A,containerSize:D,index:P,itemCount:i,itemSize:W});if(t){if(O=ve({containerElement:t,direction:l,isRtl:c,scrollOffset:O}),typeof t.scrollTo!="function"){const N=S(O);le(f,N)||p(N)}return O}});return{getCellBounds:C,getEstimatedSize:R,scrollToIndex:E,startIndexOverscan:g,startIndexVisible:m,stopIndexOverscan:M,stopIndexVisible:w}}function Nt(t){return o.useMemo(()=>t,Object.values(t))}function Mt(t,s){const{ariaAttributes:n,style:l,...c}=t,{ariaAttributes:i,style:a,...r}=s;return le(n,i)&&le(l,a)&&le(c,r)}function Ot(t){return t!=null&&typeof t=="object"&&"getAverageRowHeight"in t&&typeof t.getAverageRowHeight=="function"}const we="data-react-window-index";function Pe({children:t,className:s,defaultHeight:n=0,listRef:l,onResize:c,onRowsRendered:i,overscanCount:a=3,rowComponent:r,rowCount:u,rowHeight:h,rowProps:f,tagName:p="div",style:m,...g}){const w=Nt(f),M=o.useMemo(()=>o.memo(r,Mt),[r]),[b,I]=o.useState(null),T=Ot(h),D=o.useMemo(()=>T?O=>h.getRowHeight(O)??h.getAverageRowHeight():h,[T,h]),{getCellBounds:W,getEstimatedSize:F,scrollToIndex:C,startIndexOverscan:R,startIndexVisible:S,stopIndexOverscan:E,stopIndexVisible:j}=Et({containerElement:b,containerStyle:m,defaultContainerSize:n,direction:"vertical",itemCount:u,itemProps:w,itemSize:D,onResize:c,overscanCount:a});o.useImperativeHandle(l,()=>({get element(){return b},scrollToRow({align:O="auto",behavior:N="auto",index:$}){const B=C({align:O,containerScrollOffset:(b==null?void 0:b.scrollTop)??0,index:$});typeof(b==null?void 0:b.scrollTo)=="function"&&b.scrollTo({behavior:N,top:B})}}),[b,C]),ce(()=>{if(!b)return;const O=Array.from(b.children).filter((N,$)=>{if(N.hasAttribute("aria-hidden"))return!1;const B=`${R+$}`;return N.setAttribute(we,B),!0});if(T)return h.observeRowElements(O)},[b,T,h,R,E]),o.useEffect(()=>{R>=0&&E>=0&&i&&i({startIndex:S,stopIndex:j},{startIndex:R,stopIndex:E})},[i,R,S,E,j]);const A=o.useMemo(()=>{const O=[];if(u>0)for(let N=R;N<=E;N++){const $=W(N);O.push(o.createElement(M,{...w,ariaAttributes:{"aria-posinset":N+1,"aria-setsize":u,role:"listitem"},key:N,index:N,style:{position:"absolute",left:0,transform:`translateY(${$.scrollOffset}px)`,height:T?void 0:$.size,width:"100%"}}))}return O},[M,W,T,u,w,R,E]),P=e.jsx("div",{"aria-hidden":!0,style:{height:F(),width:"100%",zIndex:-1}});return o.createElement(p,{role:"list",...g,className:s,ref:I,style:{position:"relative",maxHeight:"100%",flexGrow:1,overflowY:"auto",...m}},A,t,P)}function Rt({defaultRowHeight:t,key:s}){const[n,l]=o.useState({key:s,map:new Map});n.key!==s&&l({key:s,map:new Map});const{map:c}=n,i=o.useCallback(()=>{let p=0;return c.forEach(m=>{p+=m}),p===0?t:p/c.size},[t,c]),a=o.useCallback(p=>{const m=c.get(p);return m!==void 0?m:(c.set(p,t),t)},[t,c]),r=o.useCallback((p,m)=>{l(g=>{if(g.map.get(p)===m)return g;const w=new Map(g.map);return w.set(p,m),{...g,map:w}})},[]),u=Le(p=>{p.length!==0&&p.forEach(m=>{const{borderBoxSize:g,target:w}=m,M=w.getAttribute(we);Q(M!==null,`Invalid ${we} attribute value`);const b=parseInt(M),{blockSize:I}=g[0];I&&r(b,I)})}),[h]=o.useState(()=>new ResizeObserver(u));o.useEffect(()=>()=>{h.disconnect()},[h]);const f=o.useCallback(p=>(p.forEach(m=>h.observe(m)),()=>{p.forEach(m=>h.unobserve(m))}),[h]);return o.useMemo(()=>({getAverageRowHeight:i,getRowHeight:a,setRowHeight:r,observeRowElements:f}),[i,a,r,f])}const Re=({chat:t,isSelected:s,onClick:n})=>{const l=()=>`${t.citizen.firstName.charAt(0)}${t.citizen.lastName.charAt(0)}`,c=(r,u=50)=>r.length<=u?r:`${r.substring(0,u)}...`,i=()=>{switch(t.complaintStatus){case"PENDING":return"#FF9800";case"IN_PROGRESS":return"#2196F3";case"RESOLVED":return"#4CAF50";case"REJECTED":return"#f44336";default:return"#9E9E9E"}},a=()=>{switch(t.complaintStatus){case"PENDING":return"Pending";case"IN_PROGRESS":return"In Progress";case"RESOLVED":return"Solved";case"REJECTED":return"Rejected";default:return t.complaintStatus}};return e.jsx(x,{onClick:n,sx:{p:{xs:1.5,sm:2,md:2},borderBottom:"1px solid",borderColor:"divider",cursor:"pointer",backgroundColor:s?"action.selected":"transparent",transition:`all ${Y.fast.duration} ${Y.fast.timing}`,animation:`${We} ${Y.normal.duration} ${Y.normal.timing}`,"&:hover":{backgroundColor:s?"action.selected":"action.hover",transform:"translateX(4px)",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.08)"}},children:e.jsxs(x,{sx:{display:"flex",gap:1.5},children:[e.jsx(Ae,{src:t.citizen.profilePicture,sx:{width:40,height:40,bgcolor:"#4CAF50",color:"white",fontWeight:600,fontSize:"0.875rem",flexShrink:0},children:l()}),e.jsxs(x,{sx:{flex:1,minWidth:0},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:.5,gap:1},children:[e.jsxs(z,{variant:"subtitle2",sx:{fontWeight:t.unreadCount>0?600:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1},children:[t.citizen.firstName," ",t.citizen.lastName]}),e.jsx(z,{variant:"caption",color:"text.secondary",sx:{flexShrink:0,fontSize:"0.7rem"},children:ut(t.lastMessage.timestamp.toString())})]}),e.jsxs(z,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:["#",t.trackingNumber," ‚Ä¢ ",t.complaintTitle]}),e.jsxs(z,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontSize:"0.7rem"},children:["üìç ",t.citizen.cityCorporationName||t.citizen.district,t.citizen.thanaName&&`, ${t.citizen.thanaName}`,!t.citizen.cityCorporationName&&`, ${t.citizen.upazila}`]}),e.jsxs(x,{sx:{display:"flex",gap:.5,mb:.5,flexWrap:"wrap"},children:[t.citizen.zone&&e.jsx(X,{label:`Zone ${t.citizen.zone}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem",color:"text.secondary",borderColor:"divider",backgroundColor:"action.hover"}}),t.citizen.ward&&e.jsx(X,{label:`Ward ${t.citizen.ward}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem",color:"text.secondary",borderColor:"divider",backgroundColor:"action.hover"}})]}),e.jsx(z,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:t.unreadCount>0?500:400,fontSize:"0.875rem",mb:.5},children:c(t.lastMessage.text,50)}),e.jsxs(x,{sx:{display:"flex",gap:.5,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(X,{label:a(),size:"small",sx:{height:20,fontSize:"0.7rem",fontWeight:500,backgroundColor:i(),color:"white"}}),t.isNew&&e.jsx(X,{label:"New",size:"small",sx:{height:20,fontSize:"0.7rem",fontWeight:600,backgroundColor:"#FF5722",color:"white"}}),t.unreadCount>0&&e.jsx(X,{label:t.unreadCount,size:"small",sx:{height:20,minWidth:20,backgroundColor:"#4CAF50",color:"white",fontSize:"0.7rem",fontWeight:600}})]})]})]})})},Tt=({count:t=5})=>e.jsx(x,{sx:{p:2},children:Array.from({length:t}).map((s,n)=>e.jsx(x,{sx:{mb:2},children:e.jsxs(x,{sx:{display:"flex",gap:1.5,mb:1},children:[e.jsx(ie,{variant:"circular",width:48,height:48}),e.jsxs(x,{sx:{flex:1},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",mb:.5},children:[e.jsx(ie,{variant:"text",width:"60%",height:20}),e.jsx(ie,{variant:"text",width:"20%",height:16})]}),e.jsx(ie,{variant:"text",width:"40%",height:16,sx:{mb:.5}}),e.jsx(ie,{variant:"text",width:"80%",height:16})]})]})},n))}),Ce=({type:t,onAction:s,actionLabel:n})=>{const c=(()=>{switch(t){case"no-chats":return{icon:e.jsx(ke,{sx:{fontSize:64,color:"text.disabled"}}),title:"No conversations yet",description:"Chat conversations will appear here when citizens message you about their complaints.",showAction:!1};case"no-messages":return{icon:e.jsx(Ct,{sx:{fontSize:64,color:"text.disabled"}}),title:"No messages yet",description:"Start the conversation by sending a message below.",showAction:!1};case"no-results":return{icon:e.jsx(xt,{sx:{fontSize:64,color:"text.disabled"}}),title:"No results found",description:"Try adjusting your search or filters to find what you're looking for.",showAction:!0};default:return{icon:e.jsx(ke,{sx:{fontSize:64,color:"text.disabled"}}),title:"Nothing here",description:"",showAction:!1}}})();return e.jsxs(x,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:{xs:4,sm:6,md:8},px:3,textAlign:"center"},children:[e.jsx(x,{sx:{mb:2},children:c.icon}),e.jsx(z,{variant:"h6",color:"text.secondary",sx:{mb:1,fontWeight:500,fontSize:{xs:"1rem",sm:"1.25rem"}},children:c.title}),c.description&&e.jsx(z,{variant:"body2",color:"text.secondary",sx:{mb:c.showAction?3:0,maxWidth:400,lineHeight:1.6},children:c.description}),c.showAction&&s&&e.jsx(V,{variant:"outlined",size:"small",onClick:s,sx:{textTransform:"none"},children:n||"Clear Filters"})]})},Wt=({chats:t,selectedChatId:s,onChatSelect:n,searchTerm:l,onSearchChange:c,filters:i,onFilterChange:a,statistics:r,loading:u,currentPage:h=1,totalPages:f=1,totalChats:p=0,onPageChange:m,onNextPage:g,onPrevPage:w})=>{const M=fe(),b=oe(M.breakpoints.down("sm")),[I,T]=o.useState(l),[D,W]=o.useState([]),[F,C]=o.useState([]),[R,S]=o.useState(!1),[E,j]=o.useState(!1),A=at(I,500);Ve.useEffect(()=>{c(A)},[A,c]),o.useEffect(()=>{(async()=>{try{S(!0);const k=await Ye.getCityCorporations("ACTIVE");W(k.cityCorporations||[])}catch(k){console.error("Error fetching city corporations:",k),W([])}finally{S(!1)}})()},[]),o.useEffect(()=>{(async()=>{const k=i.zone?parseInt(i.zone,10):void 0;if(!k){C([]);return}try{j(!0);const y=await ht.getWardsByZone(k,"ACTIVE");C(y)}catch(y){console.error("Error fetching wards:",y),C([])}finally{j(!1)}})()},[i.zone]);const P=d=>{T(d.target.value)},O=d=>{a({ward:d==="ALL"?void 0:d})},N=d=>{a({zone:d===""?void 0:d.toString()})},$=d=>{a({cityCorporationCode:d==="ALL"?void 0:d,thanaId:void 0,zone:void 0,ward:void 0})},B=d=>{a({status:d==="ALL"?void 0:d})},G=()=>{a({unreadOnly:!i.unreadOnly})},q=()=>{T(""),c(""),a({district:void 0,upazila:void 0,ward:void 0,zone:void 0,cityCorporationCode:void 0,thanaId:void 0,status:void 0,unreadOnly:!1})},ee=()=>I!==""||i.district!==void 0||i.upazila!==void 0||i.ward!==void 0||i.zone!==void 0||i.cityCorporationCode!==void 0||i.thanaId!==void 0||i.status!==void 0||i.unreadOnly===!0;o.useCallback(()=>r.byDistrict.map(d=>d.category),[r.byDistrict]),o.useCallback(()=>r.byUpazila.map(d=>d.category),[r.byUpazila]);const ne=o.useCallback(()=>{var d;return((d=r.byWard)==null?void 0:d.map(k=>k.category))||[]},[r.byWard]);return o.useCallback(()=>{var d;return((d=r.byZone)==null?void 0:d.map(k=>Number(k.category)))||[]},[r.byZone]),e.jsxs(x,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs(x,{sx:{p:{xs:1.5,sm:2,md:2},borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(z,{variant:"h6",sx:{fontWeight:600,mb:1.5,fontSize:{xs:"1.1rem",sm:"1.25rem",md:"1.25rem"}},children:"Messages"}),e.jsxs(x,{sx:{display:"flex",gap:1.5,mb:2},children:[e.jsx(X,{label:`${r.totalChats} Total`,size:"small",sx:{backgroundColor:"#e3f2fd",color:"#1976d2",fontWeight:500}}),e.jsx(X,{label:`${r.unreadCount} Unread`,size:"small",sx:{backgroundColor:"#4CAF50",color:"white",fontWeight:500}})]}),e.jsx(De,{fullWidth:!0,placeholder:b?"Search...":"Search conversations...",value:I,onChange:P,size:"small",slotProps:{input:{startAdornment:e.jsx(Se,{position:"start",children:e.jsx(Ge,{sx:{color:"text.secondary",fontSize:20}})})}},sx:{mb:1.5,"& .MuiOutlinedInput-root":{backgroundColor:"background.default"}}}),e.jsxs(x,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsx(ge,{fullWidth:!0,size:"small",children:e.jsxs(be,{value:i.cityCorporationCode||"ALL",onChange:d=>$(d.target.value),displayEmpty:!0,disabled:R,startAdornment:e.jsx(Se,{position:"start",children:e.jsx(ft,{sx:{color:"text.secondary",fontSize:18}})}),sx:{backgroundColor:"background.default","& .MuiSelect-select":{display:"flex",alignItems:"center",pl:0,fontSize:"0.875rem"}},children:[e.jsx(K,{value:"ALL",children:"All City Corporations"}),D&&D.map(d=>e.jsx(K,{value:d.code,children:d.name},d.code))]})}),e.jsx(ge,{fullWidth:!0,size:"small",children:e.jsxs(be,{value:i.ward||"ALL",onChange:d=>O(d.target.value),displayEmpty:!0,sx:{backgroundColor:"background.default",fontSize:"0.875rem"},children:[e.jsx(K,{value:"ALL",children:"All Wards"}),ne().map(d=>e.jsxs(K,{value:d,children:["Ward ",d]},d))]})}),e.jsx(Ze,{value:i.zone?Number(i.zone):"",onChange:N,cityCorporationCode:i.cityCorporationCode||"",disabled:!1}),e.jsx(ge,{fullWidth:!0,size:"small",children:e.jsxs(be,{value:i.status||"ALL",onChange:d=>B(d.target.value),displayEmpty:!0,sx:{backgroundColor:"background.default",fontSize:"0.875rem"},children:[e.jsx(K,{value:"ALL",children:"All Status"}),e.jsx(K,{value:"PENDING",children:"Pending"}),e.jsx(K,{value:"IN_PROGRESS",children:"In Progress"}),e.jsx(K,{value:"RESOLVED",children:"Solved"}),e.jsx(K,{value:"REJECTED",children:"Rejected"})]})}),e.jsx(V,{fullWidth:!0,variant:i.unreadOnly?"contained":"outlined",size:"small",onClick:G,sx:{textTransform:"none",fontSize:"0.875rem",backgroundColor:i.unreadOnly?"#4CAF50":"transparent",borderColor:i.unreadOnly?"#4CAF50":"divider",color:i.unreadOnly?"white":"text.primary","&:hover":{backgroundColor:i.unreadOnly?"#45a049":"action.hover",borderColor:i.unreadOnly?"#45a049":"#4CAF50"}},children:i.unreadOnly?"‚úì Unread Only":"Show Unread Only"}),ee()&&e.jsx(V,{fullWidth:!0,variant:"text",size:"small",startIcon:e.jsx(yt,{}),onClick:q,sx:{textTransform:"none",fontSize:"0.875rem",color:"text.secondary","&:hover":{color:"error.main"}},children:"Clear Filters"})]})]}),e.jsxs(x,{sx:{flex:1,overflowY:"auto",overflowX:"hidden"},children:[u&&e.jsx(Tt,{count:5}),!u&&t.length===0&&ee()&&e.jsx(Ce,{type:"no-results",onAction:q,actionLabel:"Clear Filters"}),!u&&t.length===0&&!ee()&&e.jsx(Ce,{type:"no-chats"}),!u&&t.length>0&&e.jsx(e.Fragment,{children:t.length>100?e.jsx(Pe,{rowCount:t.length,rowHeight:b?90:100,overscanCount:5,rowComponent:({index:d,style:k})=>{const y=t[d];return e.jsx("div",{style:k,children:e.jsx(Re,{chat:y,isSelected:s===y.complaintId,onClick:()=>n(y.complaintId)},y.complaintId)})},rowProps:{},style:{height:window.innerHeight-400}}):e.jsx(x,{children:t.map(d=>e.jsx(Re,{chat:d,isSelected:s===d.complaintId,onClick:()=>n(d.complaintId)},d.complaintId))})})]}),!u&&t.length>0&&f>1&&e.jsxs(x,{sx:{p:2,borderTop:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column",gap:1.5,backgroundColor:"background.paper"},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",fontSize:"0.875rem",color:"text.secondary"},children:[e.jsxs(z,{variant:"body2",children:["Page ",h," of ",f]}),e.jsxs(z,{variant:"body2",children:["Total: ",p," chats"]})]}),e.jsxs(x,{sx:{display:"flex",gap:1,justifyContent:"space-between"},children:[e.jsx(V,{variant:"outlined",size:"small",onClick:w,disabled:h===1,sx:{flex:1,textTransform:"none",fontSize:"0.875rem"},children:"‚Üê Previous"}),e.jsx(V,{variant:"outlined",size:"small",onClick:g,disabled:h===f,sx:{flex:1,textTransform:"none",fontSize:"0.875rem"},children:"Next ‚Üí"})]}),!b&&f>3&&e.jsxs(x,{sx:{display:"flex",gap:.5,justifyContent:"center",flexWrap:"wrap"},children:[h>2&&e.jsxs(e.Fragment,{children:[e.jsx(V,{size:"small",variant:h===1?"contained":"outlined",onClick:()=>m==null?void 0:m(1),sx:{minWidth:36,height:36,p:0,fontSize:"0.75rem"},children:"1"}),h>3&&e.jsx(x,{sx:{display:"flex",alignItems:"center",px:.5},children:"..."})]}),[h-1,h,h+1].filter(d=>d>0&&d<=f).map(d=>e.jsx(V,{size:"small",variant:h===d?"contained":"outlined",onClick:()=>m==null?void 0:m(d),sx:{minWidth:36,height:36,p:0,fontSize:"0.75rem",backgroundColor:h===d?"#4CAF50":"transparent",color:h===d?"white":"text.primary","&:hover":{backgroundColor:h===d?"#45a049":"action.hover"}},children:d},d)),h<f-1&&e.jsxs(e.Fragment,{children:[h<f-2&&e.jsx(x,{sx:{display:"flex",alignItems:"center",px:.5},children:"..."}),e.jsx(V,{size:"small",variant:h===f?"contained":"outlined",onClick:()=>m==null?void 0:m(f),sx:{minWidth:36,height:36,p:0,fontSize:"0.75rem"},children:f})]})]})]})]})},At=({complaint:t,citizen:s,onViewDetails:n,onStatusChange:l,onViewHistory:c})=>{const i=fe(),a=oe(i.breakpoints.down("md")),r=oe(i.breakpoints.down("sm")),[u,h]=o.useState(!a),[f,p]=o.useState(null),m=!!f,g=C=>{switch(C){case"PENDING":return"#ff9800";case"IN_PROGRESS":return"#2196f3";case"RESOLVED":return"#4caf50";case"REJECTED":return"#f44336";default:return"#9e9e9e"}},w=C=>{switch(C){case"PENDING":return"Pending";case"IN_PROGRESS":return"In Progress";case"RESOLVED":return"Resolved";case"REJECTED":return"Rejected";default:return C}},M=C=>{p(C.currentTarget)},b=()=>{p(null)},I=C=>{l(C),b()},T=()=>{h(!u)},D=()=>{var S,E,j,A;const C=((E=(S=s.firstName)==null?void 0:S.charAt(0))==null?void 0:E.toUpperCase())||"",R=((A=(j=s.lastName)==null?void 0:j.charAt(0))==null?void 0:A.toUpperCase())||"";return`${C}${R}`},W=C=>new Date(C).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),F=["PENDING","IN_PROGRESS","RESOLVED","REJECTED"];return e.jsxs(x,{sx:{borderBottom:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:[e.jsxs(x,{sx:{p:{xs:1.5,sm:2,md:2},display:"flex",alignItems:"flex-start",gap:{xs:1.5,sm:2,md:2}},children:[e.jsx(Ae,{src:s.profilePicture,alt:`${s.firstName} ${s.lastName}`,sx:{width:r?40:48,height:r?40:48,backgroundColor:"#4CAF50",fontSize:r?"1rem":"1.25rem",fontWeight:600},children:!s.profilePicture&&D()}),e.jsxs(x,{sx:{flex:1,minWidth:0},children:[e.jsxs(z,{variant:r?"subtitle2":"subtitle1",sx:{fontWeight:600,mb:.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:[s.firstName," ",s.lastName]}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:.5},children:[e.jsx(z,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.trackingNumber}),e.jsx(z,{variant:"body2",color:"text.secondary",children:"‚Ä¢"}),e.jsx(z,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.category})]}),e.jsx(z,{variant:"body2",sx:{mb:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:t.title}),e.jsx(X,{label:w(t.status),size:"small",sx:{backgroundColor:g(t.status),color:"white",fontWeight:600,fontSize:"0.75rem"}})]}),a&&e.jsx(re,{onClick:T,size:"small",sx:{alignSelf:"flex-start"},children:u?e.jsx(lt,{}):e.jsx(ct,{})})]}),e.jsxs(pt,{in:u,timeout:"auto",unmountOnExit:!0,children:[e.jsxs(x,{sx:{px:{xs:1.5,sm:2,md:2},pb:{xs:1.5,sm:2,md:2}},children:[e.jsx(qe,{sx:{mb:2}}),e.jsxs(x,{sx:{mb:2},children:[e.jsx(Je,{sx:{fontSize:18,color:"text.secondary"}}),e.jsx(z,{variant:"body2",sx:{fontWeight:600},children:"Location"})]}),e.jsxs(x,{sx:{ml:3,display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(z,{variant:"body2",color:"text.secondary",children:[s.cityCorporationName||s.district,s.thanaName?`, ${s.thanaName}`:`, ${s.upazila}`]}),e.jsxs(x,{sx:{display:"flex",gap:1},children:[s.zone&&e.jsx(X,{label:`Zone ${s.zone}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem"}}),s.ward&&e.jsx(X,{label:`Ward ${s.ward}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem"}})]})]}),s.address&&e.jsx(z,{variant:"body2",color:"text.secondary",sx:{ml:3,mt:.5,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:s.address})]}),e.jsxs(x,{sx:{mb:2},children:[e.jsx(z,{variant:"body2",sx:{fontWeight:600,mb:1},children:"Contact Information"}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Ke,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(z,{variant:"body2",color:"text.secondary",children:s.phone})]}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Xe,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(z,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:s.email})]})]}),e.jsx(x,{sx:{mb:2},children:e.jsxs(z,{variant:"body2",color:"text.secondary",children:["Submitted on ",W(t.createdAt)]})}),e.jsxs(x,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(V,{variant:"outlined",size:"small",startIcon:e.jsx(_e,{}),onClick:n,sx:{textTransform:"none",borderRadius:2,flex:r?"1 1 100%":"0 1 auto"},children:"View Full Details"}),e.jsx(V,{variant:"outlined",size:"small",onClick:M,sx:{textTransform:"none",borderRadius:2,flex:r?"1 1 100%":"0 1 auto"},children:"Change Status"}),c&&e.jsx(V,{variant:"outlined",size:"small",startIcon:e.jsx(wt,{}),onClick:c,sx:{textTransform:"none",borderRadius:2,flex:r?"1 1 100%":"0 1 auto"},children:"View History"})]})]}),e.jsx(Qe,{anchorEl:f,open:m,onClose:b,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:F.map(C=>e.jsxs(K,{onClick:()=>I(C),disabled:C===t.status,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{sx:{width:12,height:12,borderRadius:"50%",backgroundColor:g(C)}}),e.jsx(z,{variant:"body2",children:w(C)}),C===t.status&&e.jsx(z,{variant:"caption",color:"text.secondary",sx:{ml:1},children:"(Current)"})]},C))})]})},Dt=t=>{const s=new Date,n=new Date(t),l=Math.floor((s.getTime()-n.getTime())/1e3);if(l<60)return"Just now";if(l<3600){const c=Math.floor(l/60);return`${c} min${c>1?"s":""} ago`}else if(l<86400){const c=Math.floor(l/3600);return`${c} hour${c>1?"s":""} ago`}else if(l<604800){const c=Math.floor(l/86400);return`${c} day${c>1?"s":""} ago`}else return n.toLocaleDateString([],{month:"short",day:"numeric",year:n.getFullYear()!==s.getFullYear()?"numeric":void 0})},Te=({message:t,isAdmin:s,showSenderName:n=!1})=>{const[l,c]=o.useState(!1),i=s?"16px 16px 4px 16px":"16px 16px 16px 4px";return e.jsxs(e.Fragment,{children:[e.jsx(x,{sx:{mb:1.5,display:"flex",justifyContent:s?"flex-end":"flex-start",animation:`${We} ${Y.normal.duration} ${Y.normal.timing}, ${et} ${Y.normal.duration} ${Y.smooth.timing}`,animationFillMode:"both"},children:e.jsxs(x,{sx:{maxWidth:{xs:"85%",sm:"75%",md:"70%"},minWidth:"100px",p:1.5,borderRadius:i,background:s?"linear-gradient(135deg, #1976d2 0%, #2e7d32 100%)":"#ffffff",color:s?"#ffffff":"#1a1a1a",boxShadow:s?"0 2px 8px rgba(25, 118, 210, 0.25)":"0 2px 8px rgba(0, 0, 0, 0.08)",border:s?"none":"1px solid #e0e0e0",transition:`all ${Y.fast.duration} ${Y.fast.timing}`,"&:hover":{boxShadow:s?"0 4px 12px rgba(25, 118, 210, 0.35)":"0 4px 12px rgba(0, 0, 0, 0.12)",transform:"translateY(-1px)"}},children:[!s&&n&&t.senderName&&e.jsx(z,{variant:"caption",sx:{fontWeight:700,display:"block",mb:.5,color:"#1976d2",fontSize:"0.75rem",letterSpacing:"0.02em"},children:t.senderName}),e.jsx(z,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.5,fontSize:"0.9rem"},children:t.message}),t.imageUrl&&e.jsx(x,{component:"img",src:t.imageUrl,alt:"Message attachment",loading:"lazy",onLoad:()=>{var r;console.log("‚úÖ Image loaded successfully:",(r=t.imageUrl)==null?void 0:r.substring(0,100))},onError:r=>{var h,f;console.error("‚ùå Image failed to load:",(h=t.imageUrl)==null?void 0:h.substring(0,100)),console.error("   Full URL:",t.imageUrl),r.currentTarget.style.display="none";const u=document.createElement("div");u.textContent="‚ùå Image failed to load",u.style.color=s?"#ffcccc":"#ff0000",u.style.fontSize="0.8rem",u.style.marginTop="8px",(f=r.currentTarget.parentElement)==null||f.appendChild(u)},sx:{mt:1,maxWidth:"100%",maxHeight:"300px",borderRadius:"8px",cursor:"pointer",objectFit:"cover",transition:`all ${Y.fast.duration} ${Y.fast.timing}`,"&:hover":{opacity:.9,transform:"scale(1.02)"}},onClick:()=>c(!0)}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",justifyContent:s?"flex-end":"flex-start",mt:.5,gap:.5},children:[e.jsx(z,{variant:"caption",sx:{opacity:s?.85:.6,fontSize:"0.7rem",fontWeight:500},children:Dt(t.createdAt)}),s&&e.jsx(x,{sx:{display:"flex",alignItems:"center",opacity:.85},children:t.read?e.jsx(gt,{sx:{fontSize:"0.9rem",color:"#4caf50"}}):e.jsx(vt,{sx:{fontSize:"0.9rem"}})})]})]})}),t.imageUrl&&e.jsx(tt,{open:l,onClose:()=>c(!1),sx:{display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsxs(x,{sx:{position:"relative",maxWidth:"90vw",maxHeight:"90vh",outline:"none"},children:[e.jsx(re,{onClick:()=>c(!1),sx:{position:"absolute",top:-40,right:0,color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(Fe,{})}),e.jsx(x,{component:"img",src:t.imageUrl,alt:"Message attachment (full size)",sx:{maxWidth:"100%",maxHeight:"90vh",objectFit:"contain",borderRadius:"8px",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.3)"}})]})})]})},Ft=({messages:t,loading:s,loadingMore:n=!1,hasMoreMessages:l=!1,onLoadMore:c,onScroll:i})=>{const a=o.useRef(null),r=o.useRef(null),u=o.useRef(0),h=Rt({defaultRowHeight:100}),f=o.useCallback(()=>{var m;(m=r.current)==null||m.scrollIntoView({behavior:"smooth"})},[]),p=o.useCallback(m=>{if(i&&i(m),!a.current||n||!l||!c)return;const{scrollTop:g}=a.current;g<100&&(u.current=a.current.scrollHeight,c())},[i,n,l,c]);return o.useEffect(()=>{t.length>0&&!s&&!n&&setTimeout(f,100)},[t.length,s,n,f]),o.useEffect(()=>{if(n&&a.current&&u.current>0){const g=a.current.scrollHeight-u.current;a.current.scrollTop=g,u.current=0}},[t,n]),e.jsxs(x,{ref:a,onScroll:p,sx:{flex:1,overflowY:"auto",overflowX:"hidden",p:{xs:1.5,sm:2,md:2},backgroundColor:"#f5f5f5",display:"flex",flexDirection:"column"},children:[s&&e.jsx(x,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:4,flex:1},children:e.jsx(xe,{size:32})}),!s&&e.jsxs(e.Fragment,{children:[n&&e.jsx(x,{sx:{display:"flex",justifyContent:"center",py:2},children:e.jsx(xe,{size:24})}),!l&&t.length>0&&e.jsx(x,{sx:{textAlign:"center",py:2},children:e.jsx(z,{variant:"caption",color:"text.secondary",children:"Start of conversation"})}),t.length>0&&e.jsx(e.Fragment,{children:t.length>200?e.jsx(Pe,{rowCount:t.length,rowHeight:h,overscanCount:10,rowComponent:({index:m,style:g})=>{const w=t[m];return e.jsx("div",{style:g,children:e.jsx(Te,{message:w,isAdmin:w.senderType==="ADMIN",showSenderName:w.senderType==="CITIZEN"},w.id)})},rowProps:{},style:{height:window.innerHeight-300}}):e.jsx(x,{children:t.map(m=>e.jsx(Te,{message:m,isAdmin:m.senderType==="ADMIN",showSenderName:m.senderType==="CITIZEN"},m.id))})}),t.length===0&&e.jsx(x,{sx:{flex:1,display:"flex",alignItems:"center"},children:e.jsx(Ce,{type:"no-messages"})}),e.jsx("div",{ref:r})]})]})};async function Lt(t,s=1920,n=1080,l=.8){return new Promise((c,i)=>{const a=new FileReader;a.onload=r=>{var h;const u=new Image;u.onload=()=>{let f=u.width,p=u.height;f>s&&(p=p*s/f,f=s),p>n&&(f=f*n/p,p=n);const m=document.createElement("canvas");m.width=f,m.height=p;const g=m.getContext("2d");if(!g){i(new Error("Failed to get canvas context"));return}g.drawImage(u,0,0,f,p),m.toBlob(w=>{w?c(w):i(new Error("Failed to compress image"))},"image/jpeg",l)},u.onerror=()=>{i(new Error("Failed to load image"))},u.src=(h=r.target)==null?void 0:h.result},a.onerror=()=>{i(new Error("Failed to read file"))},a.readAsDataURL(t)})}function $t(t,s=5){if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type))return{valid:!1,error:"Invalid file type. Please upload a JPEG, PNG, GIF, or WebP image."};const l=s*1024*1024;return t.size>l?{valid:!1,error:`File size exceeds ${s}MB. Please choose a smaller image.`}:{valid:!0}}function Pt(t,s){return new File([t],s,{type:t.type})}const Ht=({onSend:t,onSendWithFile:s,sending:n,disabled:l=!1})=>{const[c,i]=o.useState(""),[a,r]=o.useState(null),[u,h]=o.useState(null),[f,p]=o.useState(!1),[m,g]=o.useState(null),w=o.useRef(null),M=o.useRef(null),b=S=>{i(S.target.value)},I=async S=>{var A;const E=(A=S.target.files)==null?void 0:A[0];if(!E)return;const j=$t(E,5);if(!j.valid){L.error(j.error||"Invalid image file",{icon:"‚ùå"});return}try{const P=L.loading("Compressing image..."),O=await Lt(E,1920,1080,.8),N=Pt(O,E.name),$=((1-N.size/E.size)*100).toFixed(0);L.dismiss(P),N.size<E.size&&L.success(`Image compressed by ${$}%`,{icon:"‚úÖ",duration:2e3}),r(N);const B=new FileReader;B.onloadend=()=>{h(B.result)},B.readAsDataURL(N),T(N)}catch(P){console.error("Error compressing image:",P),L.error("Failed to process image. Please try again.",{icon:"‚ùå"})}},T=async S=>{try{p(!0),g("READY_TO_SEND"),L.success("Image ready to send",{icon:"‚úÖ",duration:2e3})}catch(E){console.error("Error processing image:",E),L.error("Failed to process image. Please try again.",{icon:"‚ùå"}),D()}finally{p(!1)}},D=()=>{r(null),h(null),g(null),w.current&&(w.current.value="")},W=async()=>{var E;const S=c.trim();if(!S&&!m){L.error("Please enter a message or select an image",{icon:"‚ö†Ô∏è"});return}if(a&&!m){L.error("Please wait for image to finish uploading",{icon:"‚è≥"});return}try{if(console.log("üì§ Sending message with image file:",a==null?void 0:a.name),console.log("üì§ onSendWithFile available:",!!s),a&&s)console.log("‚úÖ Using onSendWithFile for file:",a.name),await s(S||"Image",a);else if(a&&!s){console.error("‚ùå onSendWithFile not available!"),console.error("‚ùå This means ChatConversationPanel did not pass onSendWithFile prop"),L.error("Cannot send image - feature not available",{icon:"‚ùå"});return}else console.log("‚úÖ Sending text only (no image)"),await t(S,void 0);i(""),D(),(E=M.current)==null||E.focus()}catch(j){console.error("‚ùå Error sending message:",j)}},F=S=>{S.key==="Enter"&&!S.shiftKey&&(S.preventDefault(),!n&&!f&&!l&&W())},C=()=>{var S;(S=w.current)==null||S.click()},R=l||n||f||!c.trim()&&!m;return e.jsxs(x,{sx:{p:{xs:1.5,sm:2,md:2},borderTop:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:[u&&e.jsxs(st,{elevation:2,sx:{mb:2,p:1,position:"relative",display:"inline-block",maxWidth:"200px"},children:[e.jsx(x,{component:"img",src:u,alt:"Preview",sx:{width:"100%",height:"auto",maxHeight:"150px",objectFit:"cover",borderRadius:"4px"}}),e.jsx(re,{size:"small",onClick:D,disabled:f,sx:{position:"absolute",top:4,right:4,backgroundColor:"rgba(0, 0, 0, 0.6)",color:"white","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.8)"}},children:e.jsx(Fe,{fontSize:"small"})}),f&&e.jsx(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(255, 255, 255, 0.8)",borderRadius:"4px"},children:e.jsx(xe,{size:24})})]}),e.jsxs(x,{sx:{display:"flex",gap:1,alignItems:"flex-end"},children:[e.jsx("input",{ref:w,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp",style:{display:"none"},onChange:I}),e.jsx(ze,{title:"Attach image",children:e.jsx("span",{children:e.jsx(re,{color:"primary",onClick:C,disabled:l||n||f||!!a,sx:{mb:.5},children:e.jsx(mt,{})})})}),e.jsx(De,{inputRef:M,fullWidth:!0,multiline:!0,maxRows:4,placeholder:"Type a message...",value:c,onChange:b,onKeyDown:F,disabled:l||n,variant:"outlined",size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:"20px",backgroundColor:"background.default"}}}),e.jsx(ze,{title:n?"Sending...":"Send message (Enter)",children:e.jsx("span",{children:e.jsx(re,{color:"primary",onClick:W,disabled:R,sx:{mb:.5,backgroundColor:"primary.main",color:"white","&:hover":{backgroundColor:"primary.dark"},"&.Mui-disabled":{backgroundColor:"action.disabledBackground",color:"action.disabled"}},children:n?e.jsx(xe,{size:24,color:"inherit"}):e.jsx(bt,{})})})})]}),c.length>0&&e.jsx(x,{sx:{mt:.5,textAlign:"right"},children:e.jsxs(x,{component:"span",sx:{fontSize:"0.75rem",color:c.length>1e3?"error.main":"text.secondary"},children:[c.length," / 1000"]})})]})},He=({error:t,onRetry:s,variant:n="centered"})=>n==="alert"?e.jsx(rt,{severity:"error",sx:{m:2},action:s&&e.jsx(V,{color:"inherit",size:"small",onClick:s,startIcon:e.jsx(ye,{}),children:"Retry"}),children:t}):n==="inline"?e.jsxs(x,{sx:{p:2,backgroundColor:"#ffebee",borderRadius:1,display:"flex",alignItems:"center",gap:1},children:[e.jsx(Ie,{sx:{color:"error.main"}}),e.jsx(x,{sx:{flex:1},children:e.jsx(z,{variant:"body2",color:"error",children:t})}),s&&e.jsx(V,{size:"small",variant:"outlined",color:"error",onClick:s,startIcon:e.jsx(ye,{}),children:"Retry"})]}):e.jsxs(x,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:6,px:3},children:[e.jsx(Ie,{sx:{fontSize:48,color:"error.main",mb:2}}),e.jsx(z,{variant:"h6",color:"error",sx:{mb:1,textAlign:"center"},children:"Something went wrong"}),e.jsx(z,{variant:"body2",color:"text.secondary",sx:{mb:3,textAlign:"center",maxWidth:400},children:t}),s&&e.jsx(V,{variant:"contained",color:"primary",onClick:s,startIcon:e.jsx(ye,{}),children:"Try Again"})]}),Bt=({complaintId:t,onClose:s,onMessagesRead:n})=>{var B,G,q,ee,ne;const l=fe(),c=oe(l.breakpoints.down("md")),[i,a]=o.useState([]),[r,u]=o.useState(null),[h,f]=o.useState(!1),[p,m]=o.useState(null),[g,w]=o.useState(!0),[M,b]=o.useState(1),[I,T]=o.useState(!1),[D,W]=o.useState(!1),[F,C]=o.useState(!1),R=o.useCallback(async(d=1,k=!1)=>{if(t)try{d===1?f(!0):T(!0),m(null);const{messages:y,pagination:U}=await te.getChatMessages(t,d,50);a(k?de=>[...y,...de]:y),w(U.hasNextPage),b(d)}catch(y){const U=y instanceof Error?y.message:"Failed to load messages";m(U),console.error("Error fetching messages:",y),L.error("Failed to load messages. Please check your connection.",{icon:"‚ùå",duration:4e3})}finally{f(!1),T(!1)}},[t]),S=o.useCallback(async()=>{if(t)try{const d=await Ee.getComplaintById(t);u(d)}catch(d){console.error("Error fetching complaint details:",d)}},[t]),E=o.useCallback(async()=>{if(t)try{await te.markAsRead(t),a(d=>d.map(k=>({...k,read:!0}))),n&&n()}catch(d){console.error("Error marking messages as read:",d)}},[t,n]),j=o.useCallback(()=>{!g||I||R(M+1,!0)},[g,I,M,R]),A=()=>{C(!0)},P=async d=>{if(!(!t||!r))try{await Ee.updateComplaintStatus(t,{status:d,note:"Status changed from chat interface"}),u({...r,status:d}),L.success(`Status updated to ${d}`,{icon:"‚úÖ"})}catch(k){console.error("Error updating status:",k),L.error("Failed to update status",{icon:"‚ùå"})}},O=(d,k)=>{r&&d===r.id&&u({...r,status:k})},N=async(d,k)=>{if(t)try{W(!0);const y=await te.sendMessage(t,{message:d,imageUrl:k});a(U=>[...U,y]),L.success("Message sent successfully",{icon:"‚úÖ"})}catch(y){console.error("Error sending message:",y);const U=y instanceof Error?y.message:"Failed to send message";throw L.error(U,{icon:"‚ùå"}),y}finally{W(!1)}},$=async(d,k)=>{if(t)try{W(!0);const y=await te.sendMessageWithFile(t,d,k);a(U=>[...U,y]),L.success("Message sent successfully",{icon:"‚úÖ"})}catch(y){console.error("Error sending message with file:",y);const U=y instanceof Error?y.message:"Failed to send message";throw L.error(U,{icon:"‚ùå"}),y}finally{W(!1)}};return o.useEffect(()=>{t&&(a([]),u(null),m(null),b(1),w(!0),R(1),S(),E())},[t,R,S,E]),o.useEffect(()=>{if(!t)return;const d=setInterval(()=>{te.getChatMessages(t,1,50).then(({messages:k})=>{a(y=>{var me;const U=(me=y[y.length-1])==null?void 0:me.id;return k.some(ue=>ue.id>(U||0))?k:y})}).catch(k=>{console.error("Error polling messages:",k)})},5e3);return()=>{clearInterval(d)}},[t]),t?e.jsxs(x,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[r&&r.user?e.jsxs(x,{sx:{position:"relative"},children:[c&&s&&e.jsx(re,{onClick:s,size:"small",sx:{position:"absolute",top:8,left:8,zIndex:1,backgroundColor:"background.paper",boxShadow:1,"&:hover":{backgroundColor:"background.paper"}},children:e.jsx(Ne,{})}),e.jsx(At,{complaint:{id:r.id,trackingNumber:r.trackingNumber||`#${r.id}`,title:r.title,category:r.category,status:r.status,createdAt:new Date(r.createdAt)},citizen:{id:r.user.id,firstName:r.user.firstName,lastName:r.user.lastName,phone:r.user.phone,email:r.user.email,zone:typeof r.user.zone=="string"?r.user.zone:((B=r.user.zone)==null?void 0:B.name)||"N/A",district:((G=r.locationDetails)==null?void 0:G.district)||"N/A",upazila:((q=r.locationDetails)==null?void 0:q.thana)||"N/A",ward:((ee=r.locationDetails)==null?void 0:ee.ward)||"N/A",address:((ne=r.locationDetails)==null?void 0:ne.address)||"",profilePicture:void 0},onViewDetails:A,onStatusChange:P})]}):e.jsx(x,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[c&&s&&e.jsx(re,{onClick:s,size:"small",sx:{mr:1},children:e.jsx(Ne,{})}),e.jsx(x,{sx:{flex:1},children:e.jsx(z,{variant:"subtitle1",sx:{fontWeight:600},children:"Loading..."})})]})}),p&&!h?e.jsx(He,{error:p,onRetry:()=>R(1,!1),variant:"centered"}):e.jsx(Ft,{messages:i,loading:h,loadingMore:I,hasMoreMessages:g,onLoadMore:j}),e.jsx(Ht,{onSend:N,onSendWithFile:$,sending:D,disabled:!t||h}),r&&e.jsx(dt,{complaintId:r.id,open:F,onClose:()=>C(!1),onStatusUpdate:O})]}):e.jsx(x,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"text.secondary",p:3},children:e.jsx(z,{variant:"body1",children:"Select a chat to start messaging"})})},se=class se{constructor(){pe(this,"permissionGranted",!1);this.checkPermission()}static getInstance(){return se.instance||(se.instance=new se),se.instance}isSupported(){return"Notification"in window}checkPermission(){this.isSupported()&&(this.permissionGranted=Notification.permission==="granted")}async requestPermission(){if(!this.isSupported())return console.warn("Browser notifications are not supported"),!1;if(Notification.permission==="granted")return this.permissionGranted=!0,!0;if(Notification.permission==="denied")return console.warn("Notification permission was denied"),!1;try{const s=await Notification.requestPermission();return this.permissionGranted=s==="granted",this.permissionGranted}catch(s){return console.error("Error requesting notification permission:",s),!1}}showNotification(s,n){if(!this.isSupported()||!this.permissionGranted)return null;try{return new Notification(s,{...n,icon:n.icon||"/favicon.png",badge:n.badge||"/favicon.png",requireInteraction:n.requireInteraction??!1})}catch(l){return console.error("Error showing notification:",l),null}}showNewMessageNotification(s,n,l,c,i){const a=this.showNotification(`New message from ${s}`,{body:n,tag:`chat-${l}`,data:{complaintId:l,trackingNumber:c,type:"new-message"},requireInteraction:!1});return a&&i&&(a.onclick=()=>{window.focus(),i(),a.close()}),a}getPermissionStatus(){return this.isSupported()?Notification.permission:"denied"}hasPermission(){return this.permissionGranted}};pe(se,"instance");let je=se;const ae=je.getInstance(),as=()=>{const{complaintId:t}=nt(),s=ot(),n=fe(),l=oe(n.breakpoints.down("md")),c=oe(n.breakpoints.between("md","lg")),[i,a]=o.useState([]),[r,u]=o.useState(null),[h,f]=o.useState(!0),[p,m]=o.useState(null),[g,w]=o.useState(""),[M,b]=o.useState({district:void 0,upazila:void 0,ward:void 0,zone:void 0,cityCorporationCode:void 0,thanaId:void 0,status:void 0,unreadOnly:!1,page:1,limit:20}),[I,T]=o.useState(1),[D,W]=o.useState(1),[F,C]=o.useState(0),[R,S]=o.useState(!1),[E,j]=o.useState({totalChats:0,unreadCount:0,byDistrict:[],byUpazila:[],byWard:[],byZone:[],byStatus:[]}),[A,P]=o.useState(!1),O=o.useRef([]),N=o.useRef(!0);o.useEffect(()=>{if(ae.isSupported()&&ae.getPermissionStatus()==="default"){const v=setTimeout(()=>{ae.requestPermission().then(J=>{J&&console.log("Browser notification permission granted")})},2e3);return()=>clearTimeout(v)}},[]);const $=o.useCallback(v=>{const J=v.citizen.firstName+" "+v.citizen.lastName,H=v.lastMessage.text.length>50?v.lastMessage.text.substring(0,50)+"...":v.lastMessage.text,_=()=>{s(`/chats/${v.complaintId}`),u(v.complaintId),l&&P(!0)};L(Z=>e.jsxs(x,{onClick:()=>{L.dismiss(Z.id),_()},sx:{cursor:"pointer","&:hover":{opacity:.9}},children:[e.jsxs(x,{sx:{fontWeight:600,mb:.5,color:"#3FA564"},children:["New message from ",J]}),e.jsx(x,{sx:{fontSize:"0.875rem",color:"#666"},children:H}),e.jsxs(x,{sx:{fontSize:"0.75rem",color:"#999",mt:.5},children:["Complaint #",v.trackingNumber]})]}),{duration:6e3,icon:"üí¨",style:{background:"#fff",color:"#333",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",borderLeft:"4px solid #3FA564",padding:"16px",maxWidth:"400px"}}),ae.hasPermission()&&!document.hasFocus()&&ae.showNewMessageNotification(J,`${H}

Complaint #${v.trackingNumber}`,v.complaintId,v.trackingNumber,_)},[s,l]),B=o.useCallback(v=>{if(N.current){N.current=!1,O.current=v;return}const J=O.current;v.forEach(H=>{const _=J.find(Z=>Z.complaintId===H.complaintId);_?H.lastMessage.id!==_.lastMessage.id&&H.lastMessage.senderType==="CITIZEN"&&H.complaintId!==r&&$(H):H.lastMessage.senderType==="CITIZEN"&&$(H)}),O.current=v},[r,$]),G=o.useCallback(async(v=!1,J)=>{try{f(!0),m(null);const H=J||I,_={...M,search:g||void 0,page:H,limit:20},Z=await te.getChatConversationsWithPagination(_);H===1&&B(Z.chats),a(Z.chats),Z.pagination&&(T(Z.pagination.page),W(Z.pagination.totalPages),C(Z.pagination.total),S(Z.pagination.hasNextPage))}catch(H){const _=H instanceof Error?H.message:"Failed to load chats";m(_),console.error("Error fetching chat list:",H),v&&L.error("Failed to load chats. Please check your connection.",{icon:"‚ùå",duration:4e3})}finally{f(!1)}},[M,g,B,I]),q=o.useCallback(async()=>{try{const v=await te.getChatStatistics();j(v)}catch(v){console.error("Error fetching statistics:",v)}},[]);o.useEffect(()=>{G(!0),q()},[G,q]),o.useEffect(()=>{if(t){const v=parseInt(t,10);isNaN(v)||(u(v),l&&P(!0))}},[t,l]),o.useEffect(()=>{const v=setInterval(()=>{G(!1),q()},5e3);return()=>{clearInterval(v)}},[G,q]);const ee=v=>{u(v),l&&P(!0)},ne=()=>{P(!1),u(null)},d=v=>{w(v)},k=v=>{b(J=>({...J,...v})),T(1)},y=v=>{T(v),G(!1,v),window.scrollTo({top:0,behavior:"smooth"})},U=()=>{R&&y(I+1)},de=()=>{I>1&&y(I-1)},ue=l?{list:"100%",conversation:"100%"}:c?{list:"35%",conversation:"65%"}:{list:"30%",conversation:"70%"};return e.jsx(it,{title:"Messages",children:e.jsxs(x,{sx:{display:"flex",height:"calc(100vh - 140px)",gap:2,overflow:"hidden"},children:[(!l||!A)&&e.jsx(x,{sx:{width:ue.list,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:p&&!h?e.jsx(He,{error:p,onRetry:()=>G(!0),variant:"centered"}):e.jsx(Wt,{chats:i,selectedChatId:r,onChatSelect:ee,searchTerm:g,onSearchChange:d,filters:M,onFilterChange:k,statistics:E,loading:h,currentPage:I,totalPages:D,totalChats:F,onPageChange:y,onNextPage:U,onPrevPage:de})}),(!l||A)&&e.jsx(x,{sx:{width:ue.conversation,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:e.jsx(Bt,{complaintId:r,onClose:l?ne:void 0,onMessagesRead:()=>{G(!1),q()}})})]})})};export{as as default};
