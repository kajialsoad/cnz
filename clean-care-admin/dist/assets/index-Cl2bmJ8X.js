import{u as re,o as q,j as e,B as o,T as I,i as V,v as K,aN as ce,g as de,I as _,Z as ue,p as ee,a3 as se,C as fe}from"./mui-vendor-Brc-2iiC.js";import{r,i as he,d as xe}from"./react-vendor-D7yrL1sD.js";import{z as Y,M as pe}from"./index-DBuvollO.js";import{a as me,b as P,C as ge}from"./browserNotifications-CE-oeFv1.js";import{a as ye,E as Ce}from"./ErrorDisplay-MT5puO9e.js";import{l as te,L as be}from"./LiveChatConversationPanel-CqcdxjBE.js";import"./query-vendor-CZVuOxbJ.js";import"./chart-vendor-CrjdDA16.js";const je=({conversations:y,selectedUserId:W,onUserSelect:A,searchTerm:n,onSearchChange:M,filters:d,onFilterChange:C,statistics:x,loading:u,hasMore:g,onLoadMore:L,totalConversations:T})=>{const k=re(),z=q(k.breakpoints.down("md")),[U,f]=r.useState(!1),D=r.useRef(null),p=r.useRef(null),N=r.useRef(null);r.useEffect(()=>(p.current&&p.current.disconnect(),p.current=new IntersectionObserver(t=>{t[0].isIntersecting&&g&&!u&&L()},{root:D.current,threshold:.1}),N.current&&p.current.observe(N.current),()=>{p.current&&p.current.disconnect()}),[g,u,L]);const O=t=>{const i=new Date(t),j=new Date().getTime()-i.getTime(),v=Math.floor(j/6e4),E=Math.floor(j/36e5),R=Math.floor(j/864e5);return v<1?"Just now":v<60?`${v}m ago`:E<24?`${E}h ago`:R<7?`${R}d ago`:i.toLocaleDateString("en-US",{month:"short",day:"numeric"})},F=t=>{const i=[];return t.cityCorporationCode&&i.push(t.cityCorporationCode),t.zone&&i.push(`Zone ${t.zone.name||t.zone.number}`),t.ward&&i.push(`Ward ${t.ward.wardNumber||t.ward.number}`),i.join(", ")||"No location"},B=()=>{C({unreadOnly:!d.unreadOnly})},$=()=>{M(""),C({cityCorporationCode:void 0,zoneId:void 0,wardId:void 0,unreadOnly:!1})},b=()=>!!(n||d.cityCorporationCode||d.zoneId||d.wardId||d.unreadOnly);return e.jsxs(o,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs(o,{sx:{p:2,borderBottom:`1px solid ${k.palette.divider}`,bgcolor:"background.paper"},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[e.jsx(I,{variant:"h6",sx:{fontWeight:600},children:"Live Chat"}),e.jsxs(o,{sx:{display:"flex",gap:1},children:[b()&&e.jsx(V,{size:"small",onClick:$,title:"Clear filters",children:e.jsx(K,{fontSize:"small"})}),z&&e.jsx(V,{size:"small",onClick:()=>f(!U),color:U?"primary":"default",children:e.jsx(ce,{fontSize:"small"})})]})]}),e.jsx(de,{fullWidth:!0,size:"small",placeholder:"Search by name or phone...",value:n,onChange:t=>M(t.target.value),InputProps:{startAdornment:e.jsx(_,{position:"start",children:e.jsx(ue,{fontSize:"small"})}),endAdornment:n&&e.jsx(_,{position:"end",children:e.jsx(V,{size:"small",onClick:()=>M(""),children:e.jsx(K,{fontSize:"small"})})})}}),e.jsxs(o,{sx:{display:"flex",gap:1,mt:1.5,flexWrap:"wrap"},children:[e.jsx(ee,{label:`All (${x.totalConversations})`,size:"small",onClick:()=>C({unreadOnly:!1}),color:d.unreadOnly?"default":"primary",variant:d.unreadOnly?"outlined":"filled"}),e.jsx(ee,{label:e.jsx(se,{badgeContent:x.unreadMessages,color:"error",max:99,children:e.jsx("span",{style:{marginRight:x.unreadMessages>0?16:0},children:"Unread"})}),size:"small",onClick:B,color:d.unreadOnly?"primary":"default",variant:d.unreadOnly?"filled":"outlined"})]}),e.jsx(I,{variant:"caption",sx:{color:"text.secondary",mt:1,display:"block"},children:u?"Loading...":`${T} conversation${T!==1?"s":""}`})]}),e.jsx(o,{ref:D,sx:{flex:1,overflowY:"auto",overflowX:"hidden",opacity:u?.6:1,pointerEvents:u?"none":"auto",transition:"opacity 0.2s"},children:u&&y.length===0?e.jsx(me,{count:5}):y.length===0?e.jsx(ye,{type:b()?"no-results":"no-chats",onAction:b()?$:void 0,actionLabel:"Clear filters"}):e.jsxs(e.Fragment,{children:[y.map(t=>{const i=W===t.user.id,h=t.unreadCount>0;return e.jsx(o,{onClick:()=>A(t.user.id),sx:{p:2,borderBottom:`1px solid ${k.palette.divider}`,cursor:"pointer",bgcolor:i?"action.selected":"transparent",transition:"background-color 0.2s","&:hover":{bgcolor:i?"action.selected":"action.hover"}},children:e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsxs(o,{sx:{width:48,height:48,borderRadius:"50%",bgcolor:"primary.main",color:"white",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:600,fontSize:"1.25rem",flexShrink:0},children:[t.user.firstName.charAt(0).toUpperCase(),t.user.lastName.charAt(0).toUpperCase()]}),e.jsxs(o,{sx:{flex:1,minWidth:0},children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:.5},children:[e.jsxs(I,{variant:"subtitle2",sx:{fontWeight:h?600:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:[t.user.firstName," ",t.user.lastName]}),t.lastMessage&&e.jsx(I,{variant:"caption",sx:{color:"text.secondary",flexShrink:0,ml:1},children:O(t.lastMessage.createdAt)})]}),t.user.phone&&e.jsx(I,{variant:"caption",sx:{color:"text.secondary",display:"block",mb:.5},children:t.user.phone}),e.jsx(I,{variant:"caption",sx:{color:"text.secondary",display:"block",mb:.5},children:F(t.user)}),t.lastMessage&&e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(I,{variant:"body2",sx:{color:h?"text.primary":"text.secondary",fontWeight:h?500:400,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1},children:[t.lastMessage.senderType==="ADMIN"&&"You: ",t.lastMessage.type==="IMAGE"?"ðŸ“· Image":t.lastMessage.type==="VOICE"?"ðŸŽ¤ Voice message":t.lastMessage.content]}),h&&e.jsx(se,{badgeContent:t.unreadCount,color:"error",max:99,sx:{flexShrink:0}})]})]})]})},t.user.id)}),g&&e.jsx(o,{ref:N,sx:{p:2,display:"flex",justifyContent:"center",alignItems:"center"},children:e.jsx(fe,{size:24})})]})})]})},Le=()=>{var J,Q,X;const{userId:y}=he(),W=xe(),A=re(),n=q(A.breakpoints.down("md")),M=q(A.breakpoints.between("md","lg")),[d,C]=r.useState([]),[x,u]=r.useState(null),[g,L]=r.useState(!0),[T,k]=r.useState(null),[z,U]=r.useState(""),[f,D]=r.useState({cityCorporationCode:void 0,zoneId:void 0,wardId:void 0,unreadOnly:!1,page:1,limit:20}),[p,N]=r.useState(1),[O,F]=r.useState(!0),[B,$]=r.useState(0),[b,t]=r.useState({totalConversations:0,unreadMessages:0,todayMessages:0}),[i,h]=r.useState(!1),j=r.useRef([]),v=r.useRef(!0);r.useEffect(()=>{if(P.isSupported()&&P.getPermissionStatus()==="default"){const s=setTimeout(()=>{P.requestPermission().then(l=>{l&&console.log("Browser notification permission granted")})},2e3);return()=>clearTimeout(s)}},[]);const E=r.useCallback(s=>{var m;const l=s.user.firstName+" "+s.user.lastName,a=(m=s.lastMessage)!=null&&m.content?s.lastMessage.content.length>50?s.lastMessage.content.substring(0,50)+"...":s.lastMessage.content:"New message",c=()=>{W(`/live-chat/${s.user.id}`),u(s.user.id),n&&h(!0)};Y(S=>e.jsxs(o,{onClick:()=>{Y.dismiss(S.id),c()},sx:{cursor:"pointer","&:hover":{opacity:.9}},children:[e.jsxs(o,{sx:{fontWeight:600,mb:.5,color:"#3FA564"},children:["New message from ",l]}),e.jsx(o,{sx:{fontSize:"0.875rem",color:"#666"},children:a}),s.user.phone&&e.jsx(o,{sx:{fontSize:"0.75rem",color:"#999",mt:.5},children:s.user.phone})]}),{duration:6e3,icon:"ðŸ’¬",style:{background:"#fff",color:"#333",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",borderLeft:"4px solid #3FA564",padding:"16px",maxWidth:"400px"}}),P.hasPermission()&&!document.hasFocus()&&P.showNewMessageNotification(l,a,s.user.id,s.user.phone||"",c)},[W,n]),R=r.useCallback(s=>{if(v.current){v.current=!1,j.current=s;return}const l=j.current;s.forEach(a=>{const c=l.find(m=>m.user.id===a.user.id);c?a.lastMessage&&c.lastMessage&&a.lastMessage.id!==c.lastMessage.id&&a.lastMessage.senderType==="CITIZEN"&&a.user.id!==x&&E(a):a.lastMessage&&a.lastMessage.senderType==="CITIZEN"&&E(a)}),j.current=s},[x,E]),w=r.useCallback(async(s=!1,l,a=!1)=>{try{a||L(!0),k(null);const c=l||1,m={...f,search:z||void 0,page:c,limit:20},S=await te.getConversations(m);c===1&&!a&&R(S.conversations),C(a?le=>[...le,...S.conversations]:S.conversations),N(c),$(S.total),F(S.hasMore)}catch(c){const m=c instanceof Error?c.message:"Failed to load conversations";k(m),console.error("Error fetching conversation list:",c),s&&Y.error("Failed to load conversations. Please check your connection.",{icon:"âŒ",duration:4e3})}finally{L(!1)}},[f,z,R]),oe=r.useCallback(()=>{if(O&&!g){const s=p+1;w(!1,s,!0)}},[O,g,p,w]),Z=r.useCallback(async()=>{try{const s=await te.getStatistics();t(s)}catch(s){console.error("Error fetching statistics:",s)}},[]);r.useEffect(()=>{w(!0),Z()},[]),r.useEffect(()=>{if(v.current)return;N(1),C([]);const s=setTimeout(()=>{w(!1)},500);return()=>clearTimeout(s)},[f,z]),r.useEffect(()=>{if(y){const s=parseInt(y,10);isNaN(s)||(u(s),n&&h(!0))}},[y,n]),r.useEffect(()=>{const s=setInterval(()=>{w(!1),Z()},1e4);return()=>{clearInterval(s)}},[]);const ae=s=>{u(s),n&&h(!0)},ne=()=>{h(!1),u(null)},ie=s=>{U(s)},G=s=>{D(l=>({...l,...s}))},H=n?{filter:"0%",list:"100%",conversation:"100%"}:M?{filter:"0%",list:"40%",conversation:"60%"}:{filter:"20%",list:"30%",conversation:"50%"};return e.jsx(pe,{title:"Live Chat",children:e.jsxs(o,{sx:{display:"flex",height:"calc(100vh - 140px)",gap:2,overflow:"hidden"},children:[!n&&!M&&e.jsx(o,{sx:{width:H.filter,display:"flex",flexDirection:"column",overflow:"hidden"},children:e.jsx(ge,{filters:{cityCorporationCode:f.cityCorporationCode,zone:((J=f.zoneId)==null?void 0:J.toString())||void 0,ward:((Q=f.wardId)==null?void 0:Q.toString())||void 0,unreadOnly:f.unreadOnly},onFilterChange:s=>{const l={cityCorporationCode:s.cityCorporationCode,unreadOnly:s.unreadOnly};s.zone!==void 0&&(l.zoneId=s.zone?parseInt(s.zone):void 0),s.ward!==void 0&&(l.wardId=s.ward?parseInt(s.ward):void 0),G(l)},statistics:{totalChats:b.totalConversations,unreadCount:b.unreadMessages,byDistrict:[],byUpazila:[],byWard:[],byZone:[],byStatus:[]},showStatusFilter:!1})}),(!n||!i)&&e.jsx(o,{sx:{width:H.list,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:T&&!g?e.jsx(Ce,{error:T,onRetry:()=>w(!0),variant:"centered"}):e.jsx(je,{conversations:d,selectedUserId:x,onUserSelect:ae,searchTerm:z,onSearchChange:ie,filters:f,onFilterChange:G,statistics:b,loading:g,hasMore:O,onLoadMore:oe,totalConversations:B})}),(!n||i)&&e.jsx(o,{sx:{width:H.conversation,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:e.jsx(be,{userId:x,userInfo:(X=d.find(s=>s.user.id===x))==null?void 0:X.user,onClose:n?ne:void 0,onMessagesRead:()=>{w(!1),Z()}})})]})})};export{be as LiveChatConversationPanel,je as UserListPanel,Le as default};
