var We=Object.defineProperty;var De=(t,s,r)=>s in t?We(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r;var fe=(t,s,r)=>De(t,typeof s!="symbol"?s+"":s,r);import{j as e,B as d,T as w,aH as Fe,q,$ as xe,a0 as he,a2 as Z,b as Y,bl as Le,J as Ee,H as re,b4 as ve,b2 as $e,bm as He,u as ue,p as se,g as Re,I as Be,_ as Ue,C as ie,i as ee,aF as Ve,aG as Ge,aM as Ze,D as qe,M as Ye,K as Je,h as _e,l as Ke,bn as Xe,aL as Qe,bo as et,bp as tt,bq as st,w as Ne,P as rt,s as Ce,aA as nt,aB as ot,m as it,R as me,E as we,aX as je}from"./mui-vendor-BGNnUP5W.js";import{r as n,a as at,i as lt,d as ct}from"./react-vendor-D7yrL1sD.js";import{Z as dt,d as ut,f as Me,a as G,s as ft,z as F,c as X,M as xt}from"./index-BayLrfHP.js";import{u as ht,C as mt}from"./useDebounce-CZ7tcuGs.js";import{f as gt}from"./dateUtils-DIp7-fYO.js";import{a as Se}from"./categoryService-BtylYV6R.js";import"./query-vendor-7qIgur5f.js";import"./chart-vendor-DaOx9iI7.js";const pt=({filters:t,onFilterChange:s,statistics:r})=>{const[a,l]=n.useState([]),[u,i]=n.useState(!1);n.useEffect(()=>{(async()=>{try{i(!0);const b=await ut.getCityCorporations("ACTIVE");l(b.cityCorporations||[])}catch(b){console.error("Error fetching city corporations:",b),l([])}finally{i(!1)}})()},[]);const o=m=>{s({cityCorporationCode:m==="ALL"?void 0:m,thanaId:void 0,zone:void 0,ward:void 0})},c=m=>{s({ward:m==="ALL"?void 0:m})},g=m=>{s({zone:m===""?void 0:m.toString()})},f=m=>{s({status:m==="ALL"?void 0:m})},x=()=>{s({unreadOnly:!t.unreadOnly})},h=()=>{s({cityCorporationCode:void 0,ward:void 0,zone:void 0,status:void 0,unreadOnly:!1})},y=()=>t.cityCorporationCode!==void 0||t.ward!==void 0||t.zone!==void 0||t.status!==void 0||t.unreadOnly===!0,C=()=>{var m;return((m=r.byWard)==null?void 0:m.map(b=>b.category))||[]};return e.jsxs(d,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden",bgcolor:"background.paper",borderRadius:2,boxShadow:1},children:[e.jsxs(d,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsxs(w,{variant:"h6",sx:{fontWeight:600,mb:1.5,display:"flex",alignItems:"center",gap:1},children:[e.jsx(Fe,{}),"Filters"]}),e.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsx(q,{label:`${r.totalChats} Total`,size:"small",sx:{backgroundColor:"#e3f2fd",color:"#1976d2",fontWeight:500}}),e.jsx(q,{label:`${r.unreadCount} Unread`,size:"small",sx:{backgroundColor:"#4CAF50",color:"white",fontWeight:500}})]})]}),e.jsxs(d,{sx:{flex:1,overflowY:"auto",p:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(xe,{fullWidth:!0,size:"small",children:[e.jsx(w,{variant:"caption",sx:{mb:.5,fontWeight:500},children:"City Corporation"}),e.jsxs(he,{value:t.cityCorporationCode||"ALL",onChange:m=>o(m.target.value),displayEmpty:!0,disabled:u,sx:{backgroundColor:"background.default",fontSize:"0.875rem"},children:[e.jsx(Z,{value:"ALL",children:"All City Corporations"}),a&&a.map(m=>e.jsx(Z,{value:m.code,children:m.name},m.code))]})]}),e.jsxs(d,{children:[e.jsx(w,{variant:"caption",sx:{mb:.5,fontWeight:500,display:"block"},children:"Zone"}),e.jsx(dt,{value:t.zone?Number(t.zone):"",onChange:g,cityCorporationCode:t.cityCorporationCode||"",disabled:!1})]}),e.jsxs(xe,{fullWidth:!0,size:"small",children:[e.jsx(w,{variant:"caption",sx:{mb:.5,fontWeight:500},children:"Ward"}),e.jsxs(he,{value:t.ward||"ALL",onChange:m=>c(m.target.value),displayEmpty:!0,sx:{backgroundColor:"background.default",fontSize:"0.875rem"},children:[e.jsx(Z,{value:"ALL",children:"All Wards"}),C().map(m=>e.jsxs(Z,{value:m,children:["Ward ",m]},m))]})]}),e.jsxs(xe,{fullWidth:!0,size:"small",children:[e.jsx(w,{variant:"caption",sx:{mb:.5,fontWeight:500},children:"Status"}),e.jsxs(he,{value:t.status||"ALL",onChange:m=>f(m.target.value),displayEmpty:!0,sx:{backgroundColor:"background.default",fontSize:"0.875rem"},children:[e.jsx(Z,{value:"ALL",children:"All Status"}),e.jsx(Z,{value:"PENDING",children:"Pending"}),e.jsx(Z,{value:"IN_PROGRESS",children:"In Progress"}),e.jsx(Z,{value:"RESOLVED",children:"Solved"}),e.jsx(Z,{value:"REJECTED",children:"Rejected"})]})]}),e.jsx(Y,{fullWidth:!0,variant:t.unreadOnly?"contained":"outlined",size:"small",onClick:x,sx:{textTransform:"none",fontSize:"0.875rem",backgroundColor:t.unreadOnly?"#4CAF50":"transparent",borderColor:t.unreadOnly?"#4CAF50":"divider",color:t.unreadOnly?"white":"text.primary","&:hover":{backgroundColor:t.unreadOnly?"#45a049":"action.hover",borderColor:t.unreadOnly?"#45a049":"#4CAF50"}},children:t.unreadOnly?"‚úì Unread Only":"Show Unread Only"}),y()&&e.jsx(Y,{fullWidth:!0,variant:"text",size:"small",startIcon:e.jsx(Le,{}),onClick:h,sx:{textTransform:"none",fontSize:"0.875rem",color:"text.secondary","&:hover":{color:"error.main"}},children:"Clear All Filters"})]})]})},bt=({chat:t,isSelected:s,onClick:r})=>{const a=()=>`${t.citizen.firstName.charAt(0)}${t.citizen.lastName.charAt(0)}`,l=(o,c=50)=>o.length<=c?o:`${o.substring(0,c)}...`,u=()=>{switch(t.complaintStatus){case"PENDING":return"#FF9800";case"IN_PROGRESS":return"#2196F3";case"RESOLVED":return"#4CAF50";case"REJECTED":return"#f44336";default:return"#9E9E9E"}},i=()=>{switch(t.complaintStatus){case"PENDING":return"Pending";case"IN_PROGRESS":return"In Progress";case"RESOLVED":return"Solved";case"REJECTED":return"Rejected";default:return t.complaintStatus}};return e.jsx(d,{onClick:r,sx:{p:{xs:1.5,sm:2,md:2},borderBottom:"1px solid",borderColor:"divider",cursor:"pointer",backgroundColor:s?"action.selected":"transparent",transition:`all ${G.fast.duration} ${G.fast.timing}`,animation:`${Me} ${G.normal.duration} ${G.normal.timing}`,"&:hover":{backgroundColor:s?"action.selected":"action.hover",transform:"translateX(4px)",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.08)"}},children:e.jsxs(d,{sx:{display:"flex",gap:1.5},children:[e.jsx(Ee,{src:t.citizen.profilePicture,sx:{width:40,height:40,bgcolor:"#4CAF50",color:"white",fontWeight:600,fontSize:"0.875rem",flexShrink:0},children:a()}),e.jsxs(d,{sx:{flex:1,minWidth:0},children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",mb:.5,gap:1},children:[e.jsxs(w,{variant:"subtitle2",sx:{fontWeight:t.unreadCount>0?600:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1},children:[t.citizen.firstName," ",t.citizen.lastName]}),e.jsx(w,{variant:"caption",color:"text.secondary",sx:{flexShrink:0,fontSize:"0.7rem"},children:t.lastMessage?gt(t.lastMessage.timestamp.toString()):"No messages"})]}),e.jsxs(w,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:["#",t.trackingNumber," ‚Ä¢ ",t.complaintTitle]}),e.jsxs(w,{variant:"caption",color:"text.secondary",sx:{display:"block",mb:.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontSize:"0.7rem"},children:["üìç ",t.citizen.cityCorporationName||t.citizen.district,t.citizen.thanaName&&`, ${t.citizen.thanaName}`,!t.citizen.cityCorporationName&&`, ${t.citizen.upazila}`]}),e.jsxs(d,{sx:{display:"flex",gap:.5,mb:.5,flexWrap:"wrap"},children:[t.citizen.zone&&e.jsx(q,{label:`Zone ${t.citizen.zone}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem",color:"text.secondary",borderColor:"divider",backgroundColor:"action.hover"}}),t.citizen.ward&&e.jsx(q,{label:`Ward ${t.citizen.ward}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem",color:"text.secondary",borderColor:"divider",backgroundColor:"action.hover"}})]}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:t.unreadCount>0?500:400,fontSize:"0.875rem",mb:.5},children:t.lastMessage?l(t.lastMessage.text,50):"No messages yet"}),e.jsxs(d,{sx:{display:"flex",gap:.5,flexWrap:"wrap",alignItems:"center"},children:[e.jsx(q,{label:i(),size:"small",sx:{height:20,fontSize:"0.7rem",fontWeight:500,backgroundColor:u(),color:"white"}}),t.isNew&&e.jsx(q,{label:"New",size:"small",sx:{height:20,fontSize:"0.7rem",fontWeight:600,backgroundColor:"#FF5722",color:"white"}}),t.unreadCount>0&&e.jsx(q,{label:t.unreadCount,size:"small",sx:{height:20,minWidth:20,backgroundColor:"#4CAF50",color:"white",fontSize:"0.7rem",fontWeight:600}})]})]})]})})},yt=({count:t=5})=>e.jsx(d,{sx:{p:2},children:Array.from({length:t}).map((s,r)=>e.jsx(d,{sx:{mb:2},children:e.jsxs(d,{sx:{display:"flex",gap:1.5,mb:1},children:[e.jsx(re,{variant:"circular",width:48,height:48}),e.jsxs(d,{sx:{flex:1},children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",mb:.5},children:[e.jsx(re,{variant:"text",width:"60%",height:20}),e.jsx(re,{variant:"text",width:"20%",height:16})]}),e.jsx(re,{variant:"text",width:"40%",height:16,sx:{mb:.5}}),e.jsx(re,{variant:"text",width:"80%",height:16})]})]})},r))}),pe=({type:t,onAction:s,actionLabel:r})=>{const l=(()=>{switch(t){case"no-chats":return{icon:e.jsx(ve,{sx:{fontSize:64,color:"text.disabled"}}),title:"No conversations yet",description:"Chat conversations will appear here when citizens message you about their complaints.",showAction:!1};case"no-messages":return{icon:e.jsx(He,{sx:{fontSize:64,color:"text.disabled"}}),title:"No messages yet",description:"Start the conversation by sending a message below.",showAction:!1};case"no-results":return{icon:e.jsx($e,{sx:{fontSize:64,color:"text.disabled"}}),title:"No results found",description:"Try adjusting your search or filters to find what you're looking for.",showAction:!0};default:return{icon:e.jsx(ve,{sx:{fontSize:64,color:"text.disabled"}}),title:"Nothing here",description:"",showAction:!1}}})();return e.jsxs(d,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:{xs:4,sm:6,md:8},px:3,textAlign:"center"},children:[e.jsx(d,{sx:{mb:2},children:l.icon}),e.jsx(w,{variant:"h6",color:"text.secondary",sx:{mb:1,fontWeight:500,fontSize:{xs:"1rem",sm:"1.25rem"}},children:l.title}),l.description&&e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mb:l.showAction?3:0,maxWidth:400,lineHeight:1.6},children:l.description}),l.showAction&&s&&e.jsx(Y,{variant:"outlined",size:"small",onClick:s,sx:{textTransform:"none"},children:r||"Clear Filters"})]})},vt=({chats:t,selectedChatId:s,onChatSelect:r,searchTerm:a,onSearchChange:l,loading:u,hasMore:i=!1,onLoadMore:o,totalChats:c=0})=>{const g=ue(),f=se(g.breakpoints.down("sm")),[x,h]=n.useState(a),[y,C]=n.useState(!1),m=n.useRef(null),b=n.useRef(null),S=n.useRef(null),T=ht(x,500);at.useEffect(()=>{l(T)},[T,l]);const N=n.useCallback(()=>{!u&&!y&&i&&o&&(C(!0),o(),setTimeout(()=>C(!1),1e3))},[u,y,i,o]);n.useEffect(()=>{if(S.current)return b.current&&b.current.disconnect(),b.current=new IntersectionObserver(v=>{v[0].isIntersecting&&N()},{root:m.current,rootMargin:"100px",threshold:.1}),b.current.observe(S.current),()=>{b.current&&b.current.disconnect()}},[N]);const A=v=>{h(v.target.value)},P=()=>{h(""),l("")};return e.jsxs(d,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs(d,{sx:{p:{xs:1.5,sm:2,md:2},borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(w,{variant:"h6",sx:{fontWeight:600,mb:1.5,fontSize:{xs:"1.1rem",sm:"1.25rem",md:"1.25rem"}},children:"Inbox"}),e.jsx(Re,{fullWidth:!0,placeholder:f?"Search...":"Search conversations...",value:x,onChange:A,size:"small",slotProps:{input:{startAdornment:e.jsx(Be,{position:"start",children:e.jsx(Ue,{sx:{color:"text.secondary",fontSize:20}})})}},sx:{"& .MuiOutlinedInput-root":{backgroundColor:"background.default"}}})]}),e.jsxs(d,{ref:m,sx:{flex:1,overflowY:"auto",overflowX:"hidden"},children:[u&&t.length===0&&e.jsx(yt,{count:5}),!u&&t.length===0&&x!==""&&e.jsx(pe,{type:"no-results",onAction:P,actionLabel:"Clear Search"}),!u&&t.length===0&&x===""&&e.jsx(pe,{type:"no-chats"}),t.length>0&&e.jsxs(d,{children:[t.map(v=>e.jsx(bt,{chat:v,isSelected:s===v.complaintId,onClick:()=>r(v.complaintId)},v.complaintId||`citizen-${v.citizen.id}`)),i&&e.jsx(d,{ref:S,sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2,minHeight:60},children:(u||y)&&e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ie,{size:20}),e.jsx(w,{variant:"body2",color:"text.secondary",children:"Loading more..."})]})}),!i&&t.length>0&&e.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:2,color:"text.secondary"},children:e.jsx(w,{variant:"body2",children:c>0?`All ${c} conversations loaded`:"No more conversations"})})]})]})]})},Ct=({complaint:t,citizen:s,onViewDetails:r,onStatusChange:a,onViewHistory:l})=>{const u=ue(),i=se(u.breakpoints.down("md")),o=se(u.breakpoints.down("sm")),[c,g]=n.useState(!i),[f,x]=n.useState(null),h=!!f,y=v=>{switch(v){case"PENDING":return"#ff9800";case"IN_PROGRESS":return"#2196f3";case"RESOLVED":return"#4caf50";case"REJECTED":return"#f44336";default:return"#9e9e9e"}},C=v=>{switch(v){case"PENDING":return"Pending";case"IN_PROGRESS":return"In Progress";case"RESOLVED":return"Resolved";case"REJECTED":return"Rejected";default:return v}},m=v=>{x(v.currentTarget)},b=()=>{x(null)},S=v=>{a(v),b()},T=()=>{g(!c)},N=()=>{var I,z,j,D;const v=((z=(I=s.firstName)==null?void 0:I.charAt(0))==null?void 0:z.toUpperCase())||"",M=((D=(j=s.lastName)==null?void 0:j.charAt(0))==null?void 0:D.toUpperCase())||"";return`${v}${M}`},A=v=>new Date(v).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),P=["PENDING","IN_PROGRESS","RESOLVED","REJECTED"];return e.jsxs(d,{sx:{borderBottom:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:[e.jsxs(d,{sx:{p:{xs:1.5,sm:2,md:2},display:"flex",alignItems:"flex-start",gap:{xs:1.5,sm:2,md:2}},children:[e.jsx(Ee,{src:s.profilePicture,alt:`${s.firstName} ${s.lastName}`,sx:{width:o?40:48,height:o?40:48,backgroundColor:"#4CAF50",fontSize:o?"1rem":"1.25rem",fontWeight:600},children:!s.profilePicture&&N()}),e.jsxs(d,{sx:{flex:1,minWidth:0},children:[e.jsxs(w,{variant:o?"subtitle2":"subtitle1",sx:{fontWeight:600,mb:.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:[s.firstName," ",s.lastName]}),e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap",mb:.5},children:[e.jsx(w,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.trackingNumber}),e.jsx(w,{variant:"body2",color:"text.secondary",children:"‚Ä¢"}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.category})]}),e.jsx(w,{variant:"body2",sx:{mb:1,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:t.title}),e.jsx(q,{label:C(t.status),size:"small",sx:{backgroundColor:y(t.status),color:"white",fontWeight:600,fontSize:"0.75rem"}})]}),i&&e.jsx(ee,{onClick:T,size:"small",sx:{alignSelf:"flex-start"},children:c?e.jsx(Ve,{}):e.jsx(Ge,{})})]}),e.jsxs(Ze,{in:c,timeout:"auto",unmountOnExit:!0,children:[e.jsxs(d,{sx:{px:{xs:1.5,sm:2,md:2},pb:{xs:1.5,sm:2,md:2}},children:[e.jsx(qe,{sx:{mb:2}}),e.jsxs(d,{sx:{mb:2},children:[e.jsx(Ye,{sx:{fontSize:18,color:"text.secondary"}}),e.jsx(w,{variant:"body2",sx:{fontWeight:600},children:"Location"})]}),e.jsxs(d,{sx:{ml:3,display:"flex",flexDirection:"column",gap:.5},children:[e.jsxs(w,{variant:"body2",color:"text.secondary",children:[s.cityCorporationName||s.district,s.thanaName?`, ${s.thanaName}`:`, ${s.upazila}`]}),e.jsxs(d,{sx:{display:"flex",gap:1},children:[s.zone&&e.jsx(q,{label:`Zone ${s.zone}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem"}}),s.ward&&e.jsx(q,{label:`Ward ${s.ward}`,size:"small",variant:"outlined",sx:{height:20,fontSize:"0.7rem"}})]})]}),s.address&&e.jsx(w,{variant:"body2",color:"text.secondary",sx:{ml:3,mt:.5,overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},children:s.address})]}),e.jsxs(d,{sx:{mb:2},children:[e.jsx(w,{variant:"body2",sx:{fontWeight:600,mb:1},children:"Contact Information"}),e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,mb:.5},children:[e.jsx(Je,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(w,{variant:"body2",color:"text.secondary",children:s.phone})]}),e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(_e,{sx:{fontSize:16,color:"text.secondary"}}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:s.email})]})]}),e.jsx(d,{sx:{mb:2},children:e.jsxs(w,{variant:"body2",color:"text.secondary",children:["Submitted on ",A(t.createdAt)]})}),e.jsxs(d,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(Y,{variant:"outlined",size:"small",startIcon:e.jsx(Ke,{}),onClick:r,sx:{textTransform:"none",borderRadius:2,flex:o?"1 1 100%":"0 1 auto"},children:"View Full Details"}),e.jsx(Y,{variant:"outlined",size:"small",onClick:m,sx:{textTransform:"none",borderRadius:2,flex:o?"1 1 100%":"0 1 auto"},children:"Change Status"}),l&&e.jsx(Y,{variant:"outlined",size:"small",startIcon:e.jsx(Xe,{}),onClick:l,sx:{textTransform:"none",borderRadius:2,flex:o?"1 1 100%":"0 1 auto"},children:"View History"})]})]}),e.jsx(Qe,{anchorEl:f,open:h,onClose:b,anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:P.map(v=>e.jsxs(Z,{onClick:()=>S(v),disabled:v===t.status,sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(d,{sx:{width:12,height:12,borderRadius:"50%",backgroundColor:y(v)}}),e.jsx(w,{variant:"body2",children:C(v)}),v===t.status&&e.jsx(w,{variant:"caption",color:"text.secondary",sx:{ml:1},children:"(Current)"})]},v))})]})},ae=typeof window<"u"?n.useLayoutEffect:n.useEffect;function Ie(t){if(t!==void 0)switch(typeof t){case"number":return t;case"string":{if(t.endsWith("px"))return parseFloat(t);break}}}function wt({box:t,defaultHeight:s,defaultWidth:r,disabled:a,element:l,mode:u,style:i}){const{styleHeight:o,styleWidth:c}=n.useMemo(()=>({styleHeight:Ie(i==null?void 0:i.height),styleWidth:Ie(i==null?void 0:i.width)}),[i==null?void 0:i.height,i==null?void 0:i.width]),[g,f]=n.useState({height:s,width:r}),x=a||o!==void 0||u==="only-width"||o!==void 0&&c!==void 0;return ae(()=>{if(l===null||x)return;const h=new ResizeObserver(y=>{for(const C of y){const{contentRect:m,target:b}=C;l===b&&f(S=>S.height===m.height&&S.width===m.width?S:{height:m.height,width:m.width})}});return h.observe(l,{box:t}),()=>{h==null||h.unobserve(l)}},[t,x,l,o,c]),n.useMemo(()=>({height:o??g.height,width:c??g.width}),[g,o,c])}function Oe(t){const s=n.useRef(()=>{throw new Error("Cannot call during render.")});return ae(()=>{s.current=t},[t]),n.useCallback(r=>{var a;return(a=s.current)==null?void 0:a.call(s,r)},[s])}function ge({containerElement:t,direction:s,isRtl:r,scrollOffset:a}){return a}function J(t,s="Assertion error"){if(!t)throw console.error(s),Error(s)}function oe(t,s){if(t===s)return!0;if(!!t!=!!s||(J(t!==void 0),J(s!==void 0),Object.keys(t).length!==Object.keys(s).length))return!1;for(const r in t)if(!Object.is(s[r],t[r]))return!1;return!0}function Te({cachedBounds:t,itemCount:s,itemSize:r}){if(s===0)return 0;if(typeof r=="number")return s*r;{const a=t.get(t.size===0?0:t.size-1);J(a!==void 0,"Unexpected bounds cache miss");const l=(a.scrollOffset+a.size)/t.size;return s*l}}function jt({align:t,cachedBounds:s,index:r,itemCount:a,itemSize:l,containerScrollOffset:u,containerSize:i}){if(r<0||r>=a)throw RangeError(`Invalid index specified: ${r}`,{cause:`Index ${r} is not within the range of 0 - ${a-1}`});const o=Te({cachedBounds:s,itemCount:a,itemSize:l}),c=s.get(r),g=Math.max(0,Math.min(o-i,c.scrollOffset)),f=Math.max(0,c.scrollOffset-i+c.size);switch(t==="smart"&&(u>=f&&u<=g?t="auto":t="center"),t){case"start":return g;case"end":return f;case"center":return c.scrollOffset<=i/2?0:c.scrollOffset+c.size/2>=o-i/2?o-i:c.scrollOffset+c.size/2-i/2;case"auto":default:return u>=f&&u<=g?u:u<f?f:g}}function ze({cachedBounds:t,containerScrollOffset:s,containerSize:r,itemCount:a,overscanCount:l}){const u=a-1;let i=0,o=-1,c=0,g=-1,f=0;for(;f<u;){const x=t.get(f);if(x.scrollOffset+x.size>s)break;f++}for(i=f,c=Math.max(0,i-l);f<u;){const x=t.get(f);if(x.scrollOffset+x.size>=s+r)break;f++}return o=Math.min(u,f),g=Math.min(a-1,o+l),i<0&&(i=0,o=-1,c=0,g=-1),{startIndexVisible:i,stopIndexVisible:o,startIndexOverscan:c,stopIndexOverscan:g}}function St({itemCount:t,itemProps:s,itemSize:r}){const a=new Map;return{get(l){for(J(l<t,`Invalid index ${l}`);a.size-1<l;){const i=a.size;let o;switch(typeof r){case"function":{o=r(i,s);break}case"number":{o=r;break}}if(i===0)a.set(i,{size:o,scrollOffset:0});else{const c=a.get(i-1);J(c!==void 0,`Unexpected bounds cache miss for index ${l}`),a.set(i,{scrollOffset:c.scrollOffset+c.size,size:o})}}const u=a.get(l);return J(u!==void 0,`Unexpected bounds cache miss for index ${l}`),u},set(l,u){a.set(l,u)},get size(){return a.size}}}function It({itemCount:t,itemProps:s,itemSize:r}){return n.useMemo(()=>St({itemCount:t,itemProps:s,itemSize:r}),[t,s,r])}function zt({containerSize:t,itemSize:s}){let r;switch(typeof s){case"string":{J(s.endsWith("%"),`Invalid item size: "${s}"; string values must be percentages (e.g. "100%")`),J(t!==void 0,"Container size must be defined if a percentage item size is specified"),r=t*parseInt(s)/100;break}default:{r=s;break}}return r}function kt({containerElement:t,containerStyle:s,defaultContainerSize:r=0,direction:a,isRtl:l=!1,itemCount:u,itemProps:i,itemSize:o,onResize:c,overscanCount:g}){const[f,x]=n.useState({startIndexVisible:0,startIndexOverscan:0,stopIndexVisible:-1,stopIndexOverscan:-1}),{startIndexVisible:h,startIndexOverscan:y,stopIndexVisible:C,stopIndexOverscan:m}={startIndexVisible:Math.min(u-1,f.startIndexVisible),startIndexOverscan:Math.min(u-1,f.startIndexOverscan),stopIndexVisible:Math.min(u-1,f.stopIndexVisible),stopIndexOverscan:Math.min(u-1,f.stopIndexOverscan)},{height:b=r,width:S=r}=wt({defaultHeight:r,defaultWidth:void 0,element:t,mode:"only-height",style:s}),T=n.useRef({height:0,width:0}),N=b,A=zt({containerSize:N,itemSize:o});n.useLayoutEffect(()=>{if(typeof c=="function"){const j=T.current;(j.height!==b||j.width!==S)&&(c({height:b,width:S},{...j}),j.height=b,j.width=S)}},[b,c,S]);const P=It({itemCount:u,itemProps:i,itemSize:A}),v=n.useCallback(j=>P.get(j),[P]),M=n.useCallback(()=>Te({cachedBounds:P,itemCount:u,itemSize:A}),[P,u,A]),I=n.useCallback(j=>{const D=ge({containerElement:t,direction:a,isRtl:l,scrollOffset:j});return ze({cachedBounds:P,containerScrollOffset:D,containerSize:N,itemCount:u,overscanCount:g})},[P,t,N,a,l,u,g]);ae(()=>{const j=(t==null?void 0:t.scrollTop)??0;x(I(j))},[t,a,I]),ae(()=>{if(!t)return;const j=()=>{x(D=>{const{scrollLeft:B,scrollTop:O}=t,E=ge({containerElement:t,direction:a,isRtl:l,scrollOffset:O}),W=ze({cachedBounds:P,containerScrollOffset:E,containerSize:N,itemCount:u,overscanCount:g});return oe(W,D)?D:W})};return t.addEventListener("scroll",j),()=>{t.removeEventListener("scroll",j)}},[P,t,N,a,u,g]);const z=Oe(({align:j="auto",containerScrollOffset:D,index:B})=>{let O=jt({align:j,cachedBounds:P,containerScrollOffset:D,containerSize:N,index:B,itemCount:u,itemSize:A});if(t){if(O=ge({containerElement:t,direction:a,isRtl:l,scrollOffset:O}),typeof t.scrollTo!="function"){const E=I(O);oe(f,E)||x(E)}return O}});return{getCellBounds:v,getEstimatedSize:M,scrollToIndex:z,startIndexOverscan:y,startIndexVisible:h,stopIndexOverscan:m,stopIndexVisible:C}}function Et(t){return n.useMemo(()=>t,Object.values(t))}function Rt(t,s){const{ariaAttributes:r,style:a,...l}=t,{ariaAttributes:u,style:i,...o}=s;return oe(r,u)&&oe(a,i)&&oe(l,o)}function Nt(t){return t!=null&&typeof t=="object"&&"getAverageRowHeight"in t&&typeof t.getAverageRowHeight=="function"}const be="data-react-window-index";function Mt({children:t,className:s,defaultHeight:r=0,listRef:a,onResize:l,onRowsRendered:u,overscanCount:i=3,rowComponent:o,rowCount:c,rowHeight:g,rowProps:f,tagName:x="div",style:h,...y}){const C=Et(f),m=n.useMemo(()=>n.memo(o,Rt),[o]),[b,S]=n.useState(null),T=Nt(g),N=n.useMemo(()=>T?O=>g.getRowHeight(O)??g.getAverageRowHeight():g,[T,g]),{getCellBounds:A,getEstimatedSize:P,scrollToIndex:v,startIndexOverscan:M,startIndexVisible:I,stopIndexOverscan:z,stopIndexVisible:j}=kt({containerElement:b,containerStyle:h,defaultContainerSize:r,direction:"vertical",itemCount:c,itemProps:C,itemSize:N,onResize:l,overscanCount:i});n.useImperativeHandle(a,()=>({get element(){return b},scrollToRow({align:O="auto",behavior:E="auto",index:W}){const V=v({align:O,containerScrollOffset:(b==null?void 0:b.scrollTop)??0,index:W});typeof(b==null?void 0:b.scrollTo)=="function"&&b.scrollTo({behavior:E,top:V})}}),[b,v]),ae(()=>{if(!b)return;const O=Array.from(b.children).filter((E,W)=>{if(E.hasAttribute("aria-hidden"))return!1;const V=`${M+W}`;return E.setAttribute(be,V),!0});if(T)return g.observeRowElements(O)},[b,T,g,M,z]),n.useEffect(()=>{M>=0&&z>=0&&u&&u({startIndex:I,stopIndex:j},{startIndex:M,stopIndex:z})},[u,M,I,z,j]);const D=n.useMemo(()=>{const O=[];if(c>0)for(let E=M;E<=z;E++){const W=A(E);O.push(n.createElement(m,{...C,ariaAttributes:{"aria-posinset":E+1,"aria-setsize":c,role:"listitem"},key:E,index:E,style:{position:"absolute",left:0,transform:`translateY(${W.scrollOffset}px)`,height:T?void 0:W.size,width:"100%"}}))}return O},[m,A,T,c,C,M,z]),B=e.jsx("div",{"aria-hidden":!0,style:{height:P(),width:"100%",zIndex:-1}});return n.createElement(x,{role:"list",...y,className:s,ref:S,style:{position:"relative",maxHeight:"100%",flexGrow:1,overflowY:"auto",...h}},D,t,B)}function Ot({defaultRowHeight:t,key:s}){const[r,a]=n.useState({key:s,map:new Map});r.key!==s&&a({key:s,map:new Map});const{map:l}=r,u=n.useCallback(()=>{let x=0;return l.forEach(h=>{x+=h}),x===0?t:x/l.size},[t,l]),i=n.useCallback(x=>{const h=l.get(x);return h!==void 0?h:(l.set(x,t),t)},[t,l]),o=n.useCallback((x,h)=>{a(y=>{if(y.map.get(x)===h)return y;const C=new Map(y.map);return C.set(x,h),{...y,map:C}})},[]),c=Oe(x=>{x.length!==0&&x.forEach(h=>{const{borderBoxSize:y,target:C}=h,m=C.getAttribute(be);J(m!==null,`Invalid ${be} attribute value`);const b=parseInt(m),{blockSize:S}=y[0];S&&o(b,S)})}),[g]=n.useState(()=>new ResizeObserver(c));n.useEffect(()=>()=>{g.disconnect()},[g]);const f=n.useCallback(x=>(x.forEach(h=>g.observe(h)),()=>{x.forEach(h=>g.unobserve(h))}),[g]);return n.useMemo(()=>({getAverageRowHeight:u,getRowHeight:i,setRowHeight:o,observeRowElements:f}),[u,i,o,f])}const Tt=t=>{const s=new Date,r=new Date(t),a=Math.floor((s.getTime()-r.getTime())/1e3);if(a<60)return"Just now";if(a<3600){const l=Math.floor(a/60);return`${l} min${l>1?"s":""} ago`}else if(a<86400){const l=Math.floor(a/3600);return`${l} hour${l>1?"s":""} ago`}else if(a<604800){const l=Math.floor(a/86400);return`${l} day${l>1?"s":""} ago`}else return r.toLocaleDateString([],{month:"short",day:"numeric",year:r.getFullYear()!==s.getFullYear()?"numeric":void 0})},ke=({message:t,isAdmin:s,showSenderName:r=!1})=>{const[a,l]=n.useState(!1),u=s?"16px 16px 4px 16px":"16px 16px 16px 4px";return e.jsxs(e.Fragment,{children:[e.jsx(d,{sx:{mb:1.5,display:"flex",justifyContent:s?"flex-end":"flex-start",animation:`${Me} ${G.normal.duration} ${G.normal.timing}, ${ft} ${G.normal.duration} ${G.smooth.timing}`,animationFillMode:"both"},children:e.jsxs(d,{sx:{maxWidth:{xs:"85%",sm:"75%",md:"70%"},minWidth:"100px",p:1.5,borderRadius:u,background:s?"linear-gradient(135deg, #1976d2 0%, #2e7d32 100%)":"#ffffff",color:s?"#ffffff":"#1a1a1a",boxShadow:s?"0 2px 8px rgba(25, 118, 210, 0.25)":"0 2px 8px rgba(0, 0, 0, 0.08)",border:s?"none":"1px solid #e0e0e0",transition:`all ${G.fast.duration} ${G.fast.timing}`,"&:hover":{boxShadow:s?"0 4px 12px rgba(25, 118, 210, 0.35)":"0 4px 12px rgba(0, 0, 0, 0.12)",transform:"translateY(-1px)"}},children:[!s&&r&&t.senderName&&e.jsx(w,{variant:"caption",sx:{fontWeight:700,display:"block",mb:.5,color:"#1976d2",fontSize:"0.75rem",letterSpacing:"0.02em"},children:t.senderName}),e.jsx(w,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.5,fontSize:"0.9rem"},children:t.message}),t.imageUrl&&e.jsx(d,{component:"img",src:t.imageUrl,alt:"Message attachment",loading:"lazy",onLoad:()=>{var o;console.log("‚úÖ Image loaded successfully:",(o=t.imageUrl)==null?void 0:o.substring(0,100))},onError:o=>{var g,f;console.error("‚ùå Image failed to load:",(g=t.imageUrl)==null?void 0:g.substring(0,100)),console.error("   Full URL:",t.imageUrl),o.currentTarget.style.display="none";const c=document.createElement("div");c.textContent="‚ùå Image failed to load",c.style.color=s?"#ffcccc":"#ff0000",c.style.fontSize="0.8rem",c.style.marginTop="8px",(f=o.currentTarget.parentElement)==null||f.appendChild(c)},sx:{mt:1,maxWidth:"100%",maxHeight:"300px",borderRadius:"8px",cursor:"pointer",objectFit:"cover",transition:`all ${G.fast.duration} ${G.fast.timing}`,"&:hover":{opacity:.9,transform:"scale(1.02)"}},onClick:()=>l(!0)}),e.jsxs(d,{sx:{display:"flex",alignItems:"center",justifyContent:s?"flex-end":"flex-start",mt:.5,gap:.5},children:[e.jsx(w,{variant:"caption",sx:{opacity:s?.85:.6,fontSize:"0.7rem",fontWeight:500},children:Tt(t.createdAt)}),s&&e.jsx(d,{sx:{display:"flex",alignItems:"center",opacity:.85},children:t.read?e.jsx(et,{sx:{fontSize:"0.9rem",color:"#4caf50"}}):e.jsx(tt,{sx:{fontSize:"0.9rem"}})})]})]})}),t.imageUrl&&e.jsx(st,{open:a,onClose:()=>l(!1),sx:{display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsxs(d,{sx:{position:"relative",maxWidth:"90vw",maxHeight:"90vh",outline:"none"},children:[e.jsx(ee,{onClick:()=>l(!1),sx:{position:"absolute",top:-40,right:0,color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"}},children:e.jsx(Ne,{})}),e.jsx(d,{component:"img",src:t.imageUrl,alt:"Message attachment (full size)",sx:{maxWidth:"100%",maxHeight:"90vh",objectFit:"contain",borderRadius:"8px",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.3)"}})]})})]})},At=({messages:t,loading:s,loadingMore:r=!1,hasMoreMessages:a=!1,onLoadMore:l,onScroll:u})=>{const i=n.useRef(null),o=n.useRef(null),c=n.useRef(0),g=Ot({defaultRowHeight:100}),f=n.useCallback(()=>{var h;(h=o.current)==null||h.scrollIntoView({behavior:"smooth"})},[]),x=n.useCallback(h=>{if(u&&u(h),!i.current||r||!a||!l)return;const{scrollTop:y}=i.current;y<100&&(c.current=i.current.scrollHeight,l())},[u,r,a,l]);return n.useEffect(()=>{t.length>0&&!s&&!r&&setTimeout(f,100)},[t.length,s,r,f]),n.useEffect(()=>{if(r&&i.current&&c.current>0){const y=i.current.scrollHeight-c.current;i.current.scrollTop=y,c.current=0}},[t,r]),e.jsxs(d,{ref:i,onScroll:x,sx:{flex:1,overflowY:"auto",overflowX:"hidden",p:{xs:1.5,sm:2,md:2},backgroundColor:"#f5f5f5",display:"flex",flexDirection:"column"},children:[s&&e.jsx(d,{sx:{display:"flex",justifyContent:"center",alignItems:"center",py:4,flex:1},children:e.jsx(ie,{size:32})}),!s&&e.jsxs(e.Fragment,{children:[r&&e.jsx(d,{sx:{display:"flex",justifyContent:"center",py:2},children:e.jsx(ie,{size:24})}),!a&&t.length>0&&e.jsx(d,{sx:{textAlign:"center",py:2},children:e.jsx(w,{variant:"caption",color:"text.secondary",children:"Start of conversation"})}),t.length>0&&e.jsx(e.Fragment,{children:t.length>200?e.jsx(Mt,{rowCount:t.length,rowHeight:g,overscanCount:10,rowComponent:({index:h,style:y})=>{const C=t[h];return e.jsx("div",{style:y,children:e.jsx(ke,{message:C,isAdmin:C.senderType==="ADMIN",showSenderName:C.senderType==="CITIZEN"},C.id)})},rowProps:{},style:{height:window.innerHeight-300}}):e.jsx(d,{children:t.map(h=>e.jsx(ke,{message:h,isAdmin:h.senderType==="ADMIN",showSenderName:h.senderType==="CITIZEN"},h.id))})}),t.length===0&&e.jsx(d,{sx:{flex:1,display:"flex",alignItems:"center"},children:e.jsx(pe,{type:"no-messages"})}),e.jsx("div",{ref:o})]})]})};async function Pt(t,s=1920,r=1080,a=.8){return new Promise((l,u)=>{const i=new FileReader;i.onload=o=>{var g;const c=new Image;c.onload=()=>{let f=c.width,x=c.height;f>s&&(x=x*s/f,f=s),x>r&&(f=f*r/x,x=r);const h=document.createElement("canvas");h.width=f,h.height=x;const y=h.getContext("2d");if(!y){u(new Error("Failed to get canvas context"));return}y.drawImage(c,0,0,f,x),h.toBlob(C=>{C?l(C):u(new Error("Failed to compress image"))},"image/jpeg",a)},c.onerror=()=>{u(new Error("Failed to load image"))},c.src=(g=o.target)==null?void 0:g.result},i.onerror=()=>{u(new Error("Failed to read file"))},i.readAsDataURL(t)})}function Wt(t,s=5){if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(t.type))return{valid:!1,error:"Invalid file type. Please upload a JPEG, PNG, GIF, or WebP image."};const a=s*1024*1024;return t.size>a?{valid:!1,error:`File size exceeds ${s}MB. Please choose a smaller image.`}:{valid:!0}}function Dt(t,s){return new File([t],s,{type:t.type})}const Ft=({onSend:t,onSendWithFile:s,sending:r,disabled:a=!1})=>{const[l,u]=n.useState(""),[i,o]=n.useState(null),[c,g]=n.useState(null),[f,x]=n.useState(!1),[h,y]=n.useState(null),C=n.useRef(null),m=n.useRef(null),b=I=>{u(I.target.value)},S=async I=>{var D;const z=(D=I.target.files)==null?void 0:D[0];if(!z)return;const j=Wt(z,5);if(!j.valid){F.error(j.error||"Invalid image file",{icon:"‚ùå"});return}try{const B=F.loading("Compressing image..."),O=await Pt(z,1920,1080,.8),E=Dt(O,z.name),W=((1-E.size/z.size)*100).toFixed(0);F.dismiss(B),E.size<z.size&&F.success(`Image compressed by ${W}%`,{icon:"‚úÖ",duration:2e3}),o(E);const V=new FileReader;V.onloadend=()=>{g(V.result)},V.readAsDataURL(E),T(E)}catch(B){console.error("Error compressing image:",B),F.error("Failed to process image. Please try again.",{icon:"‚ùå"})}},T=async I=>{try{x(!0),y("READY_TO_SEND"),F.success("Image ready to send",{icon:"‚úÖ",duration:2e3})}catch(z){console.error("Error processing image:",z),F.error("Failed to process image. Please try again.",{icon:"‚ùå"}),N()}finally{x(!1)}},N=()=>{o(null),g(null),y(null),C.current&&(C.current.value="")},A=async()=>{var z;const I=l.trim();if(!I&&!h){F.error("Please enter a message or select an image",{icon:"‚ö†Ô∏è"});return}if(i&&!h){F.error("Please wait for image to finish uploading",{icon:"‚è≥"});return}try{if(console.log("üì§ Sending message with image file:",i==null?void 0:i.name),console.log("üì§ onSendWithFile available:",!!s),i&&s)console.log("‚úÖ Using onSendWithFile for file:",i.name),await s(I||"Image",i);else if(i&&!s){console.error("‚ùå onSendWithFile not available!"),console.error("‚ùå This means ChatConversationPanel did not pass onSendWithFile prop"),F.error("Cannot send image - feature not available",{icon:"‚ùå"});return}else console.log("‚úÖ Sending text only (no image)"),await t(I,void 0);u(""),N(),(z=m.current)==null||z.focus()}catch(j){console.error("‚ùå Error sending message:",j)}},P=I=>{I.key==="Enter"&&!I.shiftKey&&(I.preventDefault(),!r&&!f&&!a&&A())},v=()=>{var I;(I=C.current)==null||I.click()},M=a||r||f||!l.trim()&&!h;return e.jsxs(d,{sx:{p:{xs:1.5,sm:2,md:2},borderTop:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:[c&&e.jsxs(rt,{elevation:2,sx:{mb:2,p:1,position:"relative",display:"inline-block",maxWidth:"200px"},children:[e.jsx(d,{component:"img",src:c,alt:"Preview",sx:{width:"100%",height:"auto",maxHeight:"150px",objectFit:"cover",borderRadius:"4px"}}),e.jsx(ee,{size:"small",onClick:N,disabled:f,sx:{position:"absolute",top:4,right:4,backgroundColor:"rgba(0, 0, 0, 0.6)",color:"white","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.8)"}},children:e.jsx(Ne,{fontSize:"small"})}),f&&e.jsx(d,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(255, 255, 255, 0.8)",borderRadius:"4px"},children:e.jsx(ie,{size:24})})]}),e.jsxs(d,{sx:{display:"flex",gap:1,alignItems:"flex-end"},children:[e.jsx("input",{ref:C,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp",style:{display:"none"},onChange:S}),e.jsx(Ce,{title:"Attach image",children:e.jsx("span",{children:e.jsx(ee,{color:"primary",onClick:v,disabled:a||r||f||!!i,sx:{mb:.5},children:e.jsx(nt,{})})})}),e.jsx(Re,{inputRef:m,fullWidth:!0,multiline:!0,maxRows:4,placeholder:"Type a message...",value:l,onChange:b,onKeyDown:P,disabled:a||r,variant:"outlined",size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:"20px",backgroundColor:"background.default"}}}),e.jsx(Ce,{title:r?"Sending...":"Send message (Enter)",children:e.jsx("span",{children:e.jsx(ee,{color:"primary",onClick:A,disabled:M,sx:{mb:.5,backgroundColor:"primary.main",color:"white","&:hover":{backgroundColor:"primary.dark"},"&.Mui-disabled":{backgroundColor:"action.disabledBackground",color:"action.disabled"}},children:r?e.jsx(ie,{size:24,color:"inherit"}):e.jsx(ot,{})})})})]}),l.length>0&&e.jsx(d,{sx:{mt:.5,textAlign:"right"},children:e.jsxs(d,{component:"span",sx:{fontSize:"0.75rem",color:l.length>1e3?"error.main":"text.secondary"},children:[l.length," / 1000"]})})]})},Ae=({error:t,onRetry:s,variant:r="centered"})=>r==="alert"?e.jsx(it,{severity:"error",sx:{m:2},action:s&&e.jsx(Y,{color:"inherit",size:"small",onClick:s,startIcon:e.jsx(me,{}),children:"Retry"}),children:t}):r==="inline"?e.jsxs(d,{sx:{p:2,backgroundColor:"#ffebee",borderRadius:1,display:"flex",alignItems:"center",gap:1},children:[e.jsx(we,{sx:{color:"error.main"}}),e.jsx(d,{sx:{flex:1},children:e.jsx(w,{variant:"body2",color:"error",children:t})}),s&&e.jsx(Y,{size:"small",variant:"outlined",color:"error",onClick:s,startIcon:e.jsx(me,{}),children:"Retry"})]}):e.jsxs(d,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:6,px:3},children:[e.jsx(we,{sx:{fontSize:48,color:"error.main",mb:2}}),e.jsx(w,{variant:"h6",color:"error",sx:{mb:1,textAlign:"center"},children:"Something went wrong"}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mb:3,textAlign:"center",maxWidth:400},children:t}),s&&e.jsx(Y,{variant:"contained",color:"primary",onClick:s,startIcon:e.jsx(me,{}),children:"Try Again"})]}),Lt=({complaintId:t,onClose:s,onMessagesRead:r})=>{var V,te,le,ce,de;const a=ue(),l=se(a.breakpoints.down("md")),[u,i]=n.useState([]),[o,c]=n.useState(null),[g,f]=n.useState(!1),[x,h]=n.useState(null),[y,C]=n.useState(!0),[m,b]=n.useState(1),[S,T]=n.useState(!1),[N,A]=n.useState(!1),[P,v]=n.useState(!1),M=n.useCallback(async(R=1,$=!1)=>{if(t)try{R===1?f(!0):T(!0),h(null);const{messages:k,pagination:p}=await X.getChatMessages(t,R,50);i($?U=>[...k,...U]:k),C(p.hasNextPage),b(R)}catch(k){const p=k instanceof Error?k.message:"Failed to load messages";h(p),console.error("Error fetching messages:",k),F.error("Failed to load messages. Please check your connection.",{icon:"‚ùå",duration:4e3})}finally{f(!1),T(!1)}},[t]),I=n.useCallback(async()=>{if(t)try{const R=await Se.getComplaintById(t);c(R)}catch(R){console.error("Error fetching complaint details:",R)}},[t]),z=n.useCallback(async()=>{if(t)try{await X.markAsRead(t),i(R=>R.map($=>({...$,read:!0}))),r&&r()}catch(R){console.error("Error marking messages as read:",R)}},[t,r]),j=n.useCallback(()=>{!y||S||M(m+1,!0)},[y,S,m,M]),D=()=>{v(!0)},B=async R=>{if(!(!t||!o))try{await Se.updateComplaintStatus(t,{status:R,note:"Status changed from chat interface"}),c({...o,status:R}),F.success(`Status updated to ${R}`,{icon:"‚úÖ"})}catch($){console.error("Error updating status:",$),F.error("Failed to update status",{icon:"‚ùå"})}},O=(R,$)=>{o&&R===o.id&&c({...o,status:$})},E=async(R,$)=>{if(t)try{A(!0);const k=await X.sendMessage(t,{message:R,imageUrl:$});i(p=>[...p,k]),F.success("Message sent successfully",{icon:"‚úÖ"})}catch(k){console.error("Error sending message:",k);const p=k instanceof Error?k.message:"Failed to send message";throw F.error(p,{icon:"‚ùå"}),k}finally{A(!1)}},W=async(R,$)=>{if(t)try{A(!0);const k=await X.sendMessageWithFile(t,R,$);i(p=>[...p,k]),F.success("Message sent successfully",{icon:"‚úÖ"})}catch(k){console.error("Error sending message with file:",k);const p=k instanceof Error?k.message:"Failed to send message";throw F.error(p,{icon:"‚ùå"}),k}finally{A(!1)}};return n.useEffect(()=>{t&&(i([]),c(null),h(null),b(1),C(!0),M(1),I(),z())},[t,M,I,z]),n.useEffect(()=>{if(!t)return;const R=setInterval(()=>{X.getChatMessages(t,1,50).then(({messages:$})=>{i(k=>{var L;const p=(L=k[k.length-1])==null?void 0:L.id;return $.some(H=>H.id>(p||0))?$:k})}).catch($=>{console.error("Error polling messages:",$)})},5e3);return()=>{clearInterval(R)}},[t]),t?e.jsxs(d,{sx:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[o&&o.user?e.jsxs(d,{sx:{position:"relative"},children:[l&&s&&e.jsx(ee,{onClick:s,size:"small",sx:{position:"absolute",top:8,left:8,zIndex:1,backgroundColor:"background.paper",boxShadow:1,"&:hover":{backgroundColor:"background.paper"}},children:e.jsx(je,{})}),e.jsx(Ct,{complaint:{id:o.id,trackingNumber:o.trackingNumber||`#${o.id}`,title:o.title,category:o.category,status:o.status,createdAt:new Date(o.createdAt)},citizen:{id:o.user.id,firstName:o.user.firstName,lastName:o.user.lastName,phone:o.user.phone,email:o.user.email,zone:typeof o.user.zone=="string"?o.user.zone:((V=o.user.zone)==null?void 0:V.name)||"N/A",district:((te=o.locationDetails)==null?void 0:te.district)||"N/A",upazila:((le=o.locationDetails)==null?void 0:le.thana)||"N/A",ward:((ce=o.locationDetails)==null?void 0:ce.ward)||"N/A",address:((de=o.locationDetails)==null?void 0:de.address)||"",profilePicture:void 0},onViewDetails:D,onStatusChange:B})]}):e.jsx(d,{sx:{p:2,borderBottom:"1px solid",borderColor:"divider",backgroundColor:"background.paper"},children:e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[l&&s&&e.jsx(ee,{onClick:s,size:"small",sx:{mr:1},children:e.jsx(je,{})}),e.jsx(d,{sx:{flex:1},children:e.jsx(w,{variant:"subtitle1",sx:{fontWeight:600},children:"Loading..."})})]})}),x&&!g?e.jsx(Ae,{error:x,onRetry:()=>M(1,!1),variant:"centered"}):e.jsx(At,{messages:u,loading:g,loadingMore:S,hasMoreMessages:y,onLoadMore:j}),e.jsx(Ft,{onSend:E,onSendWithFile:W,sending:N,disabled:!t||g}),o&&e.jsx(mt,{complaintId:o.id,open:P,onClose:()=>v(!1),onStatusUpdate:O})]}):e.jsx(d,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",color:"text.secondary",p:3},children:e.jsx(w,{variant:"body1",children:"Select a chat to start messaging"})})},Q=class Q{constructor(){fe(this,"permissionGranted",!1);this.checkPermission()}static getInstance(){return Q.instance||(Q.instance=new Q),Q.instance}isSupported(){return"Notification"in window}checkPermission(){this.isSupported()&&(this.permissionGranted=Notification.permission==="granted")}async requestPermission(){if(!this.isSupported())return console.warn("Browser notifications are not supported"),!1;if(Notification.permission==="granted")return this.permissionGranted=!0,!0;if(Notification.permission==="denied")return console.warn("Notification permission was denied"),!1;try{const s=await Notification.requestPermission();return this.permissionGranted=s==="granted",this.permissionGranted}catch(s){return console.error("Error requesting notification permission:",s),!1}}showNotification(s,r){if(!this.isSupported()||!this.permissionGranted)return null;try{return new Notification(s,{...r,icon:r.icon||"/favicon.png",badge:r.badge||"/favicon.png",requireInteraction:r.requireInteraction??!1})}catch(a){return console.error("Error showing notification:",a),null}}showNewMessageNotification(s,r,a,l,u){const i=this.showNotification(`New message from ${s}`,{body:r,tag:`chat-${a}`,data:{complaintId:a,trackingNumber:l,type:"new-message"},requireInteraction:!1});return i&&u&&(i.onclick=()=>{window.focus(),u(),i.close()}),i}getPermissionStatus(){return this.isSupported()?Notification.permission:"denied"}hasPermission(){return this.permissionGranted}};fe(Q,"instance");let ye=Q;const ne=ye.getInstance(),Jt=()=>{const{complaintId:t}=lt(),s=ct(),r=ue(),a=se(r.breakpoints.down("md")),l=se(r.breakpoints.between("md","lg")),[u,i]=n.useState([]),[o,c]=n.useState(null),[g,f]=n.useState(!0),[x,h]=n.useState(null),[y,C]=n.useState(""),[m,b]=n.useState({district:void 0,upazila:void 0,ward:void 0,zone:void 0,cityCorporationCode:void 0,thanaId:void 0,status:void 0,unreadOnly:!1,page:1,limit:20}),[S,T]=n.useState(1),[N,A]=n.useState(!0),[P,v]=n.useState(0),[M,I]=n.useState({totalChats:0,unreadCount:0,byDistrict:[],byUpazila:[],byWard:[],byZone:[],byStatus:[]}),[z,j]=n.useState(!1),D=n.useRef([]),B=n.useRef(!0);n.useEffect(()=>{if(ne.isSupported()&&ne.getPermissionStatus()==="default"){const p=setTimeout(()=>{ne.requestPermission().then(U=>{U&&console.log("Browser notification permission granted")})},2e3);return()=>clearTimeout(p)}},[]);const O=n.useCallback(p=>{const U=p.citizen.firstName+" "+p.citizen.lastName,L=p.lastMessage.text.length>50?p.lastMessage.text.substring(0,50)+"...":p.lastMessage.text,H=()=>{s(`/chats/${p.complaintId}`),c(p.complaintId),a&&j(!0)};F(_=>e.jsxs(d,{onClick:()=>{F.dismiss(_.id),H()},sx:{cursor:"pointer","&:hover":{opacity:.9}},children:[e.jsxs(d,{sx:{fontWeight:600,mb:.5,color:"#3FA564"},children:["New message from ",U]}),e.jsx(d,{sx:{fontSize:"0.875rem",color:"#666"},children:L}),e.jsxs(d,{sx:{fontSize:"0.75rem",color:"#999",mt:.5},children:["Complaint #",p.trackingNumber]})]}),{duration:6e3,icon:"üí¨",style:{background:"#fff",color:"#333",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",borderLeft:"4px solid #3FA564",padding:"16px",maxWidth:"400px"}}),ne.hasPermission()&&!document.hasFocus()&&ne.showNewMessageNotification(U,`${L}

Complaint #${p.trackingNumber}`,p.complaintId,p.trackingNumber,H)},[s,a]),E=n.useCallback(p=>{if(B.current){B.current=!1,D.current=p;return}const U=D.current;p.forEach(L=>{const H=U.find(_=>_.complaintId===L.complaintId);H?L.lastMessage&&H.lastMessage&&L.lastMessage.id!==H.lastMessage.id&&L.lastMessage.senderType==="CITIZEN"&&L.complaintId!==o&&O(L):L.lastMessage&&L.lastMessage.senderType==="CITIZEN"&&O(L)}),D.current=p},[o,O]),W=n.useCallback(async(p=!1,U,L=!1)=>{try{L||f(!0),h(null);const H=U||S,_={...m,search:y||void 0,page:H,limit:20},K=await X.getChatConversationsWithPagination(_);H===1&&!L&&E(K.chats),i(L?Pe=>[...Pe,...K.chats]:K.chats),K.pagination&&(T(K.pagination.page),v(K.pagination.total),A(K.pagination.hasNextPage))}catch(H){const _=H instanceof Error?H.message:"Failed to load chats";h(_),console.error("Error fetching chat list:",H),p&&F.error("Failed to load chats. Please check your connection.",{icon:"‚ùå",duration:4e3})}finally{f(!1)}},[m,y,E,S]),V=n.useCallback(()=>{if(N&&!g){const p=S+1;T(p),W(!1,p,!0)}},[N,g,S,W]),te=n.useCallback(async()=>{try{const p=await X.getChatStatistics();I(p)}catch(p){console.error("Error fetching statistics:",p)}},[]);n.useEffect(()=>{W(!0),te()},[]),n.useEffect(()=>{if(B.current)return;const p=setTimeout(()=>{W(!1)},500);return()=>clearTimeout(p)},[m,y]),n.useEffect(()=>{if(t){const p=parseInt(t,10);isNaN(p)||(c(p),a&&j(!0))}},[t,a]),n.useEffect(()=>{const p=setInterval(()=>{W(!1),te()},1e4);return()=>{clearInterval(p)}},[]);const le=p=>{c(p),a&&j(!0)},ce=()=>{j(!1),c(null)},de=p=>{C(p)},R=p=>{b(U=>({...U,...p})),T(1),i([])},k=a?{filter:"0%",list:"100%",conversation:"100%"}:l?{filter:"0%",list:"40%",conversation:"60%"}:{filter:"20%",list:"30%",conversation:"50%"};return e.jsx(xt,{title:"Messages",children:e.jsxs(d,{sx:{display:"flex",height:"calc(100vh - 140px)",gap:2,overflow:"hidden"},children:[!a&&!l&&e.jsx(d,{sx:{width:k.filter,display:"flex",flexDirection:"column",overflow:"hidden"},children:e.jsx(pt,{filters:m,onFilterChange:R,statistics:M})}),(!a||!z)&&e.jsx(d,{sx:{width:k.list,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:x&&!g?e.jsx(Ae,{error:x,onRetry:()=>W(!0),variant:"centered"}):e.jsx(vt,{chats:u,selectedChatId:o,onChatSelect:le,searchTerm:y,onSearchChange:de,filters:m,onFilterChange:R,statistics:M,loading:g,hasMore:N,onLoadMore:V,totalChats:P})}),(!a||z)&&e.jsx(d,{sx:{width:k.conversation,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:e.jsx(Lt,{complaintId:o,onClose:a?ce:void 0,onMessagesRead:()=>{W(!1),te()}})})]})})};export{Jt as default};
