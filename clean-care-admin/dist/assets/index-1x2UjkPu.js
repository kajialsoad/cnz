import{u as _,o as D,j as o,B as c}from"./mui-vendor-Y6GvQTLC.js";import{i as ee,d as te,r as t}from"./react-vendor-D7yrL1sD.js";import{z as N,t as B,M as se}from"./index-B_PiLh6w.js";import{b as m,C as ae}from"./browserNotifications-Bj-m_vDF.js";import{C as oe}from"./ChatListPanel-DBqvchzL.js";import{C as ie}from"./ChatConversationPanel-BD4nv1FE.js";import{E as ne}from"./ErrorDisplay-BztN8unE.js";import"./query-vendor-D4yC0Jq7.js";import"./chart-vendor-BgnY-Lfo.js";import"./useDebounce-CcxK0pTh.js";import"./dateUtils-Ct98g1e7.js";const be=()=>{const{complaintId:b}=ee(),k=te(),w=_(),n=D(w.breakpoints.down("md")),P=D(w.breakpoints.between("md","lg")),[U,p]=t.useState([]),[d,u]=t.useState(null),[E,j]=t.useState(!0),[T,F]=t.useState(null),[f,Z]=t.useState(""),[h,$]=t.useState({district:void 0,upazila:void 0,ward:void 0,zone:void 0,cityCorporationCode:void 0,thanaId:void 0,status:void 0,unreadOnly:!1,page:1,limit:20}),[v,g]=t.useState(1),[A,q]=t.useState(1),[O,Q]=t.useState(0),[L,G]=t.useState({totalChats:0,unreadCount:0,byDistrict:[],byUpazila:[],byWard:[],byZone:[],byStatus:[]}),[R,x]=t.useState(!1),S=t.useRef([]),y=t.useRef(!0);t.useEffect(()=>{if(m.isSupported()&&m.getPermissionStatus()==="default"){const e=setTimeout(()=>{m.requestPermission().then(a=>{a&&console.log("Browser notification permission granted")})},2e3);return()=>clearTimeout(e)}},[]);const I=t.useCallback(e=>{const a=e.citizen.firstName+" "+e.citizen.lastName,s=e.lastMessage.text.length>50?e.lastMessage.text.substring(0,50)+"...":e.lastMessage.text,r=()=>{k(`/complaint-chats/${e.complaintId}`),u(e.complaintId),n&&x(!0)};N(i=>o.jsxs(c,{onClick:()=>{N.dismiss(i.id),r()},sx:{cursor:"pointer","&:hover":{opacity:.9}},children:[o.jsxs(c,{sx:{fontWeight:600,mb:.5,color:"#3FA564"},children:["New message from ",a]}),o.jsx(c,{sx:{fontSize:"0.875rem",color:"#666"},children:s}),o.jsxs(c,{sx:{fontSize:"0.75rem",color:"#999",mt:.5},children:["Complaint #",e.trackingNumber]})]}),{duration:6e3,icon:"ðŸ’¬",style:{background:"#fff",color:"#333",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",borderLeft:"4px solid #3FA564",padding:"16px",maxWidth:"400px"}}),m.hasPermission()&&!document.hasFocus()&&m.showNewMessageNotification(a,`${s}

Complaint #${e.trackingNumber}`,e.complaintId,e.trackingNumber,r)},[k,n]),z=t.useCallback(e=>{if(y.current){y.current=!1,S.current=e;return}const a=S.current;e.forEach(s=>{const r=a.find(i=>i.complaintId===s.complaintId);r?s.lastMessage&&r.lastMessage&&s.lastMessage.id!==r.lastMessage.id&&s.lastMessage.senderType==="CITIZEN"&&s.complaintId!==d&&I(s):s.lastMessage&&s.lastMessage.senderType==="CITIZEN"&&I(s)}),S.current=e},[d,I]),l=t.useCallback(async(e=!1,a)=>{try{j(!0),F(null);const s=a!==void 0?a:v,r={...h,search:f||void 0,page:s,limit:20},i=await B.getChatConversationsWithPagination(r);s===1&&z(i.chats),p(i.chats),i.pagination&&(g(i.pagination.page),Q(i.pagination.total),q(Math.ceil(i.pagination.total/20)))}catch(s){const r=s instanceof Error?s.message:"Failed to load chats";F(r),console.error("ðŸ“¥ Error fetching chat list:",s),e&&N.error("Failed to load chats. Please check your connection.",{icon:"âŒ",duration:4e3})}finally{j(!1)}},[h,f,z,v]),H=t.useCallback(e=>{u(null),g(e),l(!1,e)},[l]),C=t.useCallback(async()=>{try{const e=await B.getChatStatistics();G(e)}catch(e){console.error("Error fetching statistics:",e)}},[]);t.useEffect(()=>{l(!0),C()},[]),t.useEffect(()=>{if(y.current)return;g(1),p([]);const e=setTimeout(()=>{l(!1,1)},500);return()=>clearTimeout(e)},[h,f]),t.useEffect(()=>{if(b){const e=parseInt(b,10);isNaN(e)||(u(e),n&&x(!0))}},[b,n]),t.useEffect(()=>{const e=setInterval(()=>{l(!1),C()},1e4);return()=>{clearInterval(e)}},[]);const J=e=>{u(e),n&&x(!0)},K=()=>{x(!1),u(null)},V=t.useCallback(e=>{p(a=>a.map(s=>s.complaintId===d?{...s,complaintStatus:e}:s))},[d]),X=t.useCallback(()=>{l(!1),C()},[l,C]),Y=e=>{Z(e),e&&e!==f&&u(null)},W=e=>{$(a=>({...a,...e})),g(1),p([])},M=n?{filter:"0%",list:"100%",conversation:"100%"}:P?{filter:"0%",list:"40%",conversation:"60%"}:{filter:"20%",list:"30%",conversation:"50%"};return o.jsx(se,{title:"Complaint Chats",children:o.jsxs(c,{sx:{display:"flex",height:"calc(100vh - 140px)",gap:2,overflow:"hidden"},children:[!n&&!P&&o.jsx(c,{sx:{width:M.filter,display:"flex",flexDirection:"column",overflow:"hidden"},children:o.jsx(ae,{filters:h,onFilterChange:W,statistics:L})}),(!n||!R)&&o.jsx(c,{sx:{width:M.list,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:T&&!E?o.jsx(ne,{error:T,onRetry:()=>l(!0),variant:"centered"}):o.jsx(oe,{chats:U,selectedChatId:d,onChatSelect:J,searchTerm:f,onSearchChange:Y,filters:h,onFilterChange:W,statistics:L,loading:E,currentPage:v,totalPages:A,onPageChange:H,totalChats:O})}),(!n||R)&&o.jsx(c,{sx:{width:M.conversation,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:o.jsx(ie,{complaintId:d,onClose:n?K:void 0,onMessagesRead:X,onStatusUpdate:V})})]})})};export{be as default};
