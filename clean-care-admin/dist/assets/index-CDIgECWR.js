import{u as te,o as U,j as o,B as c}from"./mui-vendor-DhgYLev2.js";import{i as se,d as ae,r as t}from"./react-vendor-D7yrL1sD.js";import{z as E,t as Z,M as oe}from"./index-pueUXdzt.js";import{b as h,C as ie}from"./browserNotifications-BvguxRB7.js";import{C as re}from"./ChatListPanel-C9pRoFHR.js";import{C as ne}from"./ChatConversationPanel-BVEb5cBB.js";import{E as le}from"./ErrorDisplay-dEZLAl9O.js";import"./query-vendor-dIV3S2E5.js";import"./chart-vendor-Byzruw8x.js";import"./useDebounce-CcxK0pTh.js";import"./dateUtils-C0RMjwBf.js";const Se=()=>{const{complaintId:S}=se(),P=ae(),j=te(),r=U(j.breakpoints.down("md")),T=U(j.breakpoints.between("md","lg")),[$,m]=t.useState([]),[u,p]=t.useState(null),[g,L]=t.useState(!0),[F,R]=t.useState(null),[x,A]=t.useState(""),[f,q]=t.useState({district:void 0,upazila:void 0,ward:void 0,zone:void 0,cityCorporationCode:void 0,thanaId:void 0,status:void 0,unreadOnly:!1,page:1,limit:20}),[C,M]=t.useState(1),[y,H]=t.useState(!0),[O,Q]=t.useState(0),[z,G]=t.useState({totalChats:0,unreadCount:0,byDistrict:[],byUpazila:[],byWard:[],byZone:[],byStatus:[]}),[W,b]=t.useState(!1),I=t.useRef([]),N=t.useRef(!0);t.useEffect(()=>{if(h.isSupported()&&h.getPermissionStatus()==="default"){const e=setTimeout(()=>{h.requestPermission().then(i=>{i&&console.log("Browser notification permission granted")})},2e3);return()=>clearTimeout(e)}},[]);const k=t.useCallback(e=>{const i=e.citizen.firstName+" "+e.citizen.lastName,s=e.lastMessage.text.length>50?e.lastMessage.text.substring(0,50)+"...":e.lastMessage.text,a=()=>{P(`/complaint-chats/${e.complaintId}`),p(e.complaintId),r&&b(!0)};E(l=>o.jsxs(c,{onClick:()=>{E.dismiss(l.id),a()},sx:{cursor:"pointer","&:hover":{opacity:.9}},children:[o.jsxs(c,{sx:{fontWeight:600,mb:.5,color:"#3FA564"},children:["New message from ",i]}),o.jsx(c,{sx:{fontSize:"0.875rem",color:"#666"},children:s}),o.jsxs(c,{sx:{fontSize:"0.75rem",color:"#999",mt:.5},children:["Complaint #",e.trackingNumber]})]}),{duration:6e3,icon:"ðŸ’¬",style:{background:"#fff",color:"#333",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",borderLeft:"4px solid #3FA564",padding:"16px",maxWidth:"400px"}}),h.hasPermission()&&!document.hasFocus()&&h.showNewMessageNotification(i,`${s}

Complaint #${e.trackingNumber}`,e.complaintId,e.trackingNumber,a)},[P,r]),D=t.useCallback(e=>{if(N.current){N.current=!1,I.current=e;return}const i=I.current;e.forEach(s=>{const a=i.find(l=>l.complaintId===s.complaintId);a?s.lastMessage&&a.lastMessage&&s.lastMessage.id!==a.lastMessage.id&&s.lastMessage.senderType==="CITIZEN"&&s.complaintId!==u&&k(s):s.lastMessage&&s.lastMessage.senderType==="CITIZEN"&&k(s)}),I.current=e},[u,k]),n=t.useCallback(async(e=!1,i,s=!1)=>{try{s||L(!0),R(null);const a=i||C,l={...f,search:x||void 0,page:a,limit:20},d=await Z.getChatConversationsWithPagination(l);a===1&&!s&&D(d.chats),m(s?ee=>[...ee,...d.chats]:d.chats),d.pagination&&(M(d.pagination.page),Q(d.pagination.total),H(d.pagination.hasNextPage))}catch(a){const l=a instanceof Error?a.message:"Failed to load chats";R(l),console.error("Error fetching chat list:",a),e&&E.error("Failed to load chats. Please check your connection.",{icon:"âŒ",duration:4e3})}finally{L(!1)}},[f,x,D,C]),J=t.useCallback(()=>{if(y&&!g){const e=C+1;M(e),n(!1,e,!0)}},[y,g,C,n]),v=t.useCallback(async()=>{try{const e=await Z.getChatStatistics();G(e)}catch(e){console.error("Error fetching statistics:",e)}},[]);t.useEffect(()=>{n(!0),v()},[]),t.useEffect(()=>{if(N.current)return;const e=setTimeout(()=>{n(!1)},500);return()=>clearTimeout(e)},[f,x]),t.useEffect(()=>{if(S){const e=parseInt(S,10);isNaN(e)||(p(e),r&&b(!0))}},[S,r]),t.useEffect(()=>{const e=setInterval(()=>{n(!1),v()},1e4);return()=>{clearInterval(e)}},[]);const K=e=>{p(e),r&&b(!0)},V=()=>{b(!1),p(null)},X=t.useCallback(e=>{m(i=>i.map(s=>s.complaintId===u?{...s,complaintStatus:e}:s))},[u]),Y=t.useCallback(()=>{n(!1),v()},[n,v]),_=e=>{A(e)},B=e=>{q(i=>({...i,...e})),M(1),m([])},w=r?{filter:"0%",list:"100%",conversation:"100%"}:T?{filter:"0%",list:"40%",conversation:"60%"}:{filter:"20%",list:"30%",conversation:"50%"};return o.jsx(oe,{title:"Complaint Chats",children:o.jsxs(c,{sx:{display:"flex",height:"calc(100vh - 140px)",gap:2,overflow:"hidden"},children:[!r&&!T&&o.jsx(c,{sx:{width:w.filter,display:"flex",flexDirection:"column",overflow:"hidden"},children:o.jsx(ie,{filters:f,onFilterChange:B,statistics:z})}),(!r||!W)&&o.jsx(c,{sx:{width:w.list,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:F&&!g?o.jsx(le,{error:F,onRetry:()=>n(!0),variant:"centered"}):o.jsx(re,{chats:$,selectedChatId:u,onChatSelect:K,searchTerm:x,onSearchChange:_,filters:f,onFilterChange:B,statistics:z,loading:g,hasMore:y,onLoadMore:J,totalChats:O})}),(!r||W)&&o.jsx(c,{sx:{width:w.conversation,display:"flex",flexDirection:"column",bgcolor:"background.paper",borderRadius:2,boxShadow:1,overflow:"hidden"},children:o.jsx(ne,{complaintId:u,onClose:r?V:void 0,onMessagesRead:Y,onStatusUpdate:X})})]})})};export{Se as default};
