var z=Object.defineProperty;var W=(h,e,a)=>e in h?z(h,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):h[e]=a;var b=(h,e,a)=>W(h,typeof e!="symbol"?e+"":e,a);import{a as g}from"./query-vendor-7qIgur5f.js";import{A as m}from"./index-BayLrfHP.js";import{u as K,p as q,j as o,t as G,v as H,T as f,i as D,w as N,x as J,aN as w,$ as v,aw as _,a0 as L,a2 as P,B as A,bJ as F,g as X,b as T,y as Z}from"./mui-vendor-BGNnUP5W.js";import{r as E}from"./react-vendor-D7yrL1sD.js";class Q{constructor(){b(this,"apiClient");this.apiClient=g.create({baseURL:m.BASE_URL,timeout:m.TIMEOUT,withCredentials:!0,headers:{"Content-Type":"application/json"}}),this.setupInterceptors()}setupInterceptors(){this.apiClient.interceptors.request.use(e=>{try{const a=localStorage.getItem("accessToken");a&&(e.headers.Authorization=`Bearer ${a}`)}catch(a){console.error("Error getting token:",a)}return e},e=>Promise.reject(e)),this.apiClient.interceptors.response.use(e=>e,e=>{var a;return((a=e.response)==null?void 0:a.status)===401&&window.location.pathname!=="/login"&&window.location.assign("/login"),Promise.reject(this.handleError(e))})}handleError(e){var a,t,r,s,i;if(g.isAxiosError(e)){const c=((a=e.response)==null?void 0:a.status)||500,l=((r=(t=e.response)==null?void 0:t.data)==null?void 0:r.message)||"An error occurred",x=(i=(s=e.response)==null?void 0:s.data)==null?void 0:i.errors;return{name:"ApiError",statusCode:c,message:l,errors:x}}return{name:"ApiError",statusCode:500,message:e.message||"An unexpected error occurred"}}isCloudinaryUrl(e){return!!e&&e.includes("res.cloudinary.com")&&e.includes("/upload/")}fixLocalMediaUrl(e){if(!e||this.isCloudinaryUrl(e)||e.startsWith(m.BASE_URL))return e;const a=/^https?:\/\/[^\/]+/;return a.test(e)?e.replace(a,m.BASE_URL):e.startsWith("/")?`${m.BASE_URL}${e}`:`${m.BASE_URL}/${e}`}getCloudinaryThumbnail(e,a=200,t=200){return e&&(this.isCloudinaryUrl(e)?e.replace("/upload/",`/upload/w_${a},h_${t},c_fill,q_auto,f_auto/`):e)}getOptimizedCloudinaryUrl(e){return e&&(this.isCloudinaryUrl(e)?e.replace("/upload/","/upload/q_auto,f_auto/"):e)}parseMediaUrls(e){let a=[],t=[];try{if(e.imageUrl){let r;const s=e.imageUrl;if(typeof s=="string"&&s.trim().startsWith("["))try{r=JSON.parse(s)}catch{r=[s]}else Array.isArray(s)?r=s:r=[s];Array.isArray(r)&&(a=r.map(i=>this.fixLocalMediaUrl(i)))}}catch(r){console.error("Error processing imageUrl:",r)}try{if(e.audioUrl){let r;const s=e.audioUrl;if(typeof s=="string"&&s.trim().startsWith("["))try{r=JSON.parse(s)}catch{r=[s]}else Array.isArray(s)?r=s:r=[s];Array.isArray(r)&&(t=r.map(i=>this.fixLocalMediaUrl(i)))}}catch(r){console.error("Error processing audioUrl:",r)}return{...e,imageUrls:a,audioUrls:t}}async getComplaints(e=1,a=20,t){try{const r={page:e,limit:a};t&&(t.search&&(r.search=t.search),t.status&&t.status!=="ALL"&&(r.status=t.status),t.category==="uncategorized"?r.category="null":t.category&&(r.category=t.category),t.subcategory&&(r.subcategory=t.subcategory),t.complaintCityCorporationCode&&(r.complaintCityCorporationCode=t.complaintCityCorporationCode),t.complaintZoneId&&(r.complaintZoneId=t.complaintZoneId),t.complaintWardId&&(r.complaintWardId=t.complaintWardId),t.cityCorporationCode&&(r.cityCorporationCode=t.cityCorporationCode),t.zoneId&&(r.zoneId=t.zoneId),t.wardId&&(r.wardId=t.wardId),t.ward&&(r.ward=t.ward),t.thanaId&&(r.thanaId=t.thanaId),t.startDate&&(r.startDate=t.startDate),t.endDate&&(r.endDate=t.endDate),t.sortBy&&(r.sortBy=t.sortBy),t.sortOrder&&(r.sortOrder=t.sortOrder));const s=await this.apiClient.get("/api/admin/complaints",{params:r});if(!s.data||!s.data.data)throw console.error("Invalid response structure:",s.data),new Error("Invalid response structure from server");const i=s.data.data;if(!Array.isArray(i.complaints))throw console.error("Complaints is not an array:",i),new Error("Invalid complaints data from server");const c=i.complaints.map(l=>this.parseMediaUrls(l));return{...i,complaints:c}}catch(r){throw console.error("Error in getComplaints:",r),r}}async getComplaintById(e){try{const a=await this.apiClient.get(`/api/admin/complaints/${e}`);return this.parseMediaUrls(a.data.data.complaint)}catch(a){throw a}}async updateComplaintStatus(e,a){try{if(a.resolutionImageFiles&&a.resolutionImageFiles.length>0){const t=new FormData;t.append("status",a.status),a.note&&t.append("note",a.note),a.resolutionImages&&t.append("resolutionImages",a.resolutionImages),a.resolutionNote&&t.append("resolutionNote",a.resolutionNote),a.category&&t.append("category",a.category),a.subcategory&&t.append("subcategory",a.subcategory),a.resolutionImageFiles.forEach(s=>{t.append("resolutionImages",s)});const r=await this.apiClient.patch(`/api/admin/complaints/${e}/status`,t,{headers:{"Content-Type":"multipart/form-data"}});return this.parseMediaUrls(r.data.data.complaint)}else{const t=await this.apiClient.patch(`/api/admin/complaints/${e}/status`,a);return this.parseMediaUrls(t.data.data.complaint)}}catch(t){throw t}}async markComplaintAsOthers(e,a){try{const t=new FormData;t.append("othersCategory",a.othersCategory),t.append("othersSubcategory",a.othersSubcategory),a.note&&t.append("note",a.note),a.images&&a.images.length>0&&a.images.forEach(i=>{t.append("images",i)});const r=await this.apiClient.patch(`/api/admin/complaints/${e}/mark-others`,t,{headers:{"Content-Type":"multipart/form-data"}});return this.parseMediaUrls(r.data.data.complaint)}catch(t){throw t}}async updateComplaintStatusWithResolution(e,a,t,r){try{const s=new FormData;s.append("status",a),t&&s.append("resolutionNote",t),r&&r.length>0&&r.forEach(l=>{s.append("resolutionImages",l)});const i=await this.apiClient.patch(`/api/admin/complaints/${e}/status`,s,{headers:{"Content-Type":"multipart/form-data"}});return this.parseMediaUrls(i.data.data.complaint)}catch(s){throw s}}async searchComplaints(e,a=1,t=20){try{return await this.getComplaints(a,t,{search:e})}catch(r){throw r}}async getComplaintsByUser(e,a=1,t=20){try{const r=await this.apiClient.get(`/api/admin/users/${e}/complaints`,{params:{page:a,limit:t}}),s=r.data.data.complaints.map(i=>this.parseMediaUrls(i));return{...r.data.data,complaints:s}}catch(r){throw r}}getThumbnailUrl(e,a=200,t=200){return this.getCloudinaryThumbnail(e,a,t)}getOptimizedUrl(e){return this.getOptimizedCloudinaryUrl(e)}async uploadImage(e){try{const a=new FormData;a.append("images",e);const t=await this.apiClient.post("/api/uploads",a,{headers:{"Content-Type":"multipart/form-data"}});if(t.data.success&&t.data.data.fileUrls.length>0)return t.data.data.fileUrls[0];throw new Error("Failed to upload image")}catch(a){throw console.error("Error uploading image:",a),a}}async getOthersAnalytics(e={}){try{const a={};return e.cityCorporationCode&&(a.cityCorporationCode=e.cityCorporationCode),e.zoneId!==void 0&&(a.zoneId=e.zoneId),e.startDate&&(a.startDate=e.startDate),e.endDate&&(a.endDate=e.endDate),(await this.apiClient.get("/api/admin/complaints/analytics/others",{params:a})).data.data}catch(a){throw console.error("Error fetching Others analytics:",a),a}}async updateComplaintAudioUrls(e,a){try{const t=await this.apiClient.patch(`/api/admin/complaints/${e}/audio-urls`,{audioUrls:a});return this.parseMediaUrls(t.data.data.complaint)}catch(t){throw t}}}const oe=new Q,R={CORPORATION_INTERNAL:{label:"Corporation Internal",description:"Issues within city corporation jurisdiction handled by specific departments"},CORPORATION_EXTERNAL:{label:"Corporation External",description:"Issues outside city corporation jurisdiction handled by external agencies"}},V={CORPORATION_INTERNAL:["Engineering","Electricity","Health","Property (Eviction)"],CORPORATION_EXTERNAL:["WASA","Titas","DPDC","DESCO","BTCL","Fire Service","Others"]},ie=({open:h,onClose:e,onConfirm:a,loading:t=!1})=>{const r=K(),s=q(r.breakpoints.down("sm")),[i,c]=E.useState(""),[l,x]=E.useState(""),[p,U]=E.useState(""),[y,I]=E.useState([]),[d,u]=E.useState({category:!1,subCategory:!1,note:!1}),M=n=>{c(n),x(""),u({...d,category:!0,subCategory:!1})},$=n=>{if(n.target.files){const C=Array.from(n.target.files),j=[...y,...C].slice(0,5);I(j)}},k=n=>{I(y.filter((C,j)=>j!==n))},B=()=>{if(!i){u({...d,category:!0});return}if(!l){u({...d,subCategory:!0});return}if(!p||p.length<20){u({...d,note:!0});return}a(i,l,p,y)},O=()=>{t||(c(""),x(""),U(""),I([]),u({category:!1,subCategory:!1,note:!1}),e())},S=i?V[i]||[]:[];return o.jsxs(G,{open:h,onClose:O,maxWidth:"sm",fullWidth:!0,fullScreen:s,PaperProps:{sx:{borderRadius:s?0:2}},children:[o.jsxs(H,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pb:2,borderBottom:"1px solid #e0e0e0"},children:[o.jsx(f,{variant:"h6",sx:{fontWeight:600},children:"Mark as Others"}),o.jsx(D,{onClick:O,disabled:t,size:"small",sx:{color:"text.secondary","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.04)"}},children:o.jsx(N,{})})]}),o.jsx(J,{sx:{pt:3,pb:2},children:o.jsxs(w,{container:!0,spacing:3,children:[o.jsx(w,{size:12,children:o.jsxs(v,{fullWidth:!0,error:d.category&&!i,required:!0,children:[o.jsx(_,{children:"Select Category"}),o.jsx(L,{value:i,label:"Select Category",onChange:n=>M(n.target.value),disabled:t,children:Object.keys(R).map(n=>o.jsx(P,{value:n,children:o.jsxs(A,{children:[o.jsx(f,{variant:"body1",children:R[n].label}),o.jsx(f,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:R[n].description})]})},n))}),d.category&&!i&&o.jsx(F,{children:"Please select a category"})]})}),i&&S.length>0&&o.jsx(w,{size:12,children:o.jsxs(v,{fullWidth:!0,error:d.subCategory&&!l,required:!0,children:[o.jsx(_,{children:"Select Department/Agency"}),o.jsx(L,{value:l,label:"Select Department/Agency",onChange:n=>{x(n.target.value),u({...d,subCategory:!0})},disabled:t,children:S.map(n=>o.jsx(P,{value:n,children:n},n))}),d.subCategory&&!l&&o.jsx(F,{children:"Please select a department/agency"})]})}),o.jsx(w,{size:12,children:o.jsx(X,{fullWidth:!0,label:"Note (Required)",required:!0,multiline:!0,rows:3,value:p,onChange:n=>{U(n.target.value),n.target.value.length>=20&&u({...d,note:!1})},onBlur:()=>u({...d,note:!0}),disabled:t,placeholder:"Add reason for marking as Others (min 20 characters)...",helperText:d.note&&(!p||p.length<20)?`Minimum 20 characters required (${p.length}/20)`:`${p.length}/500 characters`,error:d.note&&(!p||p.length<20),inputProps:{maxLength:500}})}),o.jsxs(w,{size:12,children:[o.jsxs(A,{sx:{mb:1},children:[o.jsx(f,{variant:"subtitle2",sx:{mb:.5},children:"Attach Images (Optional)"}),o.jsx(f,{variant:"caption",color:"text.secondary",children:"Max 5 images. Supported formats: JPEG, PNG, WebP."})]}),o.jsx("input",{accept:"image/jpeg,image/png,image/webp",style:{display:"none"},id:"mark-others-image-upload",multiple:!0,type:"file",onChange:$,disabled:t||y.length>=5}),o.jsx("label",{htmlFor:"mark-others-image-upload",children:o.jsx(T,{variant:"outlined",component:"span",disabled:t||y.length>=5,sx:{mb:2},children:"Upload Images"})}),y.length>0&&o.jsx(A,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:y.map((n,C)=>o.jsxs(A,{sx:{position:"relative",width:80,height:80,border:"1px solid #e0e0e0",borderRadius:1,overflow:"hidden"},children:[o.jsx("img",{src:URL.createObjectURL(n),alt:`Preview ${C}`,style:{width:"100%",height:"100%",objectFit:"cover"}}),o.jsx(D,{size:"small",onClick:()=>k(C),sx:{position:"absolute",top:2,right:2,bgcolor:"rgba(255,255,255,0.8)",p:.5,"&:hover":{bgcolor:"white"}},children:o.jsx(N,{sx:{fontSize:16}})})]},C))})]}),i&&o.jsx(w,{size:12,children:o.jsx(A,{sx:{p:2,bgcolor:"info.lighter",borderRadius:1,border:"1px solid",borderColor:"info.light"},children:o.jsxs(f,{variant:"body2",color:"info.dark",children:[o.jsx("strong",{children:"Note:"}),' This complaint will be marked as "Others" and categorized under'," ",o.jsx("strong",{children:i==="CORPORATION_INTERNAL"?"Corporation Internal":"Corporation External"}),l&&o.jsxs(o.Fragment,{children:[" - ",o.jsx("strong",{children:l})]}),". The user will be notified of this status change."]})})})]})}),o.jsxs(Z,{sx:{borderTop:"1px solid #e0e0e0",px:3,py:2,gap:1.5,flexDirection:{xs:"column-reverse",sm:"row"},"& > button":{width:{xs:"100%",sm:"auto"},minHeight:{xs:48,sm:36}}},children:[o.jsx(T,{onClick:O,disabled:t,color:"inherit",variant:"outlined",children:"Cancel"}),o.jsx(T,{onClick:B,variant:"contained",color:"primary",disabled:t||!i||!l||!p||p.length<20,children:t?"Marking...":"Mark as Others"})]})]})};class Y{constructor(){b(this,"apiClient");b(this,"cache");b(this,"CACHE_DURATION",30*60*1e3);this.apiClient=g.create({baseURL:m.BASE_URL,timeout:m.TIMEOUT,withCredentials:!0,headers:{"Content-Type":"application/json"}}),this.cache=new Map,this.setupInterceptors()}setupInterceptors(){this.apiClient.interceptors.request.use(e=>{try{const a=localStorage.getItem("accessToken");a&&(e.headers.Authorization=`Bearer ${a}`)}catch(a){console.error("Error getting token:",a)}return e},e=>Promise.reject(e)),this.apiClient.interceptors.response.use(e=>e,e=>{var a;return((a=e.response)==null?void 0:a.status)===401&&window.location.pathname!=="/login"&&window.location.assign("/login"),Promise.reject(e)})}getCacheKey(e,a){const t=a?JSON.stringify(a):"";return`${e}:${t}`}getCachedData(e){const a=this.cache.get(e);if(a){if(Date.now()-a.timestamp<this.CACHE_DURATION)return a.data;this.cache.delete(e)}return null}setCachedData(e,a){this.cache.set(e,{data:a,timestamp:Date.now()})}clearCache(){this.cache.clear()}async getAllCategories(){var e,a;try{const t=this.getCacheKey("categories"),r=this.getCachedData(t);if(r)return r;const i=(await this.apiClient.get("/api/categories")).data.data.categories;return this.setCachedData(t,i),i}catch(t){throw g.isAxiosError(t)?new Error(((a=(e=t.response)==null?void 0:e.data)==null?void 0:a.message)||"Failed to fetch categories"):t}}async getCategoryById(e){var a,t;try{const r=this.getCacheKey(`category-${e}`),s=this.getCachedData(r);if(s)return s;const c=(await this.apiClient.get(`/api/categories/${e}`)).data.data.category;return this.setCachedData(r,c),c}catch(r){throw g.isAxiosError(r)?new Error(((t=(a=r.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to fetch category"):r}}async getSubcategories(e){var a,t;try{const r=this.getCacheKey(`subcategories-${e}`),s=this.getCachedData(r);if(s)return s;const c=(await this.apiClient.get(`/api/categories/${e}/subcategories`)).data.data.subcategories;return this.setCachedData(r,c),c}catch(r){throw g.isAxiosError(r)?new Error(((t=(a=r.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to fetch subcategories"):r}}async getCategoryStatistics(e){var a,t;try{const r=this.getCacheKey("category-statistics",e),s=this.cache.get(r);if(s&&Date.now()-s.timestamp<5*60*1e3)return s.data;const c=(await this.apiClient.get("/api/admin/analytics/categories",{params:e})).data.data;return this.setCachedData(r,c),c}catch(r){throw g.isAxiosError(r)?new Error(((t=(a=r.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to fetch category statistics"):r}}async getCategoryTrends(e){var a,t;try{const r=this.getCacheKey("category-trends",e),s=this.cache.get(r);if(s&&Date.now()-s.timestamp<5*60*1e3)return s.data;const c=(await this.apiClient.get("/api/admin/analytics/categories/trends",{params:e})).data.data;return this.setCachedData(r,c),c}catch(r){throw g.isAxiosError(r)?new Error(((t=(a=r.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to fetch category trends"):r}}async getCategoryName(e,a="en"){if(e==="CORPORATION_INTERNAL")return a==="bn"?"কর্পোরেশন (অভ্যন্তরীণ)":"Corporation (Internal)";if(e==="CORPORATION_EXTERNAL")return a==="bn"?"কর্পোরেশন (বাহ্যিক)":"Corporation (External)";const r=(await this.getAllCategories()).find(s=>s.id===e);return r?a==="bn"?r.bangla:r.english:"Unknown Category"}async getSubcategoryName(e,a,t="en"){if(e==="CORPORATION_INTERNAL"||e==="CORPORATION_EXTERNAL")return a.replace(/_/g," ").replace(/\b\w/g,i=>i.toUpperCase());const s=(await this.getCategoryById(e)).subcategories.find(i=>i.id===a);return s?t==="bn"?s.bangla:s.english:"Unknown Subcategory"}async getCategoryColor(e){if(e==="CORPORATION_INTERNAL")return"#9333ea";if(e==="CORPORATION_EXTERNAL")return"#ea580c";const t=(await this.getAllCategories()).find(r=>r.id===e);return(t==null?void 0:t.color)||"#808080"}async categoryExists(e){try{return await this.getCategoryById(e),!0}catch{return!1}}async subcategoryExists(e,a){try{return(await this.getSubcategories(e)).some(r=>r.id===a)}catch{return!1}}}const ne=new Y;export{ie as M,oe as a,ne as c};
